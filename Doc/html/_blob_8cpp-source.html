<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>New Vision: F:/My Documents/Visual Studio 2005/Projects/NewVision/NewVision/Blob.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.1-p1 -->
<div class="tabs">
  <ul>
    <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="namespaces.html"><span>Namespaces</span></a></li>
    <li><a href="annotated.html"><span>Classes</span></a></li>
    <li id="current"><a href="files.html"><span>Files</span></a></li>
    <li>
      <form action="search.php" method="get">
        <table cellspacing="0" cellpadding="0" border="0">
          <tr>
            <td><label>&nbsp;<u>S</u>earch&nbsp;for&nbsp;</label></td>
            <td><input type="text" name="query" value="" size="20" accesskey="s"/></td>
          </tr>
        </table>
      </form>
    </li>
  </ul></div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
  </ul></div>
<h1>F:/My Documents/Visual Studio 2005/Projects/NewVision/NewVision/Blob.cpp</h1><a href="_blob_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor">#include "<a class="code" href="_std_afx_8h.html">StdAfx.h</a>"</span>
<a name="l00002"></a>00002 <span class="preprocessor">#include "<a class="code" href="_new_vision_8h.html">NewVision.h</a>"</span>
<a name="l00003"></a>00003 <span class="preprocessor">#include "<a class="code" href="_blob_8h.html">blob.h</a>"</span>
<a name="l00004"></a>00004 <span class="preprocessor">#include "math.h"</span>
<a name="l00005"></a>00005 <span class="preprocessor">#include "<a class="code" href="_globals_8h.html">Globals.h</a>"</span>
<a name="l00006"></a>00006 <span class="preprocessor">#include "<a class="code" href="_new_vision_doc_8h.html">NewVisionDoc.h</a>"</span>
<a name="l00007"></a>00007 <span class="comment">// ----------------------------------------------------------</span>
<a name="l00008"></a><a class="code" href="class_blob.html#7c371bf23c904c9752629fe48d8085f3">00008</a> <a class="code" href="class_blob.html#7c371bf23c904c9752629fe48d8085f3">Blob::Blob</a>(<span class="keywordtype">void</span>) {
<a name="l00009"></a>00009 }
<a name="l00010"></a>00010 <span class="comment">// ----------------------------------------------------------</span>
<a name="l00011"></a><a class="code" href="class_blob.html#a6aafc151e88a8b99ad4a01df1f4b1a1">00011</a> <a class="code" href="class_blob.html#a6aafc151e88a8b99ad4a01df1f4b1a1">Blob::~Blob</a>() {
<a name="l00012"></a>00012         
<a name="l00013"></a>00013 }
<a name="l00014"></a>00014 <span class="comment">// ----------------------------------------------------------</span>
<a name="l00015"></a><a class="code" href="class_blob.html#5bffb4541d604007c307e20d1aba47c7">00015</a> <a class="code" href="class_blob.html#7c371bf23c904c9752629fe48d8085f3">Blob::Blob</a>(CvSeq* c, <a class="code" href="class_c_new_vision_doc.html">CNewVisionDoc</a>* doc) {
<a name="l00016"></a>00016         this-&gt;<a class="code" href="class_blob.html#c38d4cfdf23ea98267055cf91f10ea1b">doc</a> = <a class="code" href="class_blob.html#c38d4cfdf23ea98267055cf91f10ea1b">doc</a>;
<a name="l00017"></a>00017         <span class="comment">// initialize contour           </span>
<a name="l00018"></a>00018         <a class="code" href="class_blob.html#a112954533edaa0a61f2cff337565dcb">contour</a> = <a class="code" href="class_blob.html#b311dff0243fe4e073f5d2ba93c6bece">copyContour</a>(c);
<a name="l00019"></a>00019         
<a name="l00020"></a>00020         <span class="comment">// initialize position (center of mass)</span>
<a name="l00021"></a>00021         <a class="code" href="class_blob.html#f1724b54cffb513be6c0474208d35caf">initPos</a>();
<a name="l00022"></a>00022 
<a name="l00023"></a>00023         <span class="comment">// initialize size </span>
<a name="l00024"></a>00024         <a class="code" href="class_blob.html#693ea867bcaea66f6c20a65a1b55de71">initSize</a>();
<a name="l00025"></a>00025 
<a name="l00026"></a>00026         <span class="comment">// initialize head candidates</span>
<a name="l00027"></a>00027         <a class="code" href="class_blob.html#2e05a2604e83d5ddda1bb7e682183217">InitHeadCandidates</a>();
<a name="l00028"></a>00028 
<a name="l00029"></a>00029 }
<a name="l00030"></a>00030 <span class="comment">// ----------------------------------------------------------</span>
<a name="l00031"></a><a class="code" href="class_blob.html#289e4bb89d53f3530c4b4a2f2e38c2e9">00031</a> <span class="keywordtype">void</span> <a class="code" href="class_blob.html#289e4bb89d53f3530c4b4a2f2e38c2e9">Blob::merge</a>(<a class="code" href="class_blob.html">Blob</a>* that) {
<a name="l00032"></a>00032         <span class="comment">// reinitialize contour         </span>
<a name="l00033"></a>00033         <a class="code" href="class_blob.html#ece6809b0b830973c0db6b818154aabc">appendContour</a>(that-&gt;<a class="code" href="class_blob.html#a112954533edaa0a61f2cff337565dcb">contour</a>);
<a name="l00034"></a>00034         <span class="comment">// reinitialize position (center of mass)</span>
<a name="l00035"></a>00035         <a class="code" href="class_blob.html#f1724b54cffb513be6c0474208d35caf">initPos</a>();
<a name="l00036"></a>00036         <span class="comment">// reinitialize size </span>
<a name="l00037"></a>00037         <a class="code" href="class_blob.html#693ea867bcaea66f6c20a65a1b55de71">initSize</a>();     
<a name="l00038"></a>00038 }
<a name="l00039"></a>00039 <span class="comment">// ----------------------------------------------------------</span>
<a name="l00040"></a>00040 <span class="comment">// create a copy of CvSeq POLYLINE contour (no holes)</span>
<a name="l00041"></a><a class="code" href="class_blob.html#b311dff0243fe4e073f5d2ba93c6bece">00041</a> CvSeq* <a class="code" href="class_blob.html#b311dff0243fe4e073f5d2ba93c6bece">Blob::copyContour</a>(CvSeq* c) {
<a name="l00042"></a>00042         CvSeq* <a class="code" href="class_blob.html#a112954533edaa0a61f2cff337565dcb">contour</a> = cvCreateSeq( c-&gt;flags, <span class="keyword">sizeof</span>(CvContour), <span class="keyword">sizeof</span>(CvPoint), <a class="code" href="_globals_8cpp.html#57efc8aa770b061bfa5f6ba9dc673ef3">OpenCVmemory</a>);
<a name="l00043"></a>00043 
<a name="l00044"></a>00044         <span class="keywordflow">if</span>( CV_IS_SEQ_POLYLINE( c ))
<a name="l00045"></a>00045     {
<a name="l00046"></a>00046                 <span class="keywordtype">int</span> i, count = c-&gt;total;
<a name="l00047"></a>00047                 CvSeqReader reader;
<a name="l00048"></a>00048                 CvSeqWriter writer;
<a name="l00049"></a>00049                 cvStartReadSeq(c, &amp;reader, 0);
<a name="l00050"></a>00050                 cvStartAppendToSeq(contour, &amp;writer);
<a name="l00051"></a>00051                 CvPoint pt;
<a name="l00052"></a>00052 
<a name="l00053"></a>00053         <span class="comment">/* scroll the reader by 1 point */</span>
<a name="l00054"></a>00054         <span class="keywordflow">for</span>( i = 0; i &lt; count; i++ )
<a name="l00055"></a>00055         {
<a name="l00056"></a>00056                         CV_READ_SEQ_ELEM( pt, reader );
<a name="l00057"></a>00057                         CV_WRITE_SEQ_ELEM( pt, writer );
<a name="l00058"></a>00058             }
<a name="l00059"></a>00059                 cvEndWriteSeq( &amp;writer );
<a name="l00060"></a>00060         }
<a name="l00061"></a>00061         <span class="keywordflow">return</span> contour;
<a name="l00062"></a>00062 }
<a name="l00063"></a>00063 <span class="comment">// ----------------------------------------------------------</span>
<a name="l00064"></a>00064 <span class="comment">// append CvSeq POLYLINE contour (no holes) to the existing contour</span>
<a name="l00065"></a><a class="code" href="class_blob.html#ece6809b0b830973c0db6b818154aabc">00065</a> <span class="keywordtype">void</span> <a class="code" href="class_blob.html#ece6809b0b830973c0db6b818154aabc">Blob::appendContour</a>(CvSeq* c) {
<a name="l00066"></a>00066         <span class="keywordflow">if</span>( CV_IS_SEQ_POLYLINE( c ))
<a name="l00067"></a>00067     {
<a name="l00068"></a>00068                 <span class="keywordtype">int</span> i, count = c-&gt;total;
<a name="l00069"></a>00069                 CvSeqReader reader;
<a name="l00070"></a>00070                 CvSeqWriter writer;
<a name="l00071"></a>00071                 cvStartReadSeq(c, &amp;reader, 0);
<a name="l00072"></a>00072                 cvStartAppendToSeq(<a class="code" href="class_blob.html#a112954533edaa0a61f2cff337565dcb">contour</a>, &amp;writer);
<a name="l00073"></a>00073                 CvPoint pt;
<a name="l00074"></a>00074 
<a name="l00075"></a>00075         <span class="comment">/* scroll the reader by 1 point */</span>
<a name="l00076"></a>00076         <span class="keywordflow">for</span>( i = 0; i &lt; count; i++ )
<a name="l00077"></a>00077         {
<a name="l00078"></a>00078                         CV_READ_SEQ_ELEM( pt, reader );
<a name="l00079"></a>00079                         CV_WRITE_SEQ_ELEM( pt, writer );
<a name="l00080"></a>00080             }
<a name="l00081"></a>00081                 cvEndWriteSeq( &amp;writer );
<a name="l00082"></a>00082         }
<a name="l00083"></a>00083 }
<a name="l00084"></a>00084 <span class="comment">// ----------------------------------------------------------</span>
<a name="l00085"></a><a class="code" href="class_blob.html#f1724b54cffb513be6c0474208d35caf">00085</a> <span class="keywordtype">void</span> <a class="code" href="class_blob.html#f1724b54cffb513be6c0474208d35caf">Blob::initPos</a>() {
<a name="l00086"></a>00086         CvMoments moments;
<a name="l00087"></a>00087         cvMoments(<a class="code" href="class_blob.html#a112954533edaa0a61f2cff337565dcb">contour</a>, &amp;moments);
<a name="l00088"></a>00088         <span class="keywordtype">double</span> M00,M01,M10;
<a name="l00089"></a>00089         <span class="keywordtype">double</span> x, y;
<a name="l00090"></a>00090         M00 = cvGetSpatialMoment( &amp;moments, 0, 0 );
<a name="l00091"></a>00091         M10 = cvGetSpatialMoment( &amp;moments, 1, 0 );
<a name="l00092"></a>00092         M01 = cvGetSpatialMoment( &amp;moments, 0, 1 );
<a name="l00093"></a>00093         x = M10/M00;
<a name="l00094"></a>00094         y = M01/M00;
<a name="l00095"></a>00095 <span class="preprocessor">        #pragma warning( disable : 4244 )</span>
<a name="l00096"></a>00096 <span class="preprocessor"></span>        <a class="code" href="class_blob.html#d549d993a7aad92f0cda7b3f4aba8231">pos</a> = <a class="code" href="_globals_8cpp.html#8dbc3855d325a7c853bb8fd1607622e4">cvPoint</a>(x, y);
<a name="l00097"></a>00097 <span class="preprocessor">        #pragma warning( default : 4244 )</span>
<a name="l00098"></a>00098 <span class="preprocessor"></span>}
<a name="l00099"></a>00099 <span class="comment">// ----------------------------------------------------------</span>
<a name="l00100"></a><a class="code" href="class_blob.html#693ea867bcaea66f6c20a65a1b55de71">00100</a> <span class="keywordtype">void</span> <a class="code" href="class_blob.html#693ea867bcaea66f6c20a65a1b55de71">Blob::initSize</a>() {
<a name="l00101"></a>00101         CvRect r = cvBoundingRect(<a class="code" href="class_blob.html#a112954533edaa0a61f2cff337565dcb">contour</a>, 1);
<a name="l00102"></a>00102         <a class="code" href="class_blob.html#544bd86e1b63f99eb9e5b21d66f25d39">size</a> = cvSize(r.width, r.height);
<a name="l00103"></a>00103 }
<a name="l00104"></a>00104 <span class="comment">// ----------------------------------------------------------</span>
<a name="l00105"></a><a class="code" href="class_blob.html#31ce2dadb8fe52d53d2598c223d26111">00105</a> CvSeq* <a class="code" href="class_blob.html#31ce2dadb8fe52d53d2598c223d26111">Blob::getContour</a>() {
<a name="l00106"></a>00106         <span class="keywordflow">return</span> <a class="code" href="class_blob.html#a112954533edaa0a61f2cff337565dcb">contour</a>;
<a name="l00107"></a>00107 }
<a name="l00108"></a>00108 
<a name="l00109"></a>00109 <span class="comment">// ----------------------------------------------------------</span>
<a name="l00110"></a><a class="code" href="class_blob.html#a1c12c54b093057831a4d8a9c3b8604d">00110</a> CvPoint <a class="code" href="class_blob.html#a1c12c54b093057831a4d8a9c3b8604d">Blob::getPos</a>() {
<a name="l00111"></a>00111         <span class="keywordflow">return</span> <a class="code" href="class_blob.html#d549d993a7aad92f0cda7b3f4aba8231">pos</a>;
<a name="l00112"></a>00112 }
<a name="l00113"></a>00113 <span class="comment">// ----------------------------------------------------------</span>
<a name="l00114"></a><a class="code" href="class_blob.html#8c44481033828179a56483d8b1c2da2c">00114</a> CvSize <a class="code" href="class_blob.html#8c44481033828179a56483d8b1c2da2c">Blob::getSize</a>() {
<a name="l00115"></a>00115         <span class="keywordflow">return</span> <a class="code" href="class_blob.html#544bd86e1b63f99eb9e5b21d66f25d39">size</a>;
<a name="l00116"></a>00116 }
<a name="l00117"></a>00117 <span class="comment">// ----------------------------------------------------------</span>
<a name="l00118"></a><a class="code" href="class_blob.html#f9a7ed1543787f21af17b9f2c0dc7b8a">00118</a> CvPoint <a class="code" href="class_blob.html#f9a7ed1543787f21af17b9f2c0dc7b8a">Blob::getVelocity</a>() {
<a name="l00119"></a>00119         <span class="keywordflow">return</span> <a class="code" href="class_blob.html#303c2773f5acb9fe1a889faf7f1245fb">velocity</a>;
<a name="l00120"></a>00120 }
<a name="l00121"></a>00121 <span class="comment">// ----------------------------------------------------------</span>
<a name="l00122"></a><a class="code" href="class_blob.html#b3f70d6644aa9d918a464c2085cac1a5">00122</a> <span class="keywordtype">double</span> <a class="code" href="class_blob.html#b3f70d6644aa9d918a464c2085cac1a5">Blob::distance</a>(<a class="code" href="class_blob.html">Blob</a>* that) {
<a name="l00123"></a>00123         <span class="keywordflow">return</span> <a class="code" href="_globals_8cpp.html#b724d6feae6649021bcf78a12f877673">d_contour2contour</a>(this-&gt;contour, that-&gt;<a class="code" href="class_blob.html#a112954533edaa0a61f2cff337565dcb">contour</a>);
<a name="l00124"></a>00124 }
<a name="l00125"></a>00125 <span class="comment">// ----------------------------------------------------------</span>
<a name="l00126"></a><a class="code" href="class_blob.html#07515f17458895b39d682a9de539a898">00126</a> <span class="keywordtype">int</span> <a class="code" href="class_blob.html#07515f17458895b39d682a9de539a898">Blob::numVertices</a>() {
<a name="l00127"></a>00127         <span class="keywordflow">return</span> <a class="code" href="class_blob.html#a112954533edaa0a61f2cff337565dcb">contour</a>-&gt;total;
<a name="l00128"></a>00128 }
<a name="l00129"></a>00129 <span class="comment">// ----------------------------------------------------------</span>
<a name="l00130"></a><a class="code" href="class_blob.html#3002c8a751c56e5dab21dc42ddbfaa2a">00130</a> <span class="keywordtype">void</span> <a class="code" href="class_blob.html#3002c8a751c56e5dab21dc42ddbfaa2a">Blob::getProjectionHistogram</a>(CvSeq* hist) {
<a name="l00131"></a>00131         <a class="code" href="class_camera_dialog.html">CameraDialog</a>* cm = &amp;<a class="code" href="class_blob.html#c38d4cfdf23ea98267055cf91f10ea1b">doc</a>-&gt;<a class="code" href="class_c_new_vision_doc.html#e21c04f1c508fb2ae7ac1fc9c433d854">cameramodel</a>;
<a name="l00132"></a>00132         <a class="code" href="class_blob_dialog.html">BlobDialog</a>*   bm = &amp;<a class="code" href="class_blob.html#c38d4cfdf23ea98267055cf91f10ea1b">doc</a>-&gt;<a class="code" href="class_c_new_vision_doc.html#b16361836a42ce1853622cd74d654d49">blobmodel</a>;
<a name="l00133"></a>00133         <span class="comment">// create a mask image</span>
<a name="l00134"></a>00134         cvZero(<a class="code" href="_globals_8cpp.html#4e26626ca1309461c668a7b28787dc5f">blob_mask</a>);
<a name="l00135"></a>00135         cvDrawContours(<a class="code" href="_globals_8cpp.html#4e26626ca1309461c668a7b28787dc5f">blob_mask</a> , <a class="code" href="class_blob.html#a112954533edaa0a61f2cff337565dcb">contour</a>, cvScalar(1), cvScalar(1), 0, CV_FILLED, 8);
<a name="l00136"></a>00136                         <span class="comment">// go through all the points on the contour</span>
<a name="l00137"></a>00137         CvSeqReader reader;
<a name="l00138"></a>00138         cvStartReadSeq(this-&gt;contour, &amp;reader, 0);
<a name="l00139"></a>00139         CvPoint pt;
<a name="l00140"></a>00140         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> n = 0; n &lt; this-&gt;<a class="code" href="class_blob.html#a112954533edaa0a61f2cff337565dcb">contour</a>-&gt;total; n++ ) {
<a name="l00141"></a>00141                 CV_READ_SEQ_ELEM( pt, reader);
<a name="l00142"></a>00142                 CvPoint ptVZ;
<a name="l00143"></a>00143                 <span class="keywordflow">switch</span> (cm-&gt;<a class="code" href="class_camera_model.html#4f880809688deb332b8f28ee9074fc58">m_cameraType</a>) {
<a name="l00144"></a>00144                         <span class="keywordflow">case</span> <a class="code" href="_camera_model_8h.html#e27786af5883fda851579f95897d5b80295dc00dd5da0bca4ed9f724c3cb3904">PROJECTION</a>: ptVZ = <a class="code" href="class_blob.html#5c4e5ae006472701c97cb94c253c72d9">intersectVZ2Contour</a>(pt); <span class="keywordflow">break</span>;
<a name="l00145"></a>00145                         <span class="keywordflow">case</span> <a class="code" href="_camera_model_8h.html#e27786af5883fda851579f95897d5b80e5031a2dca66aec4c071e90aa6bee1ff">SPHERICAL</a>:  ptVZ = <a class="code" href="_globals_8cpp.html#8dbc3855d325a7c853bb8fd1607622e4">cvPoint</a>(pt.x, cm-&gt;<a class="code" href="class_camera_model.html#d561ff14d4687d142757026dc0a4ff9a">h</a>-1);
<a name="l00146"></a>00146                 }
<a name="l00147"></a>00147                 CvLineIterator iterator;
<a name="l00148"></a>00148                 <span class="keywordtype">int</span> count = cvInitLineIterator(<a class="code" href="_globals_8cpp.html#4e26626ca1309461c668a7b28787dc5f">blob_mask</a>, pt, ptVZ, &amp;iterator, 8);
<a name="l00149"></a>00149                 <a class="code" href="struct_blob_ray.html">BlobRay</a> br;
<a name="l00150"></a>00150                 br.<a class="code" href="struct_blob_ray.html#25e5b527b01731792136988eef4406fb">p1</a> = pt;
<a name="l00151"></a>00151                 <span class="keywordtype">bool</span> under = <span class="keyword">false</span>; <span class="comment">// if the vertex is on the underside</span>
<a name="l00152"></a>00152                 <span class="keywordflow">for</span>( <span class="keywordtype">int</span> i = 0; i &lt; count; i++ ) {
<a name="l00153"></a>00153                         <span class="keywordflow">if</span> (iterator.ptr[0] ==  0 &amp;&amp; i &lt;= <a class="code" href="_blob_8h.html#cfe97931f09940e64a542766a9793372">MIN_PIX_TO_BE_OVER</a>) {
<a name="l00154"></a>00154                                 under = <span class="keyword">true</span>;
<a name="l00155"></a>00155                                 <span class="keywordflow">break</span>;
<a name="l00156"></a>00156                         }
<a name="l00157"></a>00157                         <span class="keywordflow">if</span> (iterator.ptr[0] != 0) { <span class="comment">// store x,y for the last non-empty point</span>
<a name="l00158"></a>00158                                 <span class="keywordtype">int</span> offset, x, y;
<a name="l00159"></a>00159                                 offset = (<span class="keywordtype">int</span>)(iterator.ptr - (uchar*)(<a class="code" href="_globals_8cpp.html#4e26626ca1309461c668a7b28787dc5f">blob_mask</a>-&gt;imageData));
<a name="l00160"></a>00160                                 y = offset/<a class="code" href="_globals_8cpp.html#4e26626ca1309461c668a7b28787dc5f">blob_mask</a> -&gt;widthStep;
<a name="l00161"></a>00161                                 x = (offset - y*<a class="code" href="_globals_8cpp.html#4e26626ca1309461c668a7b28787dc5f">blob_mask</a> -&gt;widthStep)/(<a class="code" href="_globals_8cpp.html#4e26626ca1309461c668a7b28787dc5f">blob_mask</a>-&gt;nChannels) ;
<a name="l00162"></a>00162                                 br.<a class="code" href="struct_blob_ray.html#3a9658af7b77117369ccd2e6c589e9a8">p2</a>.x = x;
<a name="l00163"></a>00163                                 br.<a class="code" href="struct_blob_ray.html#3a9658af7b77117369ccd2e6c589e9a8">p2</a>.y = y;
<a name="l00164"></a>00164                                 br.<a class="code" href="struct_blob_ray.html#8af202df26fcf36df78f8d088b745c57">count</a> += iterator.ptr[0]; <span class="comment">// +=1</span>
<a name="l00165"></a>00165                         }
<a name="l00166"></a>00166                         CV_NEXT_LINE_POINT(iterator);
<a name="l00167"></a>00167                 }
<a name="l00168"></a>00168                 <span class="keywordflow">if</span> (!under)
<a name="l00169"></a>00169                         cvSeqPush(hist, &amp;br);
<a name="l00170"></a>00170         }
<a name="l00171"></a>00171 }
<a name="l00172"></a>00172 <span class="comment">// ----------------------------------------------------------</span>
<a name="l00173"></a><a class="code" href="class_blob.html#5c4e5ae006472701c97cb94c253c72d9">00173</a> CvPoint <a class="code" href="class_blob.html#5c4e5ae006472701c97cb94c253c72d9">Blob::intersectVZ2Contour</a>(CvPoint pt) {
<a name="l00174"></a>00174         <a class="code" href="class_camera_dialog.html">CameraDialog</a>* cm = &amp;<a class="code" href="class_blob.html#c38d4cfdf23ea98267055cf91f10ea1b">doc</a>-&gt;<a class="code" href="class_c_new_vision_doc.html#e21c04f1c508fb2ae7ac1fc9c433d854">cameramodel</a>;
<a name="l00175"></a>00175         <span class="comment">// Find a point on the intersection of the image boundary </span>
<a name="l00176"></a>00176         <span class="comment">// and the ray, formed by vanishing point and point p (of the contour)</span>
<a name="l00177"></a>00177         <span class="keywordtype">int</span> w = cm-&gt;<a class="code" href="class_camera_model.html#24fc2915f3b445ea9cf592480b03b631">w</a>, h = cm-&gt;<a class="code" href="class_camera_model.html#d561ff14d4687d142757026dc0a4ff9a">h</a>;
<a name="l00178"></a>00178         <span class="keywordtype">double</span> _VZ[] = {0,0,1}, _p1[] = {0,0,1}, _p2[] = {0,0,1};
<a name="l00179"></a>00179         <span class="keywordtype">double</span> _PT[] = {pt.x-w/2,pt.y-h/2,(w+h)/4}, _line1[] = {0,0,1}, _line2[] = {0,0,1};
<a name="l00180"></a>00180         CvMat VZ, p1, p2, PT, line1, line2;
<a name="l00181"></a>00181         cvInitMatHeader( &amp;VZ, 3, 1, CV_64FC1, _VZ);
<a name="l00182"></a>00182         cvInitMatHeader( &amp;p1, 3, 1, CV_64FC1, _p1);
<a name="l00183"></a>00183         cvInitMatHeader( &amp;p2, 3, 1, CV_64FC1, _p2);
<a name="l00184"></a>00184         cvInitMatHeader( &amp;line1, 3, 1, CV_64FC1, _line1);
<a name="l00185"></a>00185         cvInitMatHeader( &amp;line2, 3, 1, CV_64FC1, _line2);
<a name="l00186"></a>00186         cvInitMatHeader( &amp;PT, 3, 1, CV_64FC1, _PT);
<a name="l00187"></a>00187         cvCopy(cm-&gt;<a class="code" href="class_camera_model.html#e84288c553968b8906c6d861eed797b8">VZ</a>, &amp;VZ);
<a name="l00188"></a>00188         CvPoint2D32f vz = cm-&gt;<a class="code" href="class_camera_model.html#5d0c9ba363f2443e5d53112ff35ff7eb">coordsHomo2Image</a>(cm-&gt;<a class="code" href="class_camera_model.html#e84288c553968b8906c6d861eed797b8">VZ</a>);
<a name="l00189"></a>00189         <span class="keywordflow">if</span> (vz.x &lt; 0 || vz.x &gt;= w/2) {
<a name="l00190"></a>00190                 <span class="keywordflow">if</span> (vz.x &lt; 0) {
<a name="l00191"></a>00191                         _p1[0] = -w/2; _p1[1] = -h/2; _p1[2] = (w+h)/4;
<a name="l00192"></a>00192                         _p2[0] = -w/2; _p2[1] = +h/2; _p2[2] = (w+h)/4;
<a name="l00193"></a>00193                 }
<a name="l00194"></a>00194                 <span class="keywordflow">else</span> {
<a name="l00195"></a>00195                         _p1[0] = w/2-1; _p1[1] = -h/2; _p1[2] = (w+h)/4;
<a name="l00196"></a>00196                         _p2[0] = w/2-1; _p2[1] = +h/2; _p2[2] = (w+h)/4;
<a name="l00197"></a>00197                 }
<a name="l00198"></a>00198                 cvCrossProduct(&amp;p1, &amp;p2, &amp;line1);
<a name="l00199"></a>00199                 cvCrossProduct(&amp;PT, &amp;VZ, &amp;line2);
<a name="l00200"></a>00200                 cvCrossProduct(&amp;line1, &amp;line2, &amp;p1);
<a name="l00201"></a>00201                 CvPoint res = cvPointFrom32f(cm-&gt;<a class="code" href="class_camera_model.html#5d0c9ba363f2443e5d53112ff35ff7eb">coordsHomo2Image</a>(&amp;p1));
<a name="l00202"></a>00202                 <span class="keywordflow">if</span> (res.x &lt; w &amp;&amp; res.x &gt;= 0 &amp;&amp; res.y &lt; h &amp;&amp; res.y &gt;= 0)
<a name="l00203"></a>00203                         <span class="keywordflow">return</span> res;
<a name="l00204"></a>00204         }
<a name="l00205"></a>00205         <span class="keywordflow">if</span> (vz.y &lt; 0 || vz.y &gt;= h/2) {
<a name="l00206"></a>00206                 <span class="keywordflow">if</span> (vz.y &lt; 0) {
<a name="l00207"></a>00207                         _p1[0] = -w/2; _p1[1] = -h/2; _p1[2] = (w+h)/4;
<a name="l00208"></a>00208                         _p2[0] = +w/2; _p2[1] = -h/2; _p2[2] = (w+h)/4;
<a name="l00209"></a>00209                 }
<a name="l00210"></a>00210                 <span class="keywordflow">else</span> {
<a name="l00211"></a>00211                         _p1[0] = -w/2; _p1[1] = +h/2-1; _p1[2] = (w+h)/4;
<a name="l00212"></a>00212                         _p2[0] = +w/2; _p2[1] = +h/2-1; _p2[2] = (w+h)/4;
<a name="l00213"></a>00213                 }
<a name="l00214"></a>00214                 cvCrossProduct(&amp;p1, &amp;p2, &amp;line1);
<a name="l00215"></a>00215                 cvCrossProduct(&amp;PT, &amp;VZ, &amp;line2);
<a name="l00216"></a>00216                 cvCrossProduct(&amp;line1, &amp;line2, &amp;p1);
<a name="l00217"></a>00217                 CvPoint res = cvPointFrom32f(cm-&gt;<a class="code" href="class_camera_model.html#5d0c9ba363f2443e5d53112ff35ff7eb">coordsHomo2Image</a>(&amp;p1));
<a name="l00218"></a>00218                 <span class="keywordflow">if</span> (res.x &lt; w &amp;&amp; res.x &gt;= 0 &amp;&amp; res.y &lt; h &amp;&amp; res.y &gt;= 0)
<a name="l00219"></a>00219                         <span class="keywordflow">return</span> res;
<a name="l00220"></a>00220         }
<a name="l00221"></a>00221         <span class="keywordflow">return</span> pt;
<a name="l00222"></a>00222 }
<a name="l00223"></a>00223 <span class="comment">// ----------------------------------------------------------</span>
<a name="l00224"></a><a class="code" href="class_blob.html#2e05a2604e83d5ddda1bb7e682183217">00224</a> <span class="keywordtype">void</span> <a class="code" href="class_blob.html#2e05a2604e83d5ddda1bb7e682183217">Blob::InitHeadCandidates</a>() {
<a name="l00225"></a>00225         <a class="code" href="class_camera_dialog.html">CameraDialog</a>* cm = &amp;<a class="code" href="class_blob.html#c38d4cfdf23ea98267055cf91f10ea1b">doc</a>-&gt;<a class="code" href="class_c_new_vision_doc.html#e21c04f1c508fb2ae7ac1fc9c433d854">cameramodel</a>;
<a name="l00226"></a>00226         <a class="code" href="class_blob_dialog.html">BlobDialog</a>*   bm = &amp;<a class="code" href="class_blob.html#c38d4cfdf23ea98267055cf91f10ea1b">doc</a>-&gt;<a class="code" href="class_c_new_vision_doc.html#b16361836a42ce1853622cd74d654d49">blobmodel</a>;
<a name="l00227"></a>00227         <a class="code" href="class_blob.html#08c0ea0a956ba95b1bd9fb665d1bb5b1">heads</a> = cvCreateSeq(CV_SEQ_ELTYPE_GENERIC, <span class="keyword">sizeof</span>(CvSeq), <span class="keyword">sizeof</span>(<a class="code" href="struct_blob_ray.html">BlobRay</a>), <a class="code" href="_globals_8cpp.html#57efc8aa770b061bfa5f6ba9dc673ef3">OpenCVmemory</a>);
<a name="l00228"></a>00228         
<a name="l00229"></a>00229         CvSeq* <a class="code" href="_globals_8cpp.html#4b2d4e55b64a28d4ac0b4e0a734d9f7a">temp</a> = cvCreateSeq(CV_SEQ_ELTYPE_GENERIC, <span class="keyword">sizeof</span>(CvSeq), <span class="keyword">sizeof</span>(BlobRay), <a class="code" href="_globals_8cpp.html#57efc8aa770b061bfa5f6ba9dc673ef3">OpenCVmemory</a>);
<a name="l00230"></a>00230         <a class="code" href="class_blob.html#3002c8a751c56e5dab21dc42ddbfaa2a">getProjectionHistogram</a>(temp);
<a name="l00231"></a>00231 
<a name="l00232"></a>00232         <span class="comment">// find local peaks</span>
<a name="l00233"></a>00233         <span class="keywordtype">int</span> N = temp -&gt;total;
<a name="l00234"></a>00234         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0; i &lt; N; i++ ) {   
<a name="l00235"></a>00235                 BlobRay* br = (BlobRay*)cvGetSeqElem(temp, i);
<a name="l00236"></a>00236                 <span class="keywordtype">bool</span> max = <span class="keyword">true</span>;
<a name="l00237"></a>00237                 <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j = 0; j &lt; (int)(1./bm-&gt;<a class="code" href="class_blob_model.html#b8460f8fde43a88da9f373147b7a5148">m_maxBodies</a>*N/2); j++ ) {       
<a name="l00238"></a>00238                         BlobRay* br_prev = (BlobRay*)cvGetSeqElem(<a class="code" href="_globals_8cpp.html#4b2d4e55b64a28d4ac0b4e0a734d9f7a">temp</a>, i-1-j &lt; 0 ? (N+i-1-j)%N : i-1-j);
<a name="l00239"></a>00239                         <span class="keywordflow">if</span> (br-&gt;count &lt; br_prev-&gt;count) {
<a name="l00240"></a>00240                                 max = <span class="keyword">false</span>;
<a name="l00241"></a>00241                                 <span class="keywordflow">break</span>;
<a name="l00242"></a>00242                         }
<a name="l00243"></a>00243                 }
<a name="l00244"></a>00244                 <span class="keywordflow">if</span> (max) {
<a name="l00245"></a>00245                         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j = 0; j &lt; (int)(1.0/bm-&gt;m_maxBodies*N/2); j++ ) {      
<a name="l00246"></a>00246                                 <a class="code" href="struct_blob_ray.html">BlobRay</a>* br_next = (<a class="code" href="struct_blob_ray.html">BlobRay</a>*)cvGetSeqElem(<a class="code" href="_globals_8cpp.html#4b2d4e55b64a28d4ac0b4e0a734d9f7a">temp</a>, (i+1+j)%N);
<a name="l00247"></a>00247                                 <span class="keywordflow">if</span> (br-&gt;count &lt; br_next-&gt;count) {
<a name="l00248"></a>00248                                         max = <span class="keyword">false</span>;
<a name="l00249"></a>00249                                         <span class="keywordflow">break</span>;
<a name="l00250"></a>00250                                 }
<a name="l00251"></a>00251                         }
<a name="l00252"></a>00252                 }
<a name="l00253"></a>00253                 <span class="keywordflow">if</span> (max) {
<a name="l00254"></a>00254                         cvSeqPush(heads, br);
<a name="l00255"></a>00255                 }
<a name="l00256"></a>00256         }
<a name="l00257"></a>00257         cvClearSeq(<a class="code" href="_globals_8cpp.html#4b2d4e55b64a28d4ac0b4e0a734d9f7a">temp</a>);
<a name="l00258"></a>00258 
<a name="l00259"></a>00259         <span class="comment">// find max candidate remove the short heads</span>
<a name="l00260"></a>00260         <span class="keywordtype">int</span> maxCount = 0;
<a name="l00261"></a>00261         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0; i &lt; heads-&gt;total; i++ ) {
<a name="l00262"></a>00262                 <a class="code" href="struct_blob_ray.html">BlobRay</a>* br1 = (<a class="code" href="struct_blob_ray.html">BlobRay</a>*)cvGetSeqElem(heads, i);
<a name="l00263"></a>00263                 <span class="keywordflow">if</span> (br1-&gt;count &gt; maxCount)
<a name="l00264"></a>00264                         maxCount = br1-&gt;count;
<a name="l00265"></a>00265         }
<a name="l00266"></a>00266         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0; i &lt; heads-&gt;total; i++ ) {
<a name="l00267"></a>00267                 <a class="code" href="struct_blob_ray.html">BlobRay</a>* br1 = (<a class="code" href="struct_blob_ray.html">BlobRay</a>*)cvGetSeqElem(heads, i);
<a name="l00268"></a>00268                 <span class="comment">// if less that MIN_RAY_SIZE % of the longest</span>
<a name="l00269"></a>00269                 <span class="keywordflow">if</span> (br1-&gt;count &lt; bm-&gt;m_minRaySize*maxCount) {
<a name="l00270"></a>00270                         cvSeqRemove(heads, i);
<a name="l00271"></a>00271                         i--;
<a name="l00272"></a>00272                 }
<a name="l00273"></a>00273         }
<a name="l00274"></a>00274 
<a name="l00275"></a>00275         <span class="comment">// remove neighboring candidates with equal counts</span>
<a name="l00276"></a>00276         <span class="comment">// TODO: modify to work only within a window M, use average as a candidate!</span>
<a name="l00277"></a>00277         cvSeqSort(heads, <a class="code" href="struct_blob_ray.html#a3a363079727daf28457a66868853b5d">BlobRay::cmp_count</a>);
<a name="l00278"></a>00278         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0; i &lt; heads-&gt;total; i++ ) {        
<a name="l00279"></a>00279                 <a class="code" href="struct_blob_ray.html">BlobRay</a>* br1 = (<a class="code" href="struct_blob_ray.html">BlobRay</a>*)cvGetSeqElem(heads, i);
<a name="l00280"></a>00280                 <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j = i+1; j &lt; heads-&gt;total; j++ ) {      
<a name="l00281"></a>00281                         <a class="code" href="struct_blob_ray.html">BlobRay</a>* br2 = (<a class="code" href="struct_blob_ray.html">BlobRay</a>*)cvGetSeqElem(heads, j);
<a name="l00282"></a>00282                         <span class="comment">// if two or more are the same </span>
<a name="l00283"></a>00283                         <span class="keywordflow">if</span> (br1-&gt;count == br2-&gt;count) {
<a name="l00284"></a>00284                                 cvSeqRemove(heads, j);
<a name="l00285"></a>00285                                 j--;
<a name="l00286"></a>00286                         }
<a name="l00287"></a>00287                         <span class="keywordflow">else</span> 
<a name="l00288"></a>00288                                 <span class="keywordflow">break</span>;
<a name="l00289"></a>00289                 }
<a name="l00290"></a>00290         }
<a name="l00291"></a>00291 }
<a name="l00292"></a>00292 <span class="comment">// ----------------------------------------------------------</span>
<a name="l00293"></a><a class="code" href="class_blob.html#be74c3828cc18459c583a94bf00882f7">00293</a> <span class="keywordtype">void</span> <a class="code" href="class_blob.html#be74c3828cc18459c583a94bf00882f7">Blob::Draw</a>(IplImage* frame, CvScalar color) {
<a name="l00294"></a>00294         <a class="code" href="class_camera_dialog.html">CameraDialog</a>* cm = &amp;<a class="code" href="class_blob.html#c38d4cfdf23ea98267055cf91f10ea1b">doc</a>-&gt;<a class="code" href="class_c_new_vision_doc.html#e21c04f1c508fb2ae7ac1fc9c433d854">cameramodel</a>;
<a name="l00295"></a>00295         cvDrawContours(frame, <a class="code" href="class_blob.html#a112954533edaa0a61f2cff337565dcb">contour</a>, color, CV_RGB(100,255,0), 0, CV_FILLED, 8);
<a name="l00296"></a>00296         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0;j&lt;<a class="code" href="class_blob.html#08c0ea0a956ba95b1bd9fb665d1bb5b1">heads</a>-&gt;total;j++) {
<a name="l00297"></a>00297                 <a class="code" href="struct_blob_ray.html">BlobRay</a>* ray = (<a class="code" href="struct_blob_ray.html">BlobRay</a>*)cvGetSeqElem(<a class="code" href="class_blob.html#08c0ea0a956ba95b1bd9fb665d1bb5b1">heads</a>, j);
<a name="l00298"></a>00298                 CvSize axes;
<a name="l00299"></a>00299                 axes.height = (int)sqrt((<span class="keywordtype">double</span>)((ray-&gt;p1.x-ray-&gt;p2.x)*(ray-&gt;p1.x-ray-&gt;p2.x)+
<a name="l00300"></a>00300                         (ray-&gt;p1.y-ray-&gt;p2.y)*(ray-&gt;p1.y-ray-&gt;p2.y)))/2;
<a name="l00301"></a>00301                 axes.width = (<span class="keywordtype">int</span>)(0.4*axes.height);
<a name="l00302"></a>00302                 CvPoint p;
<a name="l00303"></a>00303                 p.x = (ray-&gt;p1.x + ray-&gt;p2.x)/2;
<a name="l00304"></a>00304                 p.y = (ray-&gt;p1.y + ray-&gt;p2.y)/2;
<a name="l00305"></a>00305                 <span class="keywordtype">double</span> slope = (<span class="keywordtype">double</span>)((ray-&gt;p1.y-ray-&gt;p2.y));
<a name="l00306"></a>00306                 slope = slope/(ray-&gt;p1.x - ray-&gt;p2.x);
<a name="l00307"></a>00307                 slope = atan(slope);
<a name="l00308"></a>00308                 <span class="keywordtype">double</span> <a class="code" href="_globals_8cpp.html#ae32a1500319b23d5b65632106cfe9a2">angle</a> =  180*(slope)/<a class="code" href="_globals_8h.html#598a3330b3c21701223ee0ca14316eca">PI</a>;
<a name="l00309"></a>00309 <span class="comment">//              cvEllipse(frame, p, axes, -90-angle, 0, 360, CV_RGB(0,0,255),1);</span>
<a name="l00310"></a>00310 
<a name="l00311"></a>00311                 <span class="comment">// draw endpoints</span>
<a name="l00312"></a>00312                 cvCircle(frame, ray-&gt;p1, 2, CV_RGB(255,0,0),-1); 
<a name="l00313"></a>00313                 cvCircle(frame, ray-&gt;p2, 2, CV_RGB(0,0,255),-1); 
<a name="l00314"></a>00314 
<a name="l00315"></a>00315                 <span class="comment">/*CvPoint3D32f h3, f3;</span>
<a name="l00316"></a>00316 <span class="comment">                double f = cm-&gt;coordsImage2RealSameXY_Feet2Floor(cvPointTo32f(ray-&gt;p1), cvPointTo32f(ray-&gt;p2), &amp;h3, &amp;f3);</span>
<a name="l00317"></a>00317 <span class="comment">                char s[20];</span>
<a name="l00318"></a>00318 <span class="comment">                sprintf(s, "%d", (int)f);</span>
<a name="l00319"></a>00319 <span class="comment">                */</span>
<a name="l00320"></a>00320                 
<a name="l00321"></a>00321         }
<a name="l00322"></a>00322 }
<a name="l00323"></a>00323 <span class="comment">// ----------------------------------------------------------</span>
<a name="l00324"></a><a class="code" href="class_blob.html#1923166b51c8ee94e5907b2221d33118">00324</a> <span class="keywordtype">void</span> <a class="code" href="class_blob.html#1923166b51c8ee94e5907b2221d33118">Blob::DrawHeight</a>(IplImage* frame, CvScalar color) {
<a name="l00325"></a>00325         <span class="keywordtype">double</span> max_f = 0;
<a name="l00326"></a>00326         <a class="code" href="struct_blob_ray.html">BlobRay</a>* max_ray = NULL;
<a name="l00327"></a>00327         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0;j&lt;<a class="code" href="class_blob.html#08c0ea0a956ba95b1bd9fb665d1bb5b1">heads</a>-&gt;total;j++) {
<a name="l00328"></a>00328                 <a class="code" href="struct_blob_ray.html">BlobRay</a>* ray = (<a class="code" href="struct_blob_ray.html">BlobRay</a>*)cvGetSeqElem(<a class="code" href="class_blob.html#08c0ea0a956ba95b1bd9fb665d1bb5b1">heads</a>, j);
<a name="l00329"></a>00329                 <span class="keywordtype">double</span> f = <a class="code" href="class_blob.html#c38d4cfdf23ea98267055cf91f10ea1b">doc</a>-&gt;<a class="code" href="class_c_new_vision_doc.html#e21c04f1c508fb2ae7ac1fc9c433d854">cameramodel</a>.<a class="code" href="class_camera_model.html#e7a6ee450e74dcd7e7d41ffd10a8d4bb">computeHeight</a>(cvPointTo32f(ray-&gt;p1), cvPointTo32f(ray-&gt;p2));
<a name="l00330"></a>00330                 <span class="keywordflow">if</span> (f &gt; max_f) {
<a name="l00331"></a>00331                         max_f = f;
<a name="l00332"></a>00332                         max_ray = ray;
<a name="l00333"></a>00333                 }
<a name="l00334"></a>00334         }
<a name="l00335"></a>00335         <a class="code" href="_globals_8cpp.html#ebac2e97267778257260308eed554ab2">drawText</a>(max_f, max_ray-&gt;<a class="code" href="struct_blob_ray.html#25e5b527b01731792136988eef4406fb">p1</a>, frame, color, CV_RGB(255,255,255), 0.7f);
<a name="l00336"></a>00336 }
<a name="l00337"></a>00337 <span class="comment">// ----------------------------------------------------------</span>
<a name="l00338"></a><a class="code" href="class_blob.html#e43e59291177d31e9972ff010401fa6c">00338</a> <span class="keywordtype">void</span> <a class="code" href="class_blob.html#e43e59291177d31e9972ff010401fa6c">Blob::Rasterize</a>(IplImage* frame, CvScalar color) {
<a name="l00339"></a>00339         cvDrawContours(frame, <a class="code" href="class_blob.html#a112954533edaa0a61f2cff337565dcb">contour</a>, color, color, 0, CV_FILLED, 8);
<a name="l00340"></a>00340 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Tue Apr 24 22:32:50 2007 for New Vision by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.1-p1 </small></address>
</body>
</html>

<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>New Vision: F:/My Documents/Visual Studio 2005/Projects/NewVision/NewVision/BodyModel.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.1-p1 -->
<div class="tabs">
  <ul>
    <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="namespaces.html"><span>Namespaces</span></a></li>
    <li><a href="annotated.html"><span>Classes</span></a></li>
    <li id="current"><a href="files.html"><span>Files</span></a></li>
    <li>
      <form action="search.php" method="get">
        <table cellspacing="0" cellpadding="0" border="0">
          <tr>
            <td><label>&nbsp;<u>S</u>earch&nbsp;for&nbsp;</label></td>
            <td><input type="text" name="query" value="" size="20" accesskey="s"/></td>
          </tr>
        </table>
      </form>
    </li>
  </ul></div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
  </ul></div>
<h1>F:/My Documents/Visual Studio 2005/Projects/NewVision/NewVision/BodyModel.cpp</h1><a href="_body_model_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor">#include "<a class="code" href="_std_afx_8h.html">StdAfx.h</a>"</span>
<a name="l00002"></a>00002 <span class="preprocessor">#include "<a class="code" href="_body_model_8h.html">BodyModel.h</a>"</span>
<a name="l00003"></a>00003 <span class="preprocessor">#include "<a class="code" href="_new_vision_doc_8h.html">NewVisionDoc.h</a>"</span>
<a name="l00004"></a>00004 <span class="preprocessor">#include "<a class="code" href="_globals_8h.html">Globals.h</a>"</span>
<a name="l00005"></a>00005 <span class="preprocessor">#include "<a class="code" href="_swarm_activity_model_8h.html">SwarmActivityModel.h</a>"</span>
<a name="l00006"></a>00006 <span class="preprocessor">#include "<a class="code" href="_body_activity_model_8h.html">BodyActivityModel.h</a>"</span>
<a name="l00007"></a>00007 <span class="preprocessor">#include "<a class="code" href="_blob_8h.html">Blob.h</a>"</span>
<a name="l00008"></a>00008 <span class="preprocessor">#include "<a class="code" href="_body_path_8h.html">BodyPath.h</a>"</span>
<a name="l00009"></a>00009 <span class="preprocessor">#include "<a class="code" href="_body_path_cluster_8h.html">BodyPathCluster.h</a>"</span>
<a name="l00010"></a>00010 
<a name="l00011"></a>00011 <span class="preprocessor">#using &lt;mscorlib.dll&gt;</span>
<a name="l00012"></a>00012 <span class="preprocessor"></span><span class="preprocessor">#using &lt;System.dll&gt;</span>
<a name="l00013"></a>00013 <span class="preprocessor"></span><span class="keyword">using namespace </span>System;
<a name="l00014"></a>00014 <span class="keyword">using namespace </span>System::Diagnostics;
<a name="l00015"></a>00015 
<a name="l00016"></a>00016 IMPLEMENT_SERIAL(<a class="code" href="class_body_model.html">BodyModel</a>, <a class="code" href="class_model.html">Model</a>, 1)
<a name="l00017"></a><a class="code" href="_body_model_8cpp.html#2105f22be323790f006d0c12046611fc">00017</a> double <a class="code" href="_body_model_8cpp.html#4bc20c4b453af1f7ee3d6f5bbfec0db0">pbg</a> =0, <a class="code" href="_body_model_8cpp.html#2105f22be323790f006d0c12046611fc">pfg</a>=0;
<a name="l00018"></a>00018 <span class="comment">// --------------------------------------------------------------------------</span>
<a name="l00019"></a><a class="code" href="class_body_model.html#365e2b61d38a3400c5451d56f46e295d">00019</a> <a class="code" href="class_body_model.html">BodyModel</a>::<a class="code" href="class_body_model.html">BodyModel</a>(<span class="keywordtype">void</span>) {
<a name="l00020"></a>00020         m_initialized = <span class="keyword">false</span>;
<a name="l00021"></a>00021 }
<a name="l00022"></a>00022 <span class="comment">// --------------------------------------------------------------------------</span>
<a name="l00023"></a><a class="code" href="class_body_model.html#484dc1d61230cfbdca6221e3c43e74dd">00023</a> <a class="code" href="class_body_model.html#484dc1d61230cfbdca6221e3c43e74dd">BodyModel::~BodyModel</a>(<span class="keywordtype">void</span>) {
<a name="l00024"></a>00024 }
<a name="l00025"></a>00025 <span class="comment">// --------------------------------------------------------------------------</span>
<a name="l00026"></a><a class="code" href="class_body_model.html#e453fb41d283a42b3ac80853faaad7bd">00026</a> <span class="keywordtype">bool</span> <a class="code" href="class_body_model.html#e453fb41d283a42b3ac80853faaad7bd">BodyModel::Initialize</a>() {
<a name="l00027"></a>00027         <span class="keywordflow">if</span> (<a class="code" href="class_body_model.html#ecc126949cfb7fa08024f2460e4f230a">m_initialized</a>)
<a name="l00028"></a>00028                 <a class="code" href="class_body_model.html#9bbe1fd6fa5e112ff8d67d78e3d93cb7">DeInitialize</a>();
<a name="l00029"></a>00029         cvZero(<a class="code" href="_globals_8cpp.html#de2979bbac1fc6254835496289660e23">zbuffer</a>);
<a name="l00030"></a>00030         cvZero(<a class="code" href="_globals_8cpp.html#b2ce9da27e1d5727e29e8ef30329a08d">body_zbuffer</a>);
<a name="l00031"></a>00031         <a class="code" href="class_body_model.html#4579ffa38bb9d8b281e1ec6498b73d98">last_id</a> = 0;
<a name="l00032"></a>00032         <a class="code" href="class_body_model.html#ecc126949cfb7fa08024f2460e4f230a">m_initialized</a> = <span class="keyword">true</span>;
<a name="l00033"></a>00033         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00034"></a>00034 }
<a name="l00035"></a>00035 <span class="comment">// --------------------------------------------------------------------------</span>
<a name="l00036"></a><a class="code" href="class_body_model.html#9bbe1fd6fa5e112ff8d67d78e3d93cb7">00036</a> <span class="keywordtype">void</span> <a class="code" href="class_body_model.html#9bbe1fd6fa5e112ff8d67d78e3d93cb7">BodyModel::DeInitialize</a>() {
<a name="l00037"></a>00037         <span class="keywordflow">if</span> (!<a class="code" href="class_body_model.html#ecc126949cfb7fa08024f2460e4f230a">m_initialized</a>)
<a name="l00038"></a>00038                 <span class="keywordflow">return</span>;
<a name="l00039"></a>00039         <a class="code" href="class_body_model.html#ecc126949cfb7fa08024f2460e4f230a">m_initialized</a> = <span class="keyword">false</span>;
<a name="l00040"></a>00040         <a class="code" href="class_body_model.html#0e5edd4f262774e6b0885f5dd2534099">body</a>.<a class="code" href="class_body_map.html#569432be624023562a6d52797505617c">RemoveAll</a>();
<a name="l00041"></a>00041         <a class="code" href="class_body_model.html#e447fae9bacc236ad12a76435218136b">body_deleted</a>.<a class="code" href="class_body_map.html#569432be624023562a6d52797505617c">RemoveAll</a>();
<a name="l00042"></a>00042 }
<a name="l00043"></a>00043 <span class="comment">// --------------------------------------------------------------------------</span>
<a name="l00044"></a><a class="code" href="class_body_model.html#610077e7329d52e2f9797ef47420804f">00044</a> <span class="keywordtype">void</span> <a class="code" href="class_body_model.html#610077e7329d52e2f9797ef47420804f">BodyModel::Predict</a>() {
<a name="l00045"></a>00045         <span class="comment">// update floor occupancy map</span>
<a name="l00046"></a>00046         <a class="code" href="class_body_model.html#c0afae5e07645bfbb8d11d6418805f8f">UpdateFBuffer</a>(<a class="code" href="_globals_8cpp.html#265f52600f6ef779ee93cbcac470a9fa">fbuffer</a>, NULL, <a class="code" href="class_model.html#a0b1e435ecf4aaa93341250242dce611">doc</a>-&gt;<a class="code" href="class_c_new_vision_doc.html#41c0e2d5c878b813ee2307c44a94ad5d">obstaclemodel</a>.<a class="code" href="class_obstacle_model.html#9d858646602ea202584185b0a6de58b2">obstacle</a>, <a class="code" href="_body_model_8h.html#4acfa4ed0e32f981e5415209be331c723095c6fa66ce7d68d7362bce9a34be11">F_OBSTACLES_ONLY</a>);
<a name="l00047"></a>00047         <span class="comment">// search the solution space</span>
<a name="l00048"></a>00048         <a class="code" href="class_body_model.html#1e03990d781d60c26f70c6c85859d342">Iterate</a>();
<a name="l00049"></a>00049 }
<a name="l00050"></a>00050 <span class="comment">// --------------------------------------------------------------------------</span>
<a name="l00051"></a><a class="code" href="class_body_model.html#9eb9ed9a8b31e95a64f0d904bf8e5148">00051</a> <span class="keywordtype">void</span> <a class="code" href="class_body_model.html#9eb9ed9a8b31e95a64f0d904bf8e5148">BodyModel::UpdateHistograms</a>(<a class="code" href="class_body_map.html">BodyMap</a>&amp; bmap) {
<a name="l00052"></a>00052         <span class="comment">// update body histograms</span>
<a name="l00053"></a>00053         POSITION pos = bmap.GetStartPosition();
<a name="l00054"></a>00054         <span class="keywordflow">while</span> (pos) {
<a name="l00055"></a>00055                 <span class="keywordtype">int</span> i; <a class="code" href="class_body.html">Body</a> *b;
<a name="l00056"></a>00056                 bmap.GetNextAssoc(pos, i, b);
<a name="l00057"></a>00057                 b-&gt;<a class="code" href="class_body.html#40c8d782e49aeba79a09b2d00d3b552b">HistogramUpdate</a>(<a class="code" href="_globals_8cpp.html#dcc8eea4165f02dc8d32606c13087c67">imgFrame</a>);   
<a name="l00058"></a>00058         }
<a name="l00059"></a>00059 }
<a name="l00060"></a>00060 <span class="comment">// --------------------------------------------------------------------------</span>
<a name="l00061"></a><a class="code" href="class_body_model.html#13b8a742cc6cf2a967c3114df879200a">00061</a> <span class="keywordtype">void</span> <a class="code" href="class_body_model.html#13b8a742cc6cf2a967c3114df879200a">BodyModel::UpdateZBuffer</a>(IplImage* z, <a class="code" href="class_body_map.html">BodyMap</a>&amp; bmap, <a class="code" href="class_smart_ptr_array.html">SmartPtrArray&lt;Object3D&gt;</a>&amp; obstacle, <a class="code" href="_body_model_8h.html#c60adcb1b450332fc494693b0cd63b33">Z_MODE</a> mode) {
<a name="l00062"></a>00062         <span class="comment">// combine bodies and obstacles in a single array</span>
<a name="l00063"></a>00063         <span class="keywordtype">int</span> s = bmap.GetCount()+<a class="code" href="class_model.html#a0b1e435ecf4aaa93341250242dce611">doc</a>-&gt;<a class="code" href="class_c_new_vision_doc.html#41c0e2d5c878b813ee2307c44a94ad5d">obstaclemodel</a>.<a class="code" href="class_obstacle_model.html#9d858646602ea202584185b0a6de58b2">obstacle</a>.GetCount();
<a name="l00064"></a>00064 
<a name="l00065"></a>00065         <span class="comment">// add bodies </span>
<a name="l00066"></a>00066         <a class="code" href="class_object3_d.html">Object3D</a>** all = <span class="keyword">new</span> <a class="code" href="class_object3_d.html">Object3D</a>*[s];
<a name="l00067"></a>00067         POSITION pos = bmap.GetStartPosition();
<a name="l00068"></a>00068         <span class="keywordtype">int</span> i1=0;
<a name="l00069"></a>00069         <span class="keywordflow">while</span> (pos) {
<a name="l00070"></a>00070                 <span class="keywordtype">int</span> id; <a class="code" href="class_body.html">Body</a> *b;
<a name="l00071"></a>00071                 bmap.GetNextAssoc(pos, <span class="keywordtype">id</span>, b);
<a name="l00072"></a>00072                 all[i1] = b;
<a name="l00073"></a>00073                 i1++;
<a name="l00074"></a>00074         }
<a name="l00075"></a>00075 
<a name="l00076"></a>00076         <span class="comment">// add obstacels</span>
<a name="l00077"></a>00077         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i2=0; i2 &lt; <a class="code" href="class_model.html#a0b1e435ecf4aaa93341250242dce611">doc</a>-&gt;<a class="code" href="class_c_new_vision_doc.html#41c0e2d5c878b813ee2307c44a94ad5d">obstaclemodel</a>.<a class="code" href="class_obstacle_model.html#9d858646602ea202584185b0a6de58b2">obstacle</a>.GetCount();i2++)
<a name="l00078"></a>00078                 all[i2+i1] = <a class="code" href="class_model.html#a0b1e435ecf4aaa93341250242dce611">doc</a>-&gt;<a class="code" href="class_c_new_vision_doc.html#41c0e2d5c878b813ee2307c44a94ad5d">obstaclemodel</a>.<a class="code" href="class_obstacle_model.html#9d858646602ea202584185b0a6de58b2">obstacle</a>[i2];
<a name="l00079"></a>00079 
<a name="l00080"></a>00080         <span class="comment">// sort the elements</span>
<a name="l00081"></a>00081         for (<span class="keywordtype">int</span> i=0;i&lt;s;i++)
<a name="l00082"></a>00082                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=1;j&lt;s-i;j++) {
<a name="l00083"></a>00083                         <span class="keywordflow">if</span> (all[j-1]-&gt;Compare(all[j]) &gt; 0) {
<a name="l00084"></a>00084                                 <a class="code" href="class_object3_d.html">Object3D</a>* <a class="code" href="_globals_8cpp.html#4b2d4e55b64a28d4ac0b4e0a734d9f7a">temp</a> = all[j-1];
<a name="l00085"></a>00085                                 all[j-1] = all[j];
<a name="l00086"></a>00086                                 all[j] = <a class="code" href="_globals_8cpp.html#4b2d4e55b64a28d4ac0b4e0a734d9f7a">temp</a>;
<a name="l00087"></a>00087                         }
<a name="l00088"></a>00088                 }
<a name="l00089"></a>00089 
<a name="l00090"></a>00090         <span class="comment">// update zbuffer: 0 = BG, 1...N - from farthest to the closest object</span>
<a name="l00091"></a>00091         cvZero(z);
<a name="l00092"></a>00092         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=s-1;i &gt;=0;i--) {
<a name="l00093"></a>00093                 <span class="keywordflow">switch</span> (mode) {
<a name="l00094"></a>00094                         <span class="keywordflow">case</span> <a class="code" href="_body_model_8h.html#c60adcb1b450332fc494693b0cd63b33a67ccf1c3a08f63c8f09c17b2b1795a9">BODIES_ONLY</a>: {
<a name="l00095"></a>00095                                 <span class="keywordflow">if</span> (all[i]-&gt;IsKindOf(RUNTIME_CLASS( <a class="code" href="class_body.html">Body</a> ))) {
<a name="l00096"></a>00096                                         all[i]-&gt;depthZ = (s-i);
<a name="l00097"></a>00097                                         all[i]-&gt;<a class="code" href="class_object3_d.html#9c1f50b6d8760f9f1126ff7a15dca743">RasterizeFrame</a>(z, cvScalar(s-i));
<a name="l00098"></a>00098                                 }
<a name="l00099"></a>00099                                 <span class="keywordflow">break</span>;
<a name="l00100"></a>00100                         }
<a name="l00101"></a>00101                         <span class="keywordflow">case</span> <a class="code" href="_body_model_8h.html#c60adcb1b450332fc494693b0cd63b3394a38a66d363575a5e199ad5b312751f">OBSTACLES_ONLY</a>: {
<a name="l00102"></a>00102                                 <span class="keywordflow">if</span> (all[i]-&gt;IsKindOf(RUNTIME_CLASS( <a class="code" href="class_obstacle.html">Obstacle</a> ))) {
<a name="l00103"></a>00103                                         all[i]-&gt;<a class="code" href="class_object3_d.html#1ff85904d1bb882a616ce7bc4b609a5f">depthZ</a> = (s-i);
<a name="l00104"></a>00104                                         all[i]-&gt;<a class="code" href="class_object3_d.html#9c1f50b6d8760f9f1126ff7a15dca743">RasterizeFrame</a>(z, cvScalar(s-i));
<a name="l00105"></a>00105                                 }
<a name="l00106"></a>00106                                 <span class="keywordflow">break</span>;
<a name="l00107"></a>00107                         }
<a name="l00108"></a>00108                         <span class="keywordflow">case</span> <a class="code" href="_body_model_8h.html#c60adcb1b450332fc494693b0cd63b33952cbe05cb7cd58d013504ff4c78006b">BODIES_MINUS_OBSTACLES</a>: {
<a name="l00109"></a>00109                                 all[i]-&gt;<a class="code" href="class_object3_d.html#1ff85904d1bb882a616ce7bc4b609a5f">depthZ</a> = (s-i);
<a name="l00110"></a>00110                                 <span class="comment">//echo(gcnew String(prt-&gt;m_lpszClassName));</span>
<a name="l00111"></a>00111                                 <span class="comment">//if (all[i]-&gt;GetRuntimeClass()-&gt;IsDerivedFrom(RUNTIME_CLASS( Obstacle ))) {</span>
<a name="l00112"></a>00112                                 <span class="keywordflow">if</span> (all[i]-&gt;IsKindOf(RUNTIME_CLASS( <a class="code" href="class_obstacle.html">Obstacle</a> ))) {
<a name="l00113"></a>00113                                         all[i]-&gt;<a class="code" href="class_object3_d.html#9c1f50b6d8760f9f1126ff7a15dca743">RasterizeFrame</a>(z, cvScalar(0));
<a name="l00114"></a>00114                                 }
<a name="l00115"></a>00115                                 <span class="keywordflow">else</span> {
<a name="l00116"></a>00116                                         all[i]-&gt;<a class="code" href="class_object3_d.html#9c1f50b6d8760f9f1126ff7a15dca743">RasterizeFrame</a>(z, cvScalar(s-i));
<a name="l00117"></a>00117                                 }
<a name="l00118"></a>00118                                 <span class="keywordflow">break</span>;
<a name="l00119"></a>00119                         }
<a name="l00120"></a>00120                         <span class="keywordflow">case</span> <a class="code" href="_body_model_8h.html#c60adcb1b450332fc494693b0cd63b33b1d5eac4b1dca480c8056eaea7663b7a">ALL</a>: {
<a name="l00121"></a>00121                                 all[i]-&gt;<a class="code" href="class_object3_d.html#1ff85904d1bb882a616ce7bc4b609a5f">depthZ</a> = (s-i);
<a name="l00122"></a>00122                                 all[i]-&gt;<a class="code" href="class_object3_d.html#9c1f50b6d8760f9f1126ff7a15dca743">RasterizeFrame</a>(z, cvScalar(s-i));
<a name="l00123"></a>00123                         }
<a name="l00124"></a>00124                 }
<a name="l00125"></a>00125         }
<a name="l00126"></a>00126         <span class="keyword">delete</span> [] all;
<a name="l00127"></a>00127 }
<a name="l00128"></a>00128 <span class="comment">// --------------------------------------------------------------------------</span>
<a name="l00129"></a><a class="code" href="class_body_model.html#c0afae5e07645bfbb8d11d6418805f8f">00129</a> <span class="keywordtype">void</span> <a class="code" href="class_body_model.html#c0afae5e07645bfbb8d11d6418805f8f">BodyModel::UpdateFBuffer</a>(IplImage* floor, <a class="code" href="class_body_map.html">BodyMap</a>* bmap, <a class="code" href="class_smart_ptr_array.html">SmartPtrArray&lt;Object3D&gt;</a>&amp; obstacle, <a class="code" href="_body_model_8h.html#4acfa4ed0e32f981e5415209be331c72">F_MODE</a> mode) {
<a name="l00130"></a>00130         <span class="comment">// update fbuffer: 1=object present  0 = object absent</span>
<a name="l00131"></a>00131         cvZero(floor);
<a name="l00132"></a>00132         <span class="keywordflow">switch</span> (mode) {
<a name="l00133"></a>00133                 <span class="keywordflow">case</span> <a class="code" href="_body_model_8h.html#4acfa4ed0e32f981e5415209be331c7295fe306ece9aa6f6d585c137d257d5ff">F_BODIES_ONLY</a>: {
<a name="l00134"></a>00134                         POSITION pos = bmap-&gt;GetStartPosition();
<a name="l00135"></a>00135                         <span class="keywordflow">while</span> (pos) {
<a name="l00136"></a>00136                                 <span class="keywordtype">int</span> id; <a class="code" href="class_body.html">Body</a> *b;
<a name="l00137"></a>00137                                 bmap-&gt;GetNextAssoc(pos, <span class="keywordtype">id</span>, b);
<a name="l00138"></a>00138                                 b-&gt;<a class="code" href="class_body.html#668de1bd62956cbb2c1fdff32c7c4a31">RasterizeFloor</a>(floor, cvScalar(1));
<a name="l00139"></a>00139                         }
<a name="l00140"></a>00140                         <span class="keywordflow">break</span>;
<a name="l00141"></a>00141                 }
<a name="l00142"></a>00142                 <span class="keywordflow">case</span> <a class="code" href="_body_model_8h.html#4acfa4ed0e32f981e5415209be331c723095c6fa66ce7d68d7362bce9a34be11">F_OBSTACLES_ONLY</a>: {
<a name="l00143"></a>00143                         <a class="code" href="class_model.html#a0b1e435ecf4aaa93341250242dce611">doc</a>-&gt;<a class="code" href="class_c_new_vision_doc.html#41c0e2d5c878b813ee2307c44a94ad5d">obstaclemodel</a>.<a class="code" href="class_obstacle_model.html#867aafeee30d90d9ae7f023eaf980b6c">RasterizeFloor</a>(floor, cvScalar(1));
<a name="l00144"></a>00144                         <span class="keywordflow">break</span>;
<a name="l00145"></a>00145                 }
<a name="l00146"></a>00146                 <span class="keywordflow">case</span> <a class="code" href="_body_model_8h.html#4acfa4ed0e32f981e5415209be331c72ea977ef42deb0eae234da8f8e4294bf2">F_ALL</a>: {
<a name="l00147"></a>00147                         POSITION pos = bmap-&gt;GetStartPosition();
<a name="l00148"></a>00148                         <span class="keywordflow">while</span> (pos) {
<a name="l00149"></a>00149                                 <span class="keywordtype">int</span> id; <a class="code" href="class_body.html">Body</a> *b;
<a name="l00150"></a>00150                                 bmap-&gt;GetNextAssoc(pos, <span class="keywordtype">id</span>, b);
<a name="l00151"></a>00151                                 b-&gt;<a class="code" href="class_body.html#668de1bd62956cbb2c1fdff32c7c4a31">RasterizeFloor</a>(floor, cvScalar(1));
<a name="l00152"></a>00152                         }
<a name="l00153"></a>00153                         <a class="code" href="class_model.html#a0b1e435ecf4aaa93341250242dce611">doc</a>-&gt;<a class="code" href="class_c_new_vision_doc.html#41c0e2d5c878b813ee2307c44a94ad5d">obstaclemodel</a>.<a class="code" href="class_obstacle_model.html#867aafeee30d90d9ae7f023eaf980b6c">RasterizeFloor</a>(floor, cvScalar(1));
<a name="l00154"></a>00154                 }
<a name="l00155"></a>00155         }
<a name="l00156"></a>00156 }                                                       
<a name="l00157"></a>00157                                                         
<a name="l00158"></a>00158 <span class="comment">// --------------------------------------------------------------------------</span>
<a name="l00159"></a><a class="code" href="class_body_model.html#e4823328452c1b9683df20bb232ef465">00159</a> <span class="keywordtype">int</span> <a class="code" href="class_body_model.html#e4823328452c1b9683df20bb232ef465">BodyModel::GetRandomMutationNumber</a>() {
<a name="l00160"></a>00160                 <span class="keywordtype">double</span> random = cvRandReal(&amp;<a class="code" href="_globals_8cpp.html#ff39e3308132c1b3c9548c6bbdf21b55">rnd_seed</a>);
<a name="l00161"></a>00161                 <span class="keywordtype">int</span> choice = 0;
<a name="l00162"></a>00162                 <span class="keywordtype">double</span> P1 = 0, P2 = <a class="code" href="class_body_model.html#e362ff5848585ad2982d48f276edda5c">p_diffuse</a>;
<a name="l00163"></a>00163                 <span class="keywordflow">if</span> (random &gt; P1 &amp;&amp; random &lt; P2)
<a name="l00164"></a>00164                         choice = 1;
<a name="l00165"></a>00165                 P1 = P2;
<a name="l00166"></a>00166                 P2 += <a class="code" href="class_body_model.html#1f7f8f972815db896f5be322d44671b8">p_update</a>;
<a name="l00167"></a>00167                 <span class="keywordflow">if</span> (random &gt; P1 &amp;&amp; random &lt; P2)
<a name="l00168"></a>00168                         choice = 2;
<a name="l00169"></a>00169                 P1 = P2;
<a name="l00170"></a>00170                 P2 += <a class="code" href="class_body_model.html#35ea736a497b58aa5a8b0a1cb4f8adef">p_exchange</a>;
<a name="l00171"></a>00171                 <span class="keywordflow">if</span> (random &gt; P1 &amp;&amp; random &lt; P2)
<a name="l00172"></a>00172                         choice = 3;
<a name="l00173"></a>00173                 P1 = P2;
<a name="l00174"></a>00174                 P2 += <a class="code" href="class_body_model.html#63666a42daea962c0f772bf7933c3f49">p_remove</a>;
<a name="l00175"></a>00175                 <span class="keywordflow">if</span> (random &gt; P1 &amp;&amp; random &lt; P2)
<a name="l00176"></a>00176                         choice = 4;
<a name="l00177"></a>00177                 P1 = P2;
<a name="l00178"></a>00178                 P2 += <a class="code" href="class_body_model.html#fac301d307240bcbf92c8653bad59109">p_add</a>;
<a name="l00179"></a>00179                 <span class="keywordflow">if</span> (random &gt; P1 &amp;&amp; random &lt; P2)
<a name="l00180"></a>00180                         choice = 5;
<a name="l00181"></a>00181                 
<a name="l00182"></a>00182                 <span class="keywordflow">return</span> choice;
<a name="l00183"></a>00183 }
<a name="l00184"></a>00184 <span class="comment">// --------------------------------------------------------------------------</span>
<a name="l00185"></a><a class="code" href="class_body_model.html#1e03990d781d60c26f70c6c85859d342">00185</a> <span class="keywordtype">void</span> <a class="code" href="class_body_model.html#1e03990d781d60c26f70c6c85859d342">BodyModel::Iterate</a>() {
<a name="l00186"></a>00186         <span class="comment">// don't bother if nothing is in the scene</span>
<a name="l00187"></a>00187         <span class="keywordflow">if</span> (!<a class="code" href="class_model.html#a0b1e435ecf4aaa93341250242dce611">doc</a>-&gt;<a class="code" href="class_c_new_vision_doc.html#b16361836a42ce1853622cd74d654d49">blobmodel</a>.<a class="code" href="class_blob_model.html#8ffdb39930b16b71d399390607fd0e4a">blob</a>.GetCount() &amp;&amp; !<a class="code" href="class_body_model.html#0e5edd4f262774e6b0885f5dd2534099">body</a>.GetCount())
<a name="l00188"></a>00188                 <span class="keywordflow">return</span>;
<a name="l00189"></a>00189 
<a name="l00190"></a>00190         <span class="comment">// generate foreground and background images</span>
<a name="l00191"></a>00191         cvZero(<a class="code" href="_globals_8cpp.html#96e982ff176958ec197a50586ee65368">fg</a>);
<a name="l00192"></a>00192         <a class="code" href="class_model.html#a0b1e435ecf4aaa93341250242dce611">doc</a>-&gt;<a class="code" href="class_c_new_vision_doc.html#b16361836a42ce1853622cd74d654d49">blobmodel</a>.<a class="code" href="class_blob_model.html#1df435de5299a107a4741afacabf61e8">Rasterize</a>(fg, cvScalar(1));
<a name="l00193"></a>00193         cvSet(<a class="code" href="_globals_8cpp.html#7fa38479663d065faad9145a4017f930">bg</a>, cvScalar(1));
<a name="l00194"></a>00194         <a class="code" href="class_model.html#a0b1e435ecf4aaa93341250242dce611">doc</a>-&gt;<a class="code" href="class_c_new_vision_doc.html#b16361836a42ce1853622cd74d654d49">blobmodel</a>.<a class="code" href="class_blob_model.html#1df435de5299a107a4741afacabf61e8">Rasterize</a>(<a class="code" href="_globals_8cpp.html#7fa38479663d065faad9145a4017f930">bg</a>, cvScalar(0));
<a name="l00195"></a>00195 
<a name="l00196"></a>00196         <span class="comment">// update histograms of the accepted model</span>
<a name="l00197"></a>00197         <a class="code" href="class_body_model.html#9eb9ed9a8b31e95a64f0d904bf8e5148">UpdateHistograms</a>(<a class="code" href="class_body_model.html#0e5edd4f262774e6b0885f5dd2534099">body</a>); 
<a name="l00198"></a>00198 
<a name="l00199"></a>00199         <a class="code" href="class_model.html#a0b1e435ecf4aaa93341250242dce611">doc</a>-&gt;<a class="code" href="class_c_new_vision_doc.html#d5acf3ec790c58f8fe3978a16f519ea0">bodyactivitymodel</a>.<a class="code" href="class_body_activity_model.html#18a8613976bcbdd6e39881b39fa04bea">UpdateSalesRepHist</a>();
<a name="l00200"></a>00200 
<a name="l00201"></a>00201         <span class="comment">// update Kalman filter state and generate predicted state</span>
<a name="l00202"></a>00202         
<a name="l00203"></a>00203         <span class="keywordflow">for</span> (POSITION pos = <a class="code" href="class_body_model.html#0e5edd4f262774e6b0885f5dd2534099">body</a>.GetStartPosition();pos;) {
<a name="l00204"></a>00204                 <span class="keywordtype">int</span> i; <a class="code" href="class_body.html">Body</a> *b;
<a name="l00205"></a>00205                 <a class="code" href="class_body_model.html#0e5edd4f262774e6b0885f5dd2534099">body</a>.GetNextAssoc(pos, i, b);
<a name="l00206"></a>00206                 b-&gt;<a class="code" href="class_body.html#f4f269ae23357098d35bc727d5ffe78d">KalmanObserve</a>();
<a name="l00207"></a>00207                 b-&gt;<a class="code" href="class_body.html#2ce4f314e34600876319cd459e27abe9">KalmanPredict</a>();
<a name="l00208"></a>00208         }
<a name="l00209"></a>00209 
<a name="l00210"></a>00210         <span class="comment">// remove the bodies completely empty of FG pixels for prolonged periods of time</span>
<a name="l00211"></a>00211         <a class="code" href="class_body_model.html#4f47d0935100df09ed66628b0c4e54d1">RemoveEmpty</a>(<a class="code" href="class_body_model.html#0e5edd4f262774e6b0885f5dd2534099">body</a>);
<a name="l00212"></a>00212         
<a name="l00213"></a>00213         <span class="comment">// remove bodies outside of interest region</span>
<a name="l00214"></a>00214         <span class="keywordflow">if</span> (<a class="code" href="class_model.html#a0b1e435ecf4aaa93341250242dce611">doc</a>-&gt;<a class="code" href="class_c_new_vision_doc.html#5bb4bc2314ef496b221666b048ad51fe">doormodel</a>.<a class="code" href="class_door_model.html#1806d0f62b710ce4e0c0faa200447dee">m_doorType</a> == <a class="code" href="_door_model_8h.html#d93a841ae8f4efa651104ac49037c3f953f8fbea03df3497390ed258e5ed3afc">DOORS_INTEREST_REGION</a> || <a class="code" href="class_model.html#a0b1e435ecf4aaa93341250242dce611">doc</a>-&gt;<a class="code" href="class_c_new_vision_doc.html#5bb4bc2314ef496b221666b048ad51fe">doormodel</a>.<a class="code" href="class_door_model.html#1806d0f62b710ce4e0c0faa200447dee">m_doorType</a> == <a class="code" href="_door_model_8h.html#d93a841ae8f4efa651104ac49037c3f96d59b6e631d290bbaa7c6789677ed1e0">DOORS_INTEREST_BOUNDARY</a>)
<a name="l00215"></a>00215                 <a class="code" href="class_body_model.html#52be0310149d582144ace86ac35de3d3">RemoveOutsiders</a>(<a class="code" href="class_body_model.html#0e5edd4f262774e6b0885f5dd2534099">body</a>);
<a name="l00216"></a>00216 
<a name="l00217"></a>00217         <span class="comment">// create default candidate model </span>
<a name="l00218"></a>00218         <a class="code" href="class_body_map.html">BodyMap</a> accepted = body;
<a name="l00219"></a>00219 
<a name="l00220"></a>00220         <span class="comment">//for (POSITION pos = accepted.GetStartPosition();pos;) {</span>
<a name="l00221"></a>00221         <span class="comment">//      int i; Body *b;</span>
<a name="l00222"></a>00222         <span class="comment">//      accepted.GetNextAssoc(pos, i, b);</span>
<a name="l00223"></a>00223         <span class="comment">//      b-&gt;MoveTo(b-&gt;predicted);</span>
<a name="l00224"></a>00224         <span class="comment">//}</span>
<a name="l00225"></a>00225 
<a name="l00226"></a>00226         <span class="comment">//echo(String::Concat(__box(accepted[0]-&gt;bot.x), S", ", __box(accepted[0]-&gt;bot.y)));</span>
<a name="l00227"></a>00227         <span class="comment">// add a body to each completely unoccupied blob and reflect changes in Z-buffer</span>
<a name="l00228"></a>00228         <span class="comment">//NewForEachBlob(accepted);</span>
<a name="l00229"></a>00229         
<a name="l00230"></a>00230         <span class="comment">// sort bodies based on the camera proximity (depth) and update Z-buffer (do not include obstacles!)</span>
<a name="l00231"></a>00231         <a class="code" href="class_body_model.html#13b8a742cc6cf2a967c3114df879200a">UpdateZBuffer</a>(<a class="code" href="_globals_8cpp.html#b2ce9da27e1d5727e29e8ef30329a08d">body_zbuffer</a>, accepted, <a class="code" href="class_model.html#a0b1e435ecf4aaa93341250242dce611">doc</a>-&gt;<a class="code" href="class_c_new_vision_doc.html#41c0e2d5c878b813ee2307c44a94ad5d">obstaclemodel</a>.<a class="code" href="class_obstacle_model.html#9d858646602ea202584185b0a6de58b2">obstacle</a>, <a class="code" href="_body_model_8h.html#c60adcb1b450332fc494693b0cd63b33952cbe05cb7cd58d013504ff4c78006b">BODIES_MINUS_OBSTACLES</a>);
<a name="l00232"></a>00232 
<a name="l00233"></a>00233         <span class="comment">// compute default model likelihood</span>
<a name="l00234"></a>00234         <span class="keywordtype">double</span> p_accepted = <a class="code" href="class_body_model.html#af292d8bcfb3edb1e05157350e0c1eef">Prior</a>(accepted, body)*<a class="code" href="class_body_model.html#294b6f331d68d1fe2a447d532c25af74">Likelyhood</a>(accepted); 
<a name="l00235"></a>00235 
<a name="l00236"></a>00236         <span class="comment">// create proposed candidate model </span>
<a name="l00237"></a>00237         <a class="code" href="class_body_map.html">BodyMap</a> proposed = accepted;
<a name="l00238"></a>00238 
<a name="l00239"></a>00239         <span class="keywordtype">int</span> nFailedMutations = 0;
<a name="l00240"></a>00240         <span class="comment">// apply jump/diffusion dynamics to "shake" the candidate model</span>
<a name="l00241"></a>00241         <span class="keywordtype">int</span> last_id_before = <a class="code" href="class_body_model.html#4579ffa38bb9d8b281e1ec6498b73d98">last_id</a>;
<a name="l00242"></a>00242         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> nIter=0;nIter&lt;<a class="code" href="class_body_model.html#b52c5ab7fb67602d4247c2baa68881e6">m_iterations</a>+accepted.GetCount()*<a class="code" href="class_body_model.html#4b938f69d90a8b3f1feb4312d9a1f846">m_iterationsPerBody</a> &amp;&amp; nFailedMutations &lt; 10*<a class="code" href="class_body_model.html#b52c5ab7fb67602d4247c2baa68881e6">m_iterations</a>; nIter++) {
<a name="l00243"></a>00243                 <span class="keywordtype">int</span> choice = <a class="code" href="class_body_model.html#e4823328452c1b9683df20bb232ef465">GetRandomMutationNumber</a>();
<a name="l00244"></a>00244                 <span class="comment">//echo(String::Concat(S"choice=", choice));</span>
<a name="l00245"></a>00245                 <span class="keywordtype">bool</span> result = <span class="keyword">false</span>;
<a name="l00246"></a>00246                 <span class="keywordflow">switch</span> (choice) {
<a name="l00247"></a>00247                         <span class="keywordflow">case</span> <a class="code" href="_body_model_8h.html#697a4c7cf0c66a754b5b56271da61746485551336ce681a6b0276c72ed551ff9">M_DIFFUSE</a>: 
<a name="l00248"></a>00248                                 result = <a class="code" href="class_body_model.html#b4f7d8dc50331bd4fd652313ade39b40">MutateDiffuse</a>(proposed); 
<a name="l00249"></a>00249                                 <span class="keywordflow">break</span>;
<a name="l00250"></a>00250                         <span class="keywordflow">case</span> <a class="code" href="_body_model_8h.html#697a4c7cf0c66a754b5b56271da61746bab1d9d2c1a77a18fc6ae9032fd18057">M_MOVE</a>: 
<a name="l00251"></a>00251                                 result = <a class="code" href="class_body_model.html#d5be61ca71cecbadf6563c1399a8777b">MutateMove</a>(proposed); 
<a name="l00252"></a>00252                                 <span class="keywordflow">break</span>;
<a name="l00253"></a>00253                         <span class="keywordflow">case</span> <a class="code" href="_body_model_8h.html#697a4c7cf0c66a754b5b56271da6174681f24c8006fdabf9415d8cdfd7d6382e">M_EXCHANGE</a>:
<a name="l00254"></a>00254                                 result = <a class="code" href="class_body_model.html#4f1849b164d2fc3a8b8517f7d7fd6ca4">MutateExchange</a>(proposed); 
<a name="l00255"></a>00255                                 <span class="keywordflow">break</span>;
<a name="l00256"></a>00256                         <span class="keywordflow">case</span> <a class="code" href="_body_model_8h.html#697a4c7cf0c66a754b5b56271da617466585b74ed62814f2a7f5819fa840cf38">M_DELETE</a>: 
<a name="l00257"></a>00257                                 result = <a class="code" href="class_body_model.html#a4b3c17929794104c5056fa43de2e07e">MutateDelete</a>(proposed); 
<a name="l00258"></a>00258                                 <span class="keywordflow">break</span>;
<a name="l00259"></a>00259                         <span class="keywordflow">case</span> <a class="code" href="_body_model_8h.html#697a4c7cf0c66a754b5b56271da61746b015ea35463f41c032259cf8b3b0c941">M_NEW</a>: 
<a name="l00260"></a>00260                                 result = <a class="code" href="class_body_model.html#f0a7ac0a93d2b4571ebadc6928f36981">MutateNew</a>(proposed);
<a name="l00261"></a>00261                 }
<a name="l00262"></a>00262                 <span class="keywordflow">if</span> (!result) {
<a name="l00263"></a>00263                         nFailedMutations++;
<a name="l00264"></a>00264                         nIter--;
<a name="l00265"></a>00265                         <span class="keywordflow">continue</span>;
<a name="l00266"></a>00266                 }
<a name="l00267"></a>00267 
<a name="l00268"></a>00268                 <span class="comment">// sort proposed bodies based on the camera proximity (depth) and update Z-buffer (do not include obstacles!)</span>
<a name="l00269"></a>00269                 <a class="code" href="class_body_model.html#13b8a742cc6cf2a967c3114df879200a">UpdateZBuffer</a>(<a class="code" href="_globals_8cpp.html#b2ce9da27e1d5727e29e8ef30329a08d">body_zbuffer</a>, proposed, <a class="code" href="class_model.html#a0b1e435ecf4aaa93341250242dce611">doc</a>-&gt;<a class="code" href="class_c_new_vision_doc.html#41c0e2d5c878b813ee2307c44a94ad5d">obstaclemodel</a>.<a class="code" href="class_obstacle_model.html#9d858646602ea202584185b0a6de58b2">obstacle</a>, <a class="code" href="_body_model_8h.html#c60adcb1b450332fc494693b0cd63b33952cbe05cb7cd58d013504ff4c78006b">BODIES_MINUS_OBSTACLES</a>);
<a name="l00270"></a>00270 
<a name="l00271"></a>00271                 <span class="comment">// compute model likelihood</span>
<a name="l00272"></a>00272                 <span class="keywordtype">double</span> pr = this-&gt;<a class="code" href="class_body_model.html#af292d8bcfb3edb1e05157350e0c1eef">Prior</a>(proposed, body);
<a name="l00273"></a>00273                 <span class="keywordtype">double</span> li = this-&gt;<a class="code" href="class_body_model.html#294b6f331d68d1fe2a447d532c25af74">Likelyhood</a>(proposed);
<a name="l00274"></a>00274                 <span class="keywordtype">double</span> p_proposed = pr*li;
<a name="l00275"></a>00275 
<a name="l00276"></a>00276                 <span class="comment">// Metropolis-Hastings assuming symmetric transition probability density</span>
<a name="l00277"></a>00277                 
<a name="l00278"></a>00278                 <span class="comment">// probabilistically accept/reject the candidate model</span>
<a name="l00279"></a>00279                 <span class="keywordtype">double</span> pRandom = 2*<a class="code" href="class_body_model.html#5b6d92dd0ca75c739b9aef9b1f37d3fd">m_randomness</a>*cvRandReal(&amp;<a class="code" href="_globals_8cpp.html#ff39e3308132c1b3c9548c6bbdf21b55">rnd_seed</a>)-<a class="code" href="class_body_model.html#5b6d92dd0ca75c739b9aef9b1f37d3fd">m_randomness</a>;
<a name="l00280"></a>00280                 <span class="keywordflow">if</span> (p_proposed &gt; p_accepted) {
<a name="l00281"></a>00281                         accepted = proposed;
<a name="l00282"></a>00282                         <span class="comment">//echo(S" accepted $$$");</span>
<a name="l00283"></a>00283                         p_accepted = p_proposed;
<a name="l00284"></a>00284                 }
<a name="l00285"></a>00285                 <span class="keywordflow">else</span> {
<a name="l00286"></a>00286                         proposed = accepted;
<a name="l00287"></a>00287                         <a class="code" href="class_body_model.html#13b8a742cc6cf2a967c3114df879200a">UpdateZBuffer</a>(<a class="code" href="_globals_8cpp.html#b2ce9da27e1d5727e29e8ef30329a08d">body_zbuffer</a>, accepted, <a class="code" href="class_model.html#a0b1e435ecf4aaa93341250242dce611">doc</a>-&gt;<a class="code" href="class_c_new_vision_doc.html#41c0e2d5c878b813ee2307c44a94ad5d">obstaclemodel</a>.<a class="code" href="class_obstacle_model.html#9d858646602ea202584185b0a6de58b2">obstacle</a>, <a class="code" href="_body_model_8h.html#c60adcb1b450332fc494693b0cd63b33952cbe05cb7cd58d013504ff4c78006b">BODIES_MINUS_OBSTACLES</a>);
<a name="l00288"></a>00288                         <span class="comment">//echo(S" rejected ");</span>
<a name="l00289"></a>00289                 }
<a name="l00290"></a>00290         }
<a name="l00291"></a>00291         <span class="comment">// store accepted model as the current model</span>
<a name="l00292"></a>00292         <a class="code" href="class_body_model.html#a20ea9a9d9a24d4abacd274b62546dee">UpdateRecentlyDeleted</a>(accepted, body, <a class="code" href="class_body_model.html#e447fae9bacc236ad12a76435218136b">body_deleted</a>, (<span class="keywordtype">int</span>) <a class="code" href="class_model.html#a0b1e435ecf4aaa93341250242dce611">doc</a>-&gt;<a class="code" href="class_c_new_vision_doc.html#70b31043294312993af8798f877550fe">trackermodel</a>.<a class="code" href="class_sequence_processor.html#73f2908199084c1045c3d1ee3d99533e">m_frameNumber</a>);
<a name="l00293"></a>00293         <a class="code" href="class_body_model.html#47cdf41878c9e27d30df051a57b6db2e">ReplaceNewWithRecentlyDeleted</a>(accepted, body, <a class="code" href="class_body_model.html#e447fae9bacc236ad12a76435218136b">body_deleted</a>, <a class="code" href="class_body_model.html#c3049adcfd98c1dba3cb71043ddc9374">m_maxDeletedAge</a>, <a class="code" href="class_body_model.html#4adb12a8687e0913fa2fde8821abe475">m_maxDeletedDist</a>);
<a name="l00294"></a>00294         body = accepted;
<a name="l00295"></a>00295         <span class="comment">//echo(String::Concat("FG = ", pfg, " BG = ", pbg));</span>
<a name="l00296"></a>00296         <a class="code" href="class_body_model.html#f3f667f85641428749555986a9213ef4">ReorderIDs</a>(last_id_before, body);
<a name="l00297"></a>00297         proposed.<a class="code" href="class_body_map.html#569432be624023562a6d52797505617c">RemoveAll</a>();
<a name="l00298"></a>00298         accepted.<a class="code" href="class_body_map.html#569432be624023562a6d52797505617c">RemoveAll</a>();
<a name="l00299"></a>00299 }
<a name="l00300"></a>00300 <span class="comment">// --------------------------------------------------------------------------</span>
<a name="l00301"></a><a class="code" href="class_body_model.html#af292d8bcfb3edb1e05157350e0c1eef">00301</a> <span class="keywordtype">double</span> <a class="code" href="class_body_model.html#af292d8bcfb3edb1e05157350e0c1eef">BodyModel::Prior</a>(<a class="code" href="class_body_map.html">BodyMap</a>&amp; arrCurr, <a class="code" href="class_body_map.html">BodyMap</a>&amp; arrPrev) {
<a name="l00302"></a>00302         <span class="keywordtype">double</span> pModel= 1;
<a name="l00303"></a>00303 
<a name="l00304"></a>00304         <span class="keywordtype">double</span> allpixels = <a class="code" href="class_model.html#a0b1e435ecf4aaa93341250242dce611">doc</a>-&gt;<a class="code" href="class_c_new_vision_doc.html#e21c04f1c508fb2ae7ac1fc9c433d854">cameramodel</a>.<a class="code" href="class_camera_model.html#24fc2915f3b445ea9cf592480b03b631">w</a>*<a class="code" href="class_model.html#a0b1e435ecf4aaa93341250242dce611">doc</a>-&gt;<a class="code" href="class_c_new_vision_doc.html#e21c04f1c508fb2ae7ac1fc9c433d854">cameramodel</a>.<a class="code" href="class_camera_model.html#d561ff14d4687d142757026dc0a4ff9a">h</a>;       
<a name="l00305"></a>00305 
<a name="l00306"></a>00306         POSITION pos = arrCurr.GetStartPosition();
<a name="l00307"></a>00307         <span class="keywordflow">while</span> (pos) {
<a name="l00308"></a>00308                 <span class="keywordtype">int</span> i; <a class="code" href="class_body.html">Body</a> *b;
<a name="l00309"></a>00309                 arrCurr.GetNextAssoc(pos, i, b);
<a name="l00310"></a>00310                 <span class="keywordtype">double</span> p = 1; <span class="comment">// prior on the body parameters</span>
<a name="l00311"></a>00311 
<a name="l00312"></a>00312                 <span class="comment">// disallow the out of bounds bodies!</span>
<a name="l00313"></a>00313                 CvRect area = cvRect(0,0,<a class="code" href="class_model.html#a0b1e435ecf4aaa93341250242dce611">doc</a>-&gt;<a class="code" href="class_c_new_vision_doc.html#e21c04f1c508fb2ae7ac1fc9c433d854">cameramodel</a>.<a class="code" href="class_camera_model.html#24fc2915f3b445ea9cf592480b03b631">w</a>, <a class="code" href="class_model.html#a0b1e435ecf4aaa93341250242dce611">doc</a>-&gt;<a class="code" href="class_c_new_vision_doc.html#e21c04f1c508fb2ae7ac1fc9c433d854">cameramodel</a>.<a class="code" href="class_camera_model.html#d561ff14d4687d142757026dc0a4ff9a">h</a>);
<a name="l00314"></a>00314                 <span class="keywordflow">if</span> (<a class="code" href="class_model.html#a0b1e435ecf4aaa93341250242dce611">doc</a>-&gt;<a class="code" href="class_c_new_vision_doc.html#e21c04f1c508fb2ae7ac1fc9c433d854">cameramodel</a>.<a class="code" href="class_camera_model.html#4f880809688deb332b8f28ee9074fc58">m_cameraType</a> == <a class="code" href="_camera_model_8h.html#e27786af5883fda851579f95897d5b80295dc00dd5da0bca4ed9f724c3cb3904">PROJECTION</a> &amp;&amp; !<a class="code" href="_globals_8cpp.html#2ea75df9f3a700de6a687036365547c5">cvPointInRect</a>(cvPointFrom32f(b-&gt;<a class="code" href="class_body.html#9a033ed2a2e2ab5496db5880203d0086">GetImageHead</a>()), area) 
<a name="l00315"></a>00315                         &amp;&amp; !<a class="code" href="_globals_8cpp.html#2ea75df9f3a700de6a687036365547c5">cvPointInRect</a>(cvPointFrom32f(b-&gt;<a class="code" href="class_body.html#9c3502d08c2544ffbce16ef10623d96f">GetImageFoot</a>()), area)  
<a name="l00316"></a>00316                         &amp;&amp; !<a class="code" href="_globals_8cpp.html#2ea75df9f3a700de6a687036365547c5">cvPointInRect</a>(cvPointFrom32f(b-&gt;<a class="code" href="class_body.html#e1cd7330e840283c6f844d913fe36a8a">GetImageCenter</a>()), area))
<a name="l00317"></a>00317                         p *= 0;
<a name="l00318"></a>00318                 p *= <a class="code" href="_globals_8cpp.html#5acd70952f66dcca8c6911300993b8b7">probNormalTruncated</a>(b-&gt;<a class="code" href="class_body.html#ccff71df59f80796ea8689922d9e5293">GetWidth</a>(), <a class="code" href="class_body_model.html#7bfd76f4f62d4fe17f22a47bbce1398b">m_widthM</a>, <a class="code" href="class_body_model.html#3758bc4a76c8468147a59d34411149c5">m_widthS</a>, <a class="code" href="class_body_model.html#8e3fb02f98e78c27d32f0d2026c17b8d">m_minWidth</a>, <a class="code" href="class_body_model.html#d5314dca93703c391e7f7a7f2ea30b2d">m_maxWidth</a>, <a class="code" href="class_body_model.html#26dafd4994f4fc5a008cb6c16a385732">p_abnormalW</a>);
<a name="l00319"></a>00319                 p *= <a class="code" href="_globals_8cpp.html#5acd70952f66dcca8c6911300993b8b7">probNormalTruncated</a>(b-&gt;<a class="code" href="class_body.html#e4be36d4e8bf7aadd14cdebd64748f15">GetHeight</a>(), <a class="code" href="class_body_model.html#708f4dfdbd4a4312c25ba50139e14519">m_heightM</a>, <a class="code" href="class_body_model.html#182bda8077930a11522a789c888831a6">m_heightS</a>, <a class="code" href="class_body_model.html#0b769b31129cc1ba2913e7d98311b95b">m_minHeight</a>, <a class="code" href="class_body_model.html#bdc933dad73a4199283bea837b8c7199">m_maxHeight</a>, <a class="code" href="class_body_model.html#51a970d5308b5e546e81b725439122ca">p_abnormalH</a>);
<a name="l00320"></a>00320 
<a name="l00321"></a>00321                 <span class="comment">// punish for overlaps with the obstacles </span>
<a name="l00322"></a>00322                 <span class="keywordflow">if</span> (<a class="code" href="class_model.html#a0b1e435ecf4aaa93341250242dce611">doc</a>-&gt;<a class="code" href="class_c_new_vision_doc.html#121d68f1d0d7ec86f11855c6bcc986c1">floormodel</a>.<a class="code" href="class_floor_model.html#a292ba8f519557b05a92e8d54c01f0ee">InBounds</a>(b-&gt;<a class="code" href="class_body.html#d85d03af61dd70805fef5d88e40c28be">bot</a>)) {
<a name="l00323"></a>00323                         CvPoint f_bot = <a class="code" href="class_model.html#a0b1e435ecf4aaa93341250242dce611">doc</a>-&gt;<a class="code" href="class_c_new_vision_doc.html#121d68f1d0d7ec86f11855c6bcc986c1">floormodel</a>.<a class="code" href="class_floor_model.html#eb4b7e6af3a29c25419f3bf8ce9f401f">coordsReal2Floor</a>(b-&gt;<a class="code" href="class_body.html#d85d03af61dd70805fef5d88e40c28be">bot</a>);
<a name="l00324"></a>00324                         <span class="keywordflow">if</span> ((byte)<a class="code" href="_globals_8cpp.html#265f52600f6ef779ee93cbcac470a9fa">fbuffer</a>-&gt;imageData[f_bot.y*<a class="code" href="_globals_8cpp.html#265f52600f6ef779ee93cbcac470a9fa">fbuffer</a>-&gt;widthStep+f_bot.x] == 1)
<a name="l00325"></a>00325                                 p *= exp(-<a class="code" href="class_body_model.html#dffcb98b1ff90d1d5e609b63fafe046c">p_ObstacleOverlap</a>);
<a name="l00326"></a>00326                 }
<a name="l00327"></a>00327 
<a name="l00328"></a>00328                 <span class="comment">// punish for overlaps with other bodies</span>
<a name="l00329"></a>00329                 POSITION pos2 = arrCurr.GetStartPosition();
<a name="l00330"></a>00330                 <span class="keywordflow">while</span> (pos2) {
<a name="l00331"></a>00331                         <span class="keywordtype">int</span> j; <a class="code" href="class_body.html">Body</a> *b2;
<a name="l00332"></a>00332                         arrCurr.GetNextAssoc(pos2, j, b2);
<a name="l00333"></a>00333                         <span class="keywordflow">if</span> (j==i)
<a name="l00334"></a>00334                                 <span class="keywordflow">continue</span>;
<a name="l00335"></a>00335                         <span class="keywordtype">double</span> d_body = <a class="code" href="_globals_8cpp.html#bf519ca750c62a1ae41705179bf5ea92">d</a>(b-&gt;<a class="code" href="class_body.html#d85d03af61dd70805fef5d88e40c28be">bot</a>, b2-&gt;<a class="code" href="class_body.html#d85d03af61dd70805fef5d88e40c28be">bot</a>);
<a name="l00336"></a>00336                         <span class="keywordtype">double</span> d_norm = <a class="code" href="class_body_model.html#b7d139a1e0f2c67bf38501fe4bf53171">m_BodyMinDist</a>*(b-&gt;<a class="code" href="class_body.html#ccff71df59f80796ea8689922d9e5293">GetWidth</a>()+b2-&gt;<a class="code" href="class_body.html#ccff71df59f80796ea8689922d9e5293">GetWidth</a>());
<a name="l00337"></a>00337                         <span class="keywordflow">if</span> (d_body &lt; d_norm) {
<a name="l00338"></a>00338                                 <span class="keywordflow">if</span> (d_body == 0)
<a name="l00339"></a>00339                                         p = 0;
<a name="l00340"></a>00340                                 <span class="keywordflow">else</span>
<a name="l00341"></a>00341                                         p *= exp(-<a class="code" href="class_body_model.html#3d66c30734e4c6e7b6656d3635fad52a">p_BodyOverlap</a>*d_norm/d_body);
<a name="l00342"></a>00342                         }
<a name="l00343"></a>00343                 }
<a name="l00344"></a>00344 
<a name="l00345"></a>00345                 <span class="comment">// ------ Temporal priors ------</span>
<a name="l00346"></a>00346                 <a class="code" href="class_body.html">Body</a>* b_old;
<a name="l00347"></a>00347                 <span class="keywordflow">if</span> (arrPrev.Lookup(b-&gt;<a class="code" href="class_object3_d.html#0cfc2671e2a01bb06144e3fa88a01b0e">id</a>, b_old)) {
<a name="l00348"></a>00348                         <span class="comment">// === computation confidence depence on the age of the body (the duration of track)</span>
<a name="l00349"></a>00349                         <span class="keywordtype">int</span> age = (<span class="keywordtype">int</span>)<a class="code" href="class_model.html#a0b1e435ecf4aaa93341250242dce611">doc</a>-&gt;<a class="code" href="class_c_new_vision_doc.html#70b31043294312993af8798f877550fe">trackermodel</a>.<a class="code" href="class_sequence_processor.html#73f2908199084c1045c3d1ee3d99533e">m_frameNumber</a> - b-&gt;<a class="code" href="class_body.html#67575149655136ec93f0bbb6f1cc06fe">startFrame</a>;
<a name="l00350"></a>00350                         <span class="keywordtype">double</span> dCamera = b-&gt;<a class="code" href="class_body.html#c4ceba80e7bcfbed0e0cd2e3b166557d">GetDistanceFromCamera</a>();
<a name="l00351"></a>00351                         <span class="comment">//double confidence = (1-exp(-1.0*age/m_saturationTime));</span>
<a name="l00352"></a>00352                         <span class="keywordtype">double</span> confidence = 1;
<a name="l00353"></a>00353                         
<a name="l00354"></a>00354                         <span class="comment">// === distance from the Kalman predicted location</span>
<a name="l00355"></a>00355                         <span class="keywordtype">double</span> distDeviation = <a class="code" href="class_body_model.html#beeac7ca766acdb9d9f6e31d4abe0449">m_distanceConfidence</a>*(dCamera/<a class="code" href="class_model.html#a0b1e435ecf4aaa93341250242dce611">doc</a>-&gt;<a class="code" href="class_c_new_vision_doc.html#e21c04f1c508fb2ae7ac1fc9c433d854">cameramodel</a>.<a class="code" href="class_camera_model.html#d34fbb702d70e98d712320c633050aef">m_minBodyDistance</a>);
<a name="l00356"></a>00356                         <span class="keywordtype">double</span> pPosition = <a class="code" href="_globals_8cpp.html#5acd70952f66dcca8c6911300993b8b7">probNormalTruncated</a>(<a class="code" href="_globals_8cpp.html#bf519ca750c62a1ae41705179bf5ea92">d</a>(b_old-&gt;<a class="code" href="class_body.html#ba32bc46b856405a38019cfa9d272a7d">predicted</a>, b-&gt;<a class="code" href="class_body.html#d85d03af61dd70805fef5d88e40c28be">bot</a>), 0, distDeviation, 0, distDeviation, <a class="code" href="class_body_model.html#560094b71705de275f0803e1f8b71a50">p_distance</a>);
<a name="l00357"></a>00357                         <span class="comment">//double pPosition = probNormalTruncated(d(b_old-&gt;bot, b-&gt;bot), 0, distDeviation, 0, distDeviation, p_distance);</span>
<a name="l00358"></a>00358 
<a name="l00359"></a>00359                         <span class="comment">// === difference in width</span>
<a name="l00360"></a>00360                         <span class="keywordtype">double</span> pWidth = <a class="code" href="_globals_8cpp.html#5acd70952f66dcca8c6911300993b8b7">probNormalTruncated</a>(b-&gt;<a class="code" href="class_body.html#ccff71df59f80796ea8689922d9e5293">GetWidth</a>(), b_old-&gt;<a class="code" href="class_body.html#ccff71df59f80796ea8689922d9e5293">GetWidth</a>(), m_widthS, b_old-&gt;<a class="code" href="class_body.html#ccff71df59f80796ea8689922d9e5293">GetWidth</a>()-m_widthS, b_old-&gt;<a class="code" href="class_body.html#ccff71df59f80796ea8689922d9e5293">GetWidth</a>()+m_widthS, <a class="code" href="class_body_model.html#81d23d3d55b71509caf62d94f8539ce9">p_width</a>);
<a name="l00361"></a>00361 
<a name="l00362"></a>00362                         <span class="comment">// === difference in height</span>
<a name="l00363"></a>00363                         <span class="keywordtype">double</span> pHeight = <a class="code" href="_globals_8cpp.html#5acd70952f66dcca8c6911300993b8b7">probNormalTruncated</a>(b-&gt;<a class="code" href="class_body.html#e4be36d4e8bf7aadd14cdebd64748f15">GetHeight</a>(), b_old-&gt;<a class="code" href="class_body.html#e4be36d4e8bf7aadd14cdebd64748f15">GetHeight</a>(), m_heightS, b_old-&gt;<a class="code" href="class_body.html#e4be36d4e8bf7aadd14cdebd64748f15">GetHeight</a>()-m_heightS, b_old-&gt;<a class="code" href="class_body.html#e4be36d4e8bf7aadd14cdebd64748f15">GetHeight</a>()+m_heightS, <a class="code" href="class_body_model.html#c4546ff51030a9f5b040a0d08d2fe357">p_height</a>);
<a name="l00364"></a>00364 
<a name="l00365"></a>00365                         <span class="comment">// === distance from the color histogram </span>
<a name="l00366"></a>00366                         <a class="code" href="class_l_a_b_histogram2_d.html">LABHistogram2D</a> obsColor;
<a name="l00367"></a>00367                         b-&gt;<a class="code" href="class_body.html#206a4f56e136eeddad8f807bec554e3e">HistogramCompute</a>(<a class="code" href="_globals_8cpp.html#dcc8eea4165f02dc8d32606c13087c67">imgFrame</a>, obsColor.h, 0); <span class="comment">// NOTE: b_old-&gt;color is the same as b-&gt;color at this point</span>
<a name="l00368"></a>00368                         b-&gt;<a class="code" href="class_body.html#6e9090707df8e4a81a9568d6098c02bb">dHist</a> = obsColor.Compare(&amp;b_old-&gt;<a class="code" href="class_body.html#ce4ba608a78f6b9ccfe1ffada54c09da">color</a>);
<a name="l00369"></a>00369                         <span class="keywordtype">double</span> pColor = 1-<a class="code" href="class_body_model.html#d7286e3a801b18b98a5ff12a5d3e5e5e">p_color</a>*(1-b-&gt;<a class="code" href="class_body.html#6e9090707df8e4a81a9568d6098c02bb">dHist</a>); 
<a name="l00370"></a>00370                         
<a name="l00371"></a>00371                         <span class="comment">// === combine all priors</span>
<a name="l00372"></a>00372                         p = p*(1-confidence)*1+ p*confidence
<a name="l00373"></a>00373                                 * pPosition
<a name="l00374"></a>00374                                 * pWidth
<a name="l00375"></a>00375                                 * pHeight
<a name="l00376"></a>00376                                 * pColor;
<a name="l00377"></a>00377                 }
<a name="l00378"></a>00378                 <span class="keywordflow">else</span> { 
<a name="l00379"></a>00379                         <span class="comment">// penalty for inserting a body </span>
<a name="l00380"></a>00380                         <span class="keywordtype">double</span> dDoor = <a class="code" href="class_model.html#a0b1e435ecf4aaa93341250242dce611">doc</a>-&gt;<a class="code" href="class_c_new_vision_doc.html#5bb4bc2314ef496b221666b048ad51fe">doormodel</a>.<a class="code" href="class_door_model.html#01918fde52a1a87ffffc88ddb8d767ae">GetDistanceFromClosestDoor</a>(b-&gt;<a class="code" href="class_body.html#d85d03af61dd70805fef5d88e40c28be">bot</a>);
<a name="l00381"></a>00381                         <span class="keywordtype">double</span> pDoor = <a class="code" href="_globals_8cpp.html#5acd70952f66dcca8c6911300993b8b7">probNormalTruncated</a>(dDoor, 0, <a class="code" href="class_body_model.html#e21563e6c78d686f72ad50d47ecac2f4">m_maxDoorDistance</a>, 0, <a class="code" href="class_body_model.html#e21563e6c78d686f72ad50d47ecac2f4">m_maxDoorDistance</a>, <a class="code" href="class_body_model.html#50dfb7a6e295ecf74bec3d88ba4b8a7a">p_new</a>);
<a name="l00382"></a>00382                         p *= pDoor;
<a name="l00383"></a>00383                 }
<a name="l00384"></a>00384                 b-&gt;<a class="code" href="class_body.html#6e9090707df8e4a81a9568d6098c02bb">dHist</a> = p;
<a name="l00385"></a>00385                 b-&gt;<a class="code" href="class_body.html#1a11c89bf54f924c79959df6992ea70f">confidence</a> = p;
<a name="l00386"></a>00386                 pModel *= p;
<a name="l00387"></a>00387         }
<a name="l00388"></a>00388         
<a name="l00389"></a>00389         <span class="comment">// penalty for deleting bodies</span>
<a name="l00390"></a>00390         pos = arrPrev.GetStartPosition();
<a name="l00391"></a>00391         <span class="keywordflow">while</span> (pos) {
<a name="l00392"></a>00392                 <span class="keywordtype">int</span> i; <a class="code" href="class_body.html">Body</a> *b;
<a name="l00393"></a>00393                 arrPrev.GetNextAssoc(pos, i, b);
<a name="l00394"></a>00394                 <a class="code" href="class_body.html">Body</a>* b_new;
<a name="l00395"></a>00395                 <span class="keywordflow">if</span> (!arrCurr.Lookup(b-&gt;<a class="code" href="class_object3_d.html#0cfc2671e2a01bb06144e3fa88a01b0e">id</a>, b_new)) {
<a name="l00396"></a>00396                         <span class="keywordtype">double</span> dDoor = <a class="code" href="class_model.html#a0b1e435ecf4aaa93341250242dce611">doc</a>-&gt;<a class="code" href="class_c_new_vision_doc.html#5bb4bc2314ef496b221666b048ad51fe">doormodel</a>.<a class="code" href="class_door_model.html#01918fde52a1a87ffffc88ddb8d767ae">GetDistanceFromClosestDoor</a>(b-&gt;<a class="code" href="class_body.html#d85d03af61dd70805fef5d88e40c28be">bot</a>);
<a name="l00397"></a>00397                         <span class="keywordtype">double</span> p = <a class="code" href="_globals_8cpp.html#5acd70952f66dcca8c6911300993b8b7">probNormalTruncated</a>(dDoor, 0, <a class="code" href="class_body_model.html#e21563e6c78d686f72ad50d47ecac2f4">m_maxDoorDistance</a>, 0, <a class="code" href="class_body_model.html#e21563e6c78d686f72ad50d47ecac2f4">m_maxDoorDistance</a>, <a class="code" href="class_body_model.html#8198d62a96e248fa01abec0e47cd0545">p_delete</a>);
<a name="l00398"></a>00398                         pModel *= p;
<a name="l00399"></a>00399                 }
<a name="l00400"></a>00400         }
<a name="l00401"></a>00401 
<a name="l00402"></a>00402         <span class="comment">// punish for excessive number of bodies</span>
<a name="l00403"></a>00403         pModel *= exp(-<a class="code" href="class_body_model.html#5928246a8cde6dd1fddbe6c35c8b24af">p_number</a>*(<span class="keywordtype">double</span>)arrCurr.GetCount());
<a name="l00404"></a>00404 
<a name="l00405"></a>00405         <span class="keywordflow">return</span> pModel;
<a name="l00406"></a>00406 }
<a name="l00407"></a>00407 <span class="comment">// --------------------------------------------------------------------------</span>
<a name="l00408"></a><a class="code" href="class_body_model.html#294b6f331d68d1fe2a447d532c25af74">00408</a> <span class="keywordtype">double</span> <a class="code" href="class_body_model.html#294b6f331d68d1fe2a447d532c25af74">BodyModel::Likelyhood</a>(<a class="code" href="class_body_map.html">BodyMap</a>&amp; bmap) {
<a name="l00409"></a>00409         <span class="comment">// See "Tracking Multiple Humans in Crowded Environment" by Zhao, Tao and Nevatia, Ram</span>
<a name="l00410"></a>00410         <span class="comment">// account for the fact that objects closer to the camera use up more pixels</span>
<a name="l00411"></a>00411         <span class="comment">// BEWARE DIVISION BY ZERO</span>
<a name="l00412"></a>00412         <span class="comment">// compute over- and under-coverage</span>
<a name="l00413"></a>00413         <span class="keywordtype">double</span> PBG = 0, PFG = 0;
<a name="l00414"></a>00414         
<a name="l00415"></a>00415         <span class="keywordtype">double</span> allpixels = <a class="code" href="class_model.html#a0b1e435ecf4aaa93341250242dce611">doc</a>-&gt;<a class="code" href="class_c_new_vision_doc.html#e21c04f1c508fb2ae7ac1fc9c433d854">cameramodel</a>.<a class="code" href="class_camera_model.html#24fc2915f3b445ea9cf592480b03b631">w</a>*<a class="code" href="class_model.html#a0b1e435ecf4aaa93341250242dce611">doc</a>-&gt;<a class="code" href="class_c_new_vision_doc.html#e21c04f1c508fb2ae7ac1fc9c433d854">cameramodel</a>.<a class="code" href="class_camera_model.html#d561ff14d4687d142757026dc0a4ff9a">h</a>;
<a name="l00416"></a>00416 
<a name="l00417"></a>00417         cvConvert(<a class="code" href="_globals_8cpp.html#96e982ff176958ec197a50586ee65368">fg</a>, <a class="code" href="_globals_8cpp.html#a9f64915905aa5943f6805b0a290b0da">temp32</a>);
<a name="l00418"></a>00418         cvMul(<a class="code" href="_globals_8cpp.html#a9f64915905aa5943f6805b0a290b0da">temp32</a>, <a class="code" href="_globals_8cpp.html#0c575e5a96aee255ada87d30446af873">distance_mask</a>, <a class="code" href="_globals_8cpp.html#a9f64915905aa5943f6805b0a290b0da">temp32</a>, 1.0/<a class="code" href="class_model.html#a0b1e435ecf4aaa93341250242dce611">doc</a>-&gt;<a class="code" href="class_c_new_vision_doc.html#e21c04f1c508fb2ae7ac1fc9c433d854">cameramodel</a>.<a class="code" href="class_camera_model.html#d34fbb702d70e98d712320c633050aef">m_minBodyDistance</a>);
<a name="l00419"></a>00419         <span class="keywordtype">double</span> blobpixels = cvSum(<a class="code" href="_globals_8cpp.html#a9f64915905aa5943f6805b0a290b0da">temp32</a>).val[0];
<a name="l00420"></a>00420         <span class="keywordflow">if</span> (blobpixels &gt; 0) {
<a name="l00421"></a>00421                 cvThreshold(<a class="code" href="_globals_8cpp.html#b2ce9da27e1d5727e29e8ef30329a08d">body_zbuffer</a>, <a class="code" href="_globals_8cpp.html#4e26626ca1309461c668a7b28787dc5f">blob_mask</a>, 0, 1, CV_THRESH_BINARY_INV);
<a name="l00422"></a>00422                 cvConvert(<a class="code" href="_globals_8cpp.html#4e26626ca1309461c668a7b28787dc5f">blob_mask</a>, <a class="code" href="_globals_8cpp.html#1e3fbd95634d139089c0708491488f3f">FGMapDouble</a>);
<a name="l00423"></a>00423                 cvMul(<a class="code" href="_globals_8cpp.html#a9f64915905aa5943f6805b0a290b0da">temp32</a>, <a class="code" href="_globals_8cpp.html#1e3fbd95634d139089c0708491488f3f">FGMapDouble</a>, <a class="code" href="_globals_8cpp.html#b5812ee44d5a60a3a859201f2647d7ec">ibg</a>);        
<a name="l00424"></a>00424                 PBG = cvSum(<a class="code" href="_globals_8cpp.html#b5812ee44d5a60a3a859201f2647d7ec">ibg</a>).val[0]/blobpixels;
<a name="l00425"></a>00425         }
<a name="l00426"></a>00426         
<a name="l00427"></a>00427         cvConvert(<a class="code" href="_globals_8cpp.html#7fa38479663d065faad9145a4017f930">bg</a>, <a class="code" href="_globals_8cpp.html#a9f64915905aa5943f6805b0a290b0da">temp32</a>);
<a name="l00428"></a>00428         cvMul(<a class="code" href="_globals_8cpp.html#a9f64915905aa5943f6805b0a290b0da">temp32</a>, <a class="code" href="_globals_8cpp.html#0c575e5a96aee255ada87d30446af873">distance_mask</a>, <a class="code" href="_globals_8cpp.html#a9f64915905aa5943f6805b0a290b0da">temp32</a>, 1.0/<a class="code" href="class_model.html#a0b1e435ecf4aaa93341250242dce611">doc</a>-&gt;<a class="code" href="class_c_new_vision_doc.html#e21c04f1c508fb2ae7ac1fc9c433d854">cameramodel</a>.<a class="code" href="class_camera_model.html#d34fbb702d70e98d712320c633050aef">m_minBodyDistance</a>);
<a name="l00429"></a>00429         <span class="keywordtype">double</span> bodypixels = cvSum(<a class="code" href="_globals_8cpp.html#a9f64915905aa5943f6805b0a290b0da">temp32</a>).val[0];
<a name="l00430"></a>00430         <span class="keywordflow">if</span> (bodypixels &gt; 0) {
<a name="l00431"></a>00431                 cvThreshold(<a class="code" href="_globals_8cpp.html#b2ce9da27e1d5727e29e8ef30329a08d">body_zbuffer</a>, <a class="code" href="_globals_8cpp.html#b13f2b886610f4d3127d5d3903c06bd6">body_mask</a>, 0, 1, CV_THRESH_BINARY);
<a name="l00432"></a>00432                 cvConvert(<a class="code" href="_globals_8cpp.html#b13f2b886610f4d3127d5d3903c06bd6">body_mask</a>, <a class="code" href="_globals_8cpp.html#1e3fbd95634d139089c0708491488f3f">FGMapDouble</a>);
<a name="l00433"></a>00433                 cvMul(<a class="code" href="_globals_8cpp.html#a9f64915905aa5943f6805b0a290b0da">temp32</a>, <a class="code" href="_globals_8cpp.html#1e3fbd95634d139089c0708491488f3f">FGMapDouble</a>, <a class="code" href="_globals_8cpp.html#5f4f09b989fa2c50769ee80e11c1f343">ifg</a>);        
<a name="l00434"></a>00434                 PFG = cvSum(<a class="code" href="_globals_8cpp.html#5f4f09b989fa2c50769ee80e11c1f343">ifg</a>).val[0]/bodypixels;
<a name="l00435"></a>00435         }
<a name="l00436"></a>00436 
<a name="l00437"></a>00437         <a class="code" href="_body_model_8cpp.html#4bc20c4b453af1f7ee3d6f5bbfec0db0">pbg</a> = PBG;
<a name="l00438"></a>00438         <a class="code" href="_body_model_8cpp.html#2105f22be323790f006d0c12046611fc">pfg</a> = PFG;
<a name="l00439"></a>00439         <span class="comment">//doc-&gt;Message(String::Concat("FG = ", PFG, " BG = ", PBG));</span>
<a name="l00440"></a>00440         <span class="keywordflow">return</span> exp(-(<a class="code" href="class_body_model.html#1adbe03611490c33bc1083ccbe4709c4">p_background</a>*PBG+<a class="code" href="class_body_model.html#75e445381562ce45be78473dfdf3ce8d">p_foreground</a>*PFG));
<a name="l00441"></a>00441 }
<a name="l00442"></a>00442 <span class="comment">// --------------------------------------------------------------------------</span>
<a name="l00443"></a><a class="code" href="class_body_model.html#642cce8c22d19f02f400a2bdac787676">00443</a> <span class="keywordtype">void</span> <a class="code" href="class_body_model.html#642cce8c22d19f02f400a2bdac787676">BodyModel::RasterizeFrame</a>(IplImage* frame, CvScalar color) {
<a name="l00444"></a>00444         POSITION pos = <a class="code" href="class_body_model.html#0e5edd4f262774e6b0885f5dd2534099">body</a>.GetStartPosition();
<a name="l00445"></a>00445         <span class="keywordflow">while</span> (pos) {
<a name="l00446"></a>00446                 <span class="keywordtype">int</span> i; <a class="code" href="class_body.html">Body</a> *b;
<a name="l00447"></a>00447                 <a class="code" href="class_body_model.html#0e5edd4f262774e6b0885f5dd2534099">body</a>.GetNextAssoc(pos, i, b);
<a name="l00448"></a>00448                 b-&gt;<a class="code" href="class_body.html#2a1301c3fd1fe2470938dabcf224a47a">RasterizeFrame</a>(frame, color);
<a name="l00449"></a>00449         }
<a name="l00450"></a>00450 }
<a name="l00451"></a>00451 <span class="comment">// --------------------------------------------------------------------------</span>
<a name="l00452"></a><a class="code" href="class_body_model.html#b3bdbe7106294cb6502e70ff8ef23ce1">00452</a> <span class="keywordtype">void</span> <a class="code" href="class_body_model.html#b3bdbe7106294cb6502e70ff8ef23ce1">BodyModel::RasterizeNonDormant</a>(IplImage* frame, CvScalar color) {
<a name="l00453"></a>00453         POSITION pos = <a class="code" href="class_body_model.html#0e5edd4f262774e6b0885f5dd2534099">body</a>.GetStartPosition();
<a name="l00454"></a>00454         <span class="keywordflow">while</span> (pos) {
<a name="l00455"></a>00455                 <span class="keywordtype">int</span> i; <a class="code" href="class_body.html">Body</a> *b;
<a name="l00456"></a>00456                 <a class="code" href="class_body_model.html#0e5edd4f262774e6b0885f5dd2534099">body</a>.GetNextAssoc(pos, i, b);
<a name="l00457"></a>00457                 <span class="keywordflow">if</span> (b-&gt;<a class="code" href="class_body.html#5b4aba6e881169f3e65811efe1112b02">dormantFor</a> &lt; <a class="code" href="class_body_model.html#c14df34175b3627c5784d6b7fe7013d2">m_dormantFor</a>/2)
<a name="l00458"></a>00458                         b-&gt;<a class="code" href="class_body.html#2a1301c3fd1fe2470938dabcf224a47a">RasterizeFrame</a>(frame, color);
<a name="l00459"></a>00459         }
<a name="l00460"></a>00460 }
<a name="l00461"></a>00461 <span class="comment">// --------------------------------------------------------------------------</span>
<a name="l00462"></a><a class="code" href="class_body_model.html#62daa0d539cf45d2e9bfa053d6cfa163">00462</a> <span class="keywordtype">void</span> <a class="code" href="class_body_model.html#62daa0d539cf45d2e9bfa053d6cfa163">BodyModel::RasterizeFloor</a>(IplImage* frame, CvScalar color) {
<a name="l00463"></a>00463         POSITION pos = <a class="code" href="class_body_model.html#0e5edd4f262774e6b0885f5dd2534099">body</a>.GetStartPosition();
<a name="l00464"></a>00464         <span class="keywordflow">while</span> (pos) {
<a name="l00465"></a>00465                 <span class="keywordtype">int</span> i; <a class="code" href="class_body.html">Body</a> *b;
<a name="l00466"></a>00466                 <a class="code" href="class_body_model.html#0e5edd4f262774e6b0885f5dd2534099">body</a>.GetNextAssoc(pos, i, b);
<a name="l00467"></a>00467                 b-&gt;<a class="code" href="class_body.html#668de1bd62956cbb2c1fdff32c7c4a31">RasterizeFloor</a>(frame, color);
<a name="l00468"></a>00468         }
<a name="l00469"></a>00469 }
<a name="l00470"></a>00470 <span class="comment">// --------------------------------------------------------------------------</span>
<a name="l00471"></a><a class="code" href="class_body_model.html#84287ac8bb40279ccdaef8473ce39588">00471</a> <span class="keywordtype">void</span> <a class="code" href="class_body_model.html#84287ac8bb40279ccdaef8473ce39588">BodyModel::DrawFrame</a>(IplImage* frame, CvScalar color) {
<a name="l00472"></a>00472         POSITION pos = <a class="code" href="class_body_model.html#0e5edd4f262774e6b0885f5dd2534099">body</a>.GetStartPosition();
<a name="l00473"></a>00473         <span class="keywordflow">while</span> (pos) {
<a name="l00474"></a>00474                 <span class="keywordtype">int</span> i; <a class="code" href="class_body.html">Body</a> *b;
<a name="l00475"></a>00475                 <a class="code" href="class_body_model.html#0e5edd4f262774e6b0885f5dd2534099">body</a>.GetNextAssoc(pos, i, b);
<a name="l00476"></a>00476                 <span class="comment">// set the color to RED for bodies outside the interest region</span>
<a name="l00477"></a>00477                 CvPoint2D32f foot = b-&gt;<a class="code" href="class_body.html#9c3502d08c2544ffbce16ef10623d96f">GetImageFoot</a>();
<a name="l00478"></a>00478                 <span class="keywordflow">if</span> (!<a class="code" href="class_model.html#a0b1e435ecf4aaa93341250242dce611">doc</a>-&gt;<a class="code" href="class_c_new_vision_doc.html#5bb4bc2314ef496b221666b048ad51fe">doormodel</a>.<a class="code" href="class_door_model.html#808f4b1639b6972438d3db90298e4545">IsInsideInterestRegion</a>(foot))
<a name="l00479"></a>00479                         b-&gt;<a class="code" href="class_body.html#0359bb1d477356a61e223d14ecc06959">DrawFrame</a>(frame, CV_RGB(255, 0, 0));
<a name="l00480"></a>00480                 <span class="keywordflow">else</span> 
<a name="l00481"></a>00481                         b-&gt;<a class="code" href="class_body.html#0359bb1d477356a61e223d14ecc06959">DrawFrame</a>(frame, color);
<a name="l00482"></a>00482         }
<a name="l00483"></a>00483 }
<a name="l00484"></a>00484 <span class="comment">// --------------------------------------------------------------------------</span>
<a name="l00485"></a><a class="code" href="class_body_model.html#7238ff80cf1b469ff78349aa8dce7b7d">00485</a> <span class="keywordtype">void</span> <a class="code" href="class_body_model.html#84287ac8bb40279ccdaef8473ce39588">BodyModel::DrawFrame</a>( CDC* pDC , <span class="keywordtype">int</span> ox, <span class="keywordtype">int</span> oy, CPen* pen )
<a name="l00486"></a>00486 {
<a name="l00487"></a>00487         CPen *penRed = <span class="keyword">new</span> CPen(PS_SOLID, 1, RGB(255,0,0));
<a name="l00488"></a>00488         POSITION pos = <a class="code" href="class_body_model.html#0e5edd4f262774e6b0885f5dd2534099">body</a>.GetStartPosition();
<a name="l00489"></a>00489         <span class="keywordflow">while</span> (pos) {
<a name="l00490"></a>00490                 <span class="keywordtype">int</span> i; <a class="code" href="class_body.html">Body</a> *b;
<a name="l00491"></a>00491                 <a class="code" href="class_body_model.html#0e5edd4f262774e6b0885f5dd2534099">body</a>.GetNextAssoc(pos, i, b);
<a name="l00492"></a>00492                 <span class="comment">// set the color to RED for bodies outside the interest region</span>
<a name="l00493"></a>00493                 CvPoint2D32f foot = b-&gt;<a class="code" href="class_body.html#9c3502d08c2544ffbce16ef10623d96f">GetImageFoot</a>();
<a name="l00494"></a>00494                 <span class="keywordflow">if</span> (!<a class="code" href="class_model.html#a0b1e435ecf4aaa93341250242dce611">doc</a>-&gt;<a class="code" href="class_c_new_vision_doc.html#5bb4bc2314ef496b221666b048ad51fe">doormodel</a>.<a class="code" href="class_door_model.html#808f4b1639b6972438d3db90298e4545">IsInsideInterestRegion</a>(foot))
<a name="l00495"></a>00495                         b-&gt;<a class="code" href="class_body.html#0359bb1d477356a61e223d14ecc06959">DrawFrame</a>(pDC, ox, oy, penRed);
<a name="l00496"></a>00496                 <span class="keywordflow">else</span> 
<a name="l00497"></a>00497                         b-&gt;<a class="code" href="class_body.html#0359bb1d477356a61e223d14ecc06959">DrawFrame</a>(pDC, ox, oy, pen);
<a name="l00498"></a>00498         }
<a name="l00499"></a>00499         <span class="keyword">delete</span> penRed;
<a name="l00500"></a>00500 }
<a name="l00501"></a>00501 <span class="comment">// --------------------------------------------------------------------------</span>
<a name="l00502"></a><a class="code" href="class_body_model.html#d3f889aad3c9794dda4cf6da994cee88">00502</a> <span class="keywordtype">void</span> <a class="code" href="class_body_model.html#d3f889aad3c9794dda4cf6da994cee88">BodyModel::DrawColorizingConfidence</a>(IplImage* frame, CvScalar colorYes, CvScalar colorNo) {
<a name="l00503"></a>00503         <span class="keywordtype">double</span> CONFIDENCE_SHIFT = 0.9;
<a name="l00504"></a>00504         <span class="keywordtype">double</span> CONFIDENCE_STRETCH = 1.0/(1-CONFIDENCE_SHIFT);
<a name="l00505"></a>00505         POSITION pos = <a class="code" href="class_body_model.html#0e5edd4f262774e6b0885f5dd2534099">body</a>.GetStartPosition();
<a name="l00506"></a>00506         <span class="keywordflow">while</span> (pos) {
<a name="l00507"></a>00507                 <span class="keywordtype">int</span> i; <a class="code" href="class_body.html">Body</a> *b;
<a name="l00508"></a>00508                 <a class="code" href="class_body_model.html#0e5edd4f262774e6b0885f5dd2534099">body</a>.GetNextAssoc(pos, i, b);
<a name="l00509"></a>00509                 <span class="comment">// set the color to colorNo for bodies with confidence=0</span>
<a name="l00510"></a>00510                 <a class="code" href="class_body_path.html">BodyPath</a> *bp;
<a name="l00511"></a>00511                 <span class="keywordflow">if</span> (<a class="code" href="class_model.html#a0b1e435ecf4aaa93341250242dce611">doc</a>-&gt;<a class="code" href="class_c_new_vision_doc.html#d3222dcea9c548810d510aff46b91680">m_TrackingData</a>.<a class="code" href="class_tracking_data.html#46c8b1b37d0e50a56fda29ed7ceefa70">data</a>.Lookup(b-&gt;<a class="code" href="class_object3_d.html#0cfc2671e2a01bb06144e3fa88a01b0e">id</a>, bp)) {
<a name="l00512"></a>00512                         <span class="keywordtype">double</span> confidence = bp-&gt;<a class="code" href="class_body_path.html#2f1a9d8c22d4ed53f3cb2857d9a4a7c0">isManual</a> ? bp-&gt;<a class="code" href="class_body_path.html#60c49b1499d8609873c54f4c79a79b51">manualConfidence</a> : bp-&gt;<a class="code" href="class_body_path.html#7e397e6100e98f78e49cb2705053dad8">autoConfidence</a>;
<a name="l00513"></a>00513                         <span class="keywordtype">double</span> c = (confidence-CONFIDENCE_SHIFT)*CONFIDENCE_STRETCH;
<a name="l00514"></a>00514                         CvScalar color, colorFG = CV_RGB(255,0,0), colorBG = CV_RGB(255,255,255);
<a name="l00515"></a>00515                         <span class="keywordflow">if</span> (confidence == 0) {
<a name="l00516"></a>00516                                 color = CV_RGB(0,0,255);
<a name="l00517"></a>00517                                 <span class="keywordflow">if</span> (bp-&gt;<a class="code" href="class_body_path.html#2f1a9d8c22d4ed53f3cb2857d9a4a7c0">isManual</a>) {
<a name="l00518"></a>00518                                         colorFG = CV_RGB(255,0,0); colorBG = CV_RGB(64,0,0);
<a name="l00519"></a>00519                                 }
<a name="l00520"></a>00520 
<a name="l00521"></a>00521                         }
<a name="l00522"></a>00522                         <span class="keywordflow">else</span>
<a name="l00523"></a>00523                                 color = CV_RGB(colorYes.val[2]*c+colorNo.val[2]*(1-c), 
<a name="l00524"></a>00524                                                                         colorYes.val[1]*c+colorNo.val[1]*(1-c), 
<a name="l00525"></a>00525                                                                         colorYes.val[0]*c+colorNo.val[0]*(1-c));
<a name="l00526"></a>00526                         b-&gt;<a class="code" href="class_body.html#345e31f940b0f58d726ff5a88a7f54e0">DrawFrameLabel</a>(frame, color, colorFG, colorBG);
<a name="l00527"></a>00527                 }
<a name="l00528"></a>00528         }
<a name="l00529"></a>00529 }
<a name="l00530"></a>00530 <span class="comment">// --------------------------------------------------------------------------</span>
<a name="l00531"></a><a class="code" href="class_body_model.html#6ef509dcfac1dea8420b036441f5c9b8">00531</a> <span class="keywordtype">void</span> <a class="code" href="class_body_model.html#6ef509dcfac1dea8420b036441f5c9b8">BodyModel::DrawFloor</a>(IplImage* frame, CvScalar color) {
<a name="l00532"></a>00532         POSITION pos = <a class="code" href="class_body_model.html#0e5edd4f262774e6b0885f5dd2534099">body</a>.GetStartPosition();
<a name="l00533"></a>00533         <span class="keywordflow">while</span> (pos) {
<a name="l00534"></a>00534                 <span class="keywordtype">int</span> i; <a class="code" href="class_body.html">Body</a> *b;
<a name="l00535"></a>00535                 <a class="code" href="class_body_model.html#0e5edd4f262774e6b0885f5dd2534099">body</a>.GetNextAssoc(pos, i, b);
<a name="l00536"></a>00536                 b-&gt;<a class="code" href="class_body.html#67e24f6f64f3f534536bb6f8eef049c0">DrawFloor</a>(frame, color);
<a name="l00537"></a>00537         }
<a name="l00538"></a>00538 }
<a name="l00539"></a>00539 <span class="comment">// --------------------------------------------------------------------------</span>
<a name="l00540"></a><a class="code" href="class_body_model.html#3900b6656065c20f124d8f865a855d9d">00540</a> <span class="keywordtype">void</span> <a class="code" href="class_body_model.html#3900b6656065c20f124d8f865a855d9d">BodyModel::DrawHeight</a>(IplImage* frame, CvScalar color) {
<a name="l00541"></a>00541         POSITION pos = <a class="code" href="class_body_model.html#0e5edd4f262774e6b0885f5dd2534099">body</a>.GetStartPosition();
<a name="l00542"></a>00542         <span class="keywordflow">while</span> (pos) {
<a name="l00543"></a>00543                 <span class="keywordtype">int</span> i; <a class="code" href="class_body.html">Body</a> *b;
<a name="l00544"></a>00544                 <a class="code" href="class_body_model.html#0e5edd4f262774e6b0885f5dd2534099">body</a>.GetNextAssoc(pos, i, b);
<a name="l00545"></a>00545                 b-&gt;<a class="code" href="class_body.html#6ab29ac0492f584817ae6cf9454b59c7">DrawHeight</a>(frame, color);
<a name="l00546"></a>00546         }
<a name="l00547"></a>00547 }
<a name="l00548"></a>00548 <span class="comment">// --------------------------------------------------------------------------</span>
<a name="l00549"></a><a class="code" href="class_body_model.html#fa2592853d05ca42bebaf3e65dd3baf0">00549</a> <span class="keywordtype">void</span> <a class="code" href="class_body_model.html#fa2592853d05ca42bebaf3e65dd3baf0">BodyModel::DrawGroups</a>(IplImage* frame, CvScalar color) {
<a name="l00551"></a>00551 
<a name="l00552"></a>00552         <span class="comment">//int RADIUS = 4;</span>
<a name="l00553"></a>00553         <span class="comment">//for (int i=0;i &lt; group.GetCount();i++) {</span>
<a name="l00554"></a>00554         <span class="comment">//      for (int n=0;n&lt;group[i]-&gt;GetCount();n++) {</span>
<a name="l00555"></a>00555         <span class="comment">//              Body* b = FindBodyMatch(doc-&gt;bodymodel.body, group[i]-&gt;GetAt(n));</span>
<a name="l00556"></a>00556         <span class="comment">//              if (!b)</span>
<a name="l00557"></a>00557         <span class="comment">//                      continue;</span>
<a name="l00558"></a>00558         <span class="comment">//              cvCircle(frame, cvPointFrom32f(b-&gt;GetImageCenter()), RADIUS, COLOR[group[i]-&gt;id], CV_FILLED, CV_AA);</span>
<a name="l00559"></a>00559         <span class="comment">//      }</span>
<a name="l00560"></a>00560         <span class="comment">//}</span>
<a name="l00561"></a>00561 }
<a name="l00562"></a>00562 <span class="comment">// --------------------------------------------------------------------------</span>
<a name="l00563"></a><a class="code" href="class_body_model.html#55ce537a62f2abef0e9a824544ece6b0">00563</a> <span class="keywordtype">void</span> <a class="code" href="class_body_model.html#55ce537a62f2abef0e9a824544ece6b0">BodyModel::DrawWeightMasks</a>(IplImage* frame) {
<a name="l00564"></a>00564         POSITION pos = <a class="code" href="class_body_model.html#0e5edd4f262774e6b0885f5dd2534099">body</a>.GetStartPosition();
<a name="l00565"></a>00565         <span class="keywordflow">while</span> (pos) {
<a name="l00566"></a>00566                 <span class="keywordtype">int</span> i; <a class="code" href="class_body.html">Body</a> *b;
<a name="l00567"></a>00567                 <a class="code" href="class_body_model.html#0e5edd4f262774e6b0885f5dd2534099">body</a>.GetNextAssoc(pos, i, b);
<a name="l00568"></a>00568                 b-&gt;<a class="code" href="class_body.html#49ac7ccf447fb08896d56da120a4f5e1">DrawWeightMask</a>(frame);
<a name="l00569"></a>00569         }
<a name="l00570"></a>00570 }
<a name="l00571"></a>00571 <span class="comment">// --------------------------------------------------------------------------</span>
<a name="l00572"></a><a class="code" href="class_body_model.html#d9214593f4a9a411d39b93f4044c5be2">00572</a> <span class="keywordtype">void</span> <a class="code" href="class_body_model.html#d9214593f4a9a411d39b93f4044c5be2">BodyModel::DrawZBuffer</a>(IplImage* frame) {
<a name="l00573"></a>00573         <span class="keywordtype">double</span> min_val, max_val;
<a name="l00574"></a>00574         cvMinMaxLoc(<a class="code" href="_globals_8cpp.html#b2ce9da27e1d5727e29e8ef30329a08d">body_zbuffer</a>, &amp;min_val, &amp;max_val);
<a name="l00575"></a>00575         cvScale(<a class="code" href="_globals_8cpp.html#b2ce9da27e1d5727e29e8ef30329a08d">body_zbuffer</a>, <a class="code" href="_globals_8cpp.html#4b2d4e55b64a28d4ac0b4e0a734d9f7a">temp</a>, 255.0/max_val);
<a name="l00576"></a>00576         cvCvtColor(<a class="code" href="_globals_8cpp.html#4b2d4e55b64a28d4ac0b4e0a734d9f7a">temp</a>, frame, CV_GRAY2RGB);
<a name="l00577"></a>00577 }
<a name="l00578"></a>00578 <span class="comment">// --------------------------------------------------------------------------</span>
<a name="l00579"></a><a class="code" href="class_body_model.html#ed703f88106d83ad472b27e2bc7ae42f">00579</a> <span class="keywordtype">void</span> <a class="code" href="class_body_model.html#ed703f88106d83ad472b27e2bc7ae42f">BodyModel::DrawHistograms</a>(IplImage* frame) {
<a name="l00580"></a>00580         <span class="comment">//int scale = 4;</span>
<a name="l00581"></a>00581         <span class="comment">//POSITION pos = body.GetStartPosition();</span>
<a name="l00582"></a>00582         <span class="comment">//int i=0;</span>
<a name="l00583"></a>00583         <span class="comment">//while (pos) {</span>
<a name="l00584"></a>00584         <span class="comment">//      int id; Body *b;</span>
<a name="l00585"></a>00585         <span class="comment">//      body.GetNextAssoc(pos, id, b);</span>
<a name="l00586"></a>00586         <span class="comment">//      int x = i*(LABHistogram2D::a_bins*scale+10) % (frame-&gt;width-LABHistogram2D::a_bins*scale);</span>
<a name="l00587"></a>00587         <span class="comment">//      int y = i*(LABHistogram2D::a_bins*scale+10) / (frame-&gt;width-LABHistogram2D::a_bins*scale);</span>
<a name="l00588"></a>00588         <span class="comment">//      b-&gt;DrawHistogram(frame, scale, cvPoint(x, y));</span>
<a name="l00589"></a>00589         <span class="comment">//      i++;</span>
<a name="l00590"></a>00590         <span class="comment">//}</span>
<a name="l00591"></a>00591         <span class="keywordtype">double</span> min_val, max_val;
<a name="l00592"></a>00592         cvMinMaxLoc(<a class="code" href="_globals_8cpp.html#5f4f09b989fa2c50769ee80e11c1f343">ifg</a>, &amp;min_val, &amp;max_val);
<a name="l00593"></a>00593 
<a name="l00594"></a>00594         cvScale(<a class="code" href="_globals_8cpp.html#5f4f09b989fa2c50769ee80e11c1f343">ifg</a>, <a class="code" href="_globals_8cpp.html#4b2d4e55b64a28d4ac0b4e0a734d9f7a">temp</a>, 255.0/max_val);
<a name="l00595"></a>00595         cvCvtColor(<a class="code" href="_globals_8cpp.html#4b2d4e55b64a28d4ac0b4e0a734d9f7a">temp</a>, frame, CV_GRAY2RGB);
<a name="l00596"></a>00596 }
<a name="l00597"></a>00597 <span class="comment">// --------------------------------------------------------------------------</span>
<a name="l00598"></a>00598 <span class="comment">// --------------------------------------------------------------------------</span>
<a name="l00599"></a>00599 <span class="comment">// --------------------------------------------------------------------------</span>
<a name="l00600"></a><a class="code" href="class_body_model.html#cb36adf19afd9ec40789ad9b3d968e3b">00600</a> <a class="code" href="class_body.html">Body</a>* <a class="code" href="class_body_model.html#cb36adf19afd9ec40789ad9b3d968e3b">BodyModel::FindBodyMatch</a>(<a class="code" href="class_body_map.html">BodyMap</a>&amp; bmap, CvPoint3D32f bot, <span class="keywordtype">int</span> R) {
<a name="l00601"></a>00601         <span class="comment">// return the first body within the radius R</span>
<a name="l00602"></a>00602         POSITION pos = bmap.GetStartPosition();
<a name="l00603"></a>00603         <span class="keywordflow">while</span> (pos) {
<a name="l00604"></a>00604                 <span class="keywordtype">int</span> i; <a class="code" href="class_body.html">Body</a> *b;
<a name="l00605"></a>00605                 bmap.GetNextAssoc(pos, i, b);
<a name="l00606"></a>00606                 <span class="keywordflow">if</span> (<a class="code" href="_globals_8cpp.html#bf519ca750c62a1ae41705179bf5ea92">d</a>(bot, b-&gt;<a class="code" href="class_body.html#d85d03af61dd70805fef5d88e40c28be">bot</a>) &lt; R)
<a name="l00607"></a>00607                         <span class="keywordflow">return</span> b;
<a name="l00608"></a>00608         }
<a name="l00609"></a>00609         <span class="keywordflow">return</span> NULL;
<a name="l00610"></a>00610 }
<a name="l00611"></a>00611 <span class="comment">// --------------------------------------------------------------------------</span>
<a name="l00612"></a><a class="code" href="class_body_model.html#e4067df9137f81cf64cb93528a253f98">00612</a> <a class="code" href="class_body.html">Body</a>* <a class="code" href="class_body_model.html#cb36adf19afd9ec40789ad9b3d968e3b">BodyModel::FindBodyMatch</a>(<a class="code" href="class_body_map.html">BodyMap</a>&amp; bmap, CvPoint2D32f p, <span class="keywordtype">int</span> R) {
<a name="l00613"></a>00613         <span class="comment">// return the first body within the radius R</span>
<a name="l00614"></a>00614         CvPoint3D32f pBot = <a class="code" href="class_model.html#a0b1e435ecf4aaa93341250242dce611">doc</a>-&gt;<a class="code" href="class_c_new_vision_doc.html#e21c04f1c508fb2ae7ac1fc9c433d854">cameramodel</a>.<a class="code" href="class_camera_model.html#26943cb85699af14deb4e9867aecbf43">coordsImage2Real</a>(p, 0);            
<a name="l00615"></a>00615         <span class="keywordflow">return</span> <a class="code" href="class_body_model.html#cb36adf19afd9ec40789ad9b3d968e3b">FindBodyMatch</a>(bmap, pBot, R);
<a name="l00616"></a>00616 }
<a name="l00617"></a>00617 <span class="comment">// --------------------------------------------------------------------------</span>
<a name="l00618"></a><a class="code" href="class_body_model.html#b6826649ece8c24d551f358dd2287160">00618</a> <a class="code" href="class_body.html">Body</a>* <a class="code" href="class_body_model.html#b6826649ece8c24d551f358dd2287160">BodyModel::FindBodyMatchByAgeAndDistance</a>(<a class="code" href="class_body_map.html">BodyMap</a>&amp; bmap, <a class="code" href="class_body.html">Body</a>* b, <span class="keywordtype">int</span> d_age, <span class="keywordtype">double</span> R) {
<a name="l00619"></a>00619         <span class="comment">// return the first body within the 'd_age' age difference and  radius 'R'</span>
<a name="l00620"></a>00620         POSITION pos = bmap.GetStartPosition();
<a name="l00621"></a>00621         <span class="keywordflow">while</span> (pos) {
<a name="l00622"></a>00622                 <span class="keywordtype">int</span> i; <a class="code" href="class_body.html">Body</a> *b2;
<a name="l00623"></a>00623                 bmap.GetNextAssoc(pos, i, b2);
<a name="l00624"></a>00624                 <span class="keywordflow">if</span> ( b-&gt;<a class="code" href="class_body.html#67575149655136ec93f0bbb6f1cc06fe">startFrame</a> - b2-&gt;<a class="code" href="class_body.html#ab8bcf6c86228bf03b91a630ee7ad922">stopFrame</a> &lt; d_age
<a name="l00625"></a>00625                          &amp;&amp; <a class="code" href="_globals_8cpp.html#bf519ca750c62a1ae41705179bf5ea92">d</a>(b-&gt;<a class="code" href="class_body.html#d85d03af61dd70805fef5d88e40c28be">bot</a>, b2-&gt;<a class="code" href="class_body.html#d85d03af61dd70805fef5d88e40c28be">bot</a>) &lt; R )
<a name="l00626"></a>00626                                 <span class="keywordflow">return</span> b2;
<a name="l00627"></a>00627         }
<a name="l00628"></a>00628         <span class="keywordflow">return</span> NULL;
<a name="l00629"></a>00629 }
<a name="l00630"></a>00630 <span class="comment">// --------------------------------------------------------------------------</span>
<a name="l00631"></a><a class="code" href="class_body_model.html#515eae7cbaf6f67e80f60852f36f9c07">00631</a> <a class="code" href="class_body.html">Body</a>* <a class="code" href="class_body_model.html#515eae7cbaf6f67e80f60852f36f9c07">BodyModel::FindBodyMatchTop</a>(<a class="code" href="class_body_map.html">BodyMap</a>&amp; bmap, CvPoint2D32f p, <span class="keywordtype">int</span> R) {
<a name="l00632"></a>00632         <span class="comment">// return the first body within the radius R</span>
<a name="l00633"></a>00633         POSITION pos = bmap.GetStartPosition();
<a name="l00634"></a>00634         <span class="keywordflow">while</span> (pos) {
<a name="l00635"></a>00635                 <span class="keywordtype">int</span> i; <a class="code" href="class_body.html">Body</a> *b;
<a name="l00636"></a>00636                 bmap.GetNextAssoc(pos, i, b);
<a name="l00637"></a>00637                 CvPoint3D32f pTop = <a class="code" href="class_model.html#a0b1e435ecf4aaa93341250242dce611">doc</a>-&gt;<a class="code" href="class_c_new_vision_doc.html#e21c04f1c508fb2ae7ac1fc9c433d854">cameramodel</a>.<a class="code" href="class_camera_model.html#26943cb85699af14deb4e9867aecbf43">coordsImage2Real</a>(p, b-&gt;<a class="code" href="class_body.html#6538cc59c45d00a79f649f9d884cd42a">top</a>.z);
<a name="l00638"></a>00638                 <span class="keywordflow">if</span> (<a class="code" href="_globals_8cpp.html#bf519ca750c62a1ae41705179bf5ea92">d</a>(pTop, b-&gt;<a class="code" href="class_body.html#6538cc59c45d00a79f649f9d884cd42a">top</a>) &lt; R)
<a name="l00639"></a>00639                         <span class="keywordflow">return</span> b;
<a name="l00640"></a>00640         }
<a name="l00641"></a>00641         <span class="keywordflow">return</span> NULL;
<a name="l00642"></a>00642 }
<a name="l00643"></a>00643 <span class="comment">// --------------------------------------------------------------------------</span>
<a name="l00644"></a><a class="code" href="class_body_model.html#6761321fa099655f41c97de9a47fe77c">00644</a> <span class="keywordtype">int</span> <a class="code" href="class_body_model.html#6761321fa099655f41c97de9a47fe77c">BodyModel::FindBodyIDTop</a>(<a class="code" href="class_body_map.html">BodyMap</a>&amp; bmap, CvPoint2D32f p, <span class="keywordtype">int</span> R) {
<a name="l00645"></a>00645         <span class="comment">// return the first body within the radius R</span>
<a name="l00646"></a>00646         POSITION pos = bmap.GetStartPosition();
<a name="l00647"></a>00647         <span class="keywordflow">while</span> (pos) {
<a name="l00648"></a>00648                 <span class="keywordtype">int</span> i; <a class="code" href="class_body.html">Body</a> *b;
<a name="l00649"></a>00649                 bmap.GetNextAssoc(pos, i, b);
<a name="l00650"></a>00650                 CvPoint3D32f pTop = <a class="code" href="class_model.html#a0b1e435ecf4aaa93341250242dce611">doc</a>-&gt;<a class="code" href="class_c_new_vision_doc.html#e21c04f1c508fb2ae7ac1fc9c433d854">cameramodel</a>.<a class="code" href="class_camera_model.html#26943cb85699af14deb4e9867aecbf43">coordsImage2Real</a>(p, b-&gt;<a class="code" href="class_body.html#6538cc59c45d00a79f649f9d884cd42a">top</a>.z);
<a name="l00651"></a>00651                 <span class="keywordflow">if</span> (<a class="code" href="_globals_8cpp.html#bf519ca750c62a1ae41705179bf5ea92">d</a>(pTop, b-&gt;<a class="code" href="class_body.html#6538cc59c45d00a79f649f9d884cd42a">top</a>) &lt; R)
<a name="l00652"></a>00652                         <span class="keywordflow">return</span> b-&gt;<a class="code" href="class_object3_d.html#0cfc2671e2a01bb06144e3fa88a01b0e">id</a>;
<a name="l00653"></a>00653         }
<a name="l00654"></a>00654         <span class="keywordflow">return</span> -1;
<a name="l00655"></a>00655 }
<a name="l00656"></a>00656 <span class="comment">// --------------------------------------------------------------------------</span>
<a name="l00657"></a><a class="code" href="class_body_model.html#a947b76d6015feaf7d38e855aac70e80">00657</a> <span class="keywordtype">int</span> <a class="code" href="class_body_model.html#a947b76d6015feaf7d38e855aac70e80">BodyModel::FindBodyIDTag</a>(<a class="code" href="class_body_map.html">BodyMap</a>&amp; bmap, CvPoint2D32f p) {
<a name="l00658"></a>00658         <span class="comment">// return the first body match</span>
<a name="l00659"></a>00659         <span class="keyword">const</span> OFFSET = 3;
<a name="l00660"></a>00660         POSITION pos = bmap.GetStartPosition();
<a name="l00661"></a>00661         <span class="keywordflow">while</span> (pos) {
<a name="l00662"></a>00662                 <span class="keywordtype">int</span> i; <a class="code" href="class_body.html">Body</a> *b;
<a name="l00663"></a>00663                 bmap.GetNextAssoc(pos, i, b);
<a name="l00664"></a>00664                 CvRect r; b-&gt;<a class="code" href="class_body.html#b94a17084b0eae7232476683fc742cde">GetTagRect</a>(r);
<a name="l00665"></a>00665                 <span class="keywordflow">if</span> (<a class="code" href="_globals_8cpp.html#2ea75df9f3a700de6a687036365547c5">cvPointInRect</a>(cvPointFrom32f(p), r))
<a name="l00666"></a>00666                         <span class="keywordflow">return</span> b-&gt;<a class="code" href="class_object3_d.html#0cfc2671e2a01bb06144e3fa88a01b0e">id</a>;
<a name="l00667"></a>00667         }
<a name="l00668"></a>00668         <span class="keywordflow">return</span> -1;
<a name="l00669"></a>00669 }
<a name="l00670"></a>00670 
<a name="l00671"></a>00671 <span class="comment">// --------------------------------------------------------------------------</span>
<a name="l00672"></a><a class="code" href="class_body_model.html#f3f667f85641428749555986a9213ef4">00672</a> <span class="keywordtype">void</span> <a class="code" href="class_body_model.html#f3f667f85641428749555986a9213ef4">BodyModel::ReorderIDs</a>(<span class="keywordtype">int</span> last_id_before, <a class="code" href="class_body_map.html">BodyMap</a>&amp; bmap) {
<a name="l00673"></a>00673         POSITION pos = bmap.GetStartPosition();
<a name="l00674"></a>00674         <span class="keywordflow">while</span> (pos) {
<a name="l00675"></a>00675                 <span class="keywordtype">int</span> i; <a class="code" href="class_body.html">Body</a> *b;
<a name="l00676"></a>00676                 bmap.GetNextAssoc(pos, i, b);
<a name="l00677"></a>00677                 b-&gt;<a class="code" href="class_body.html#ab8bcf6c86228bf03b91a630ee7ad922">stopFrame</a> = (int)<a class="code" href="class_model.html#a0b1e435ecf4aaa93341250242dce611">doc</a>-&gt;<a class="code" href="class_c_new_vision_doc.html#70b31043294312993af8798f877550fe">trackermodel</a>.<a class="code" href="class_sequence_processor.html#73f2908199084c1045c3d1ee3d99533e">m_frameNumber</a>;
<a name="l00678"></a>00678                 if (b-&gt;<a class="code" href="class_object3_d.html#0cfc2671e2a01bb06144e3fa88a01b0e">id</a> &gt;= last_id_before) {
<a name="l00679"></a>00679                         bmap.<a class="code" href="class_body_map.html#92952bba376e196862b0fd0f42845f97">ChangeID</a>(b-&gt;<a class="code" href="class_object3_d.html#0cfc2671e2a01bb06144e3fa88a01b0e">id</a>, last_id_before);
<a name="l00680"></a>00680                         last_id_before++;
<a name="l00681"></a>00681                 }
<a name="l00682"></a>00682         }
<a name="l00683"></a>00683         <a class="code" href="class_body_model.html#4579ffa38bb9d8b281e1ec6498b73d98">last_id</a> = last_id_before;
<a name="l00684"></a>00684 }
<a name="l00685"></a>00685 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Tue Apr 24 22:32:50 2007 for New Vision by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.1-p1 </small></address>
</body>
</html>

<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>New Vision: F:/My Documents/Visual Studio 2005/Projects/NewVision/NewVision/LadybugStreamReader.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.1-p1 -->
<div class="tabs">
  <ul>
    <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="namespaces.html"><span>Namespaces</span></a></li>
    <li><a href="annotated.html"><span>Classes</span></a></li>
    <li id="current"><a href="files.html"><span>Files</span></a></li>
    <li>
      <form action="search.php" method="get">
        <table cellspacing="0" cellpadding="0" border="0">
          <tr>
            <td><label>&nbsp;<u>S</u>earch&nbsp;for&nbsp;</label></td>
            <td><input type="text" name="query" value="" size="20" accesskey="s"/></td>
          </tr>
        </table>
      </form>
    </li>
  </ul></div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
  </ul></div>
<h1>F:/My Documents/Visual Studio 2005/Projects/NewVision/NewVision/LadybugStreamReader.cpp</h1><a href="_ladybug_stream_reader_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">//=============================================================================</span>
<a name="l00002"></a>00002 <span class="comment">// Copyright © 2004 Point Grey Research, Inc. All Rights Reserved.</span>
<a name="l00003"></a>00003 <span class="comment">// </span>
<a name="l00004"></a>00004 <span class="comment">// This software is the confidential and proprietary information of Point</span>
<a name="l00005"></a>00005 <span class="comment">// Grey Research, Inc. ("Confidential Information").  You shall not</span>
<a name="l00006"></a>00006 <span class="comment">// disclose such Confidential Information and shall use it only in</span>
<a name="l00007"></a>00007 <span class="comment">// accordance with the terms of the license agreement you entered into</span>
<a name="l00008"></a>00008 <span class="comment">// with Point Grey Research, Inc. (PGR).</span>
<a name="l00009"></a>00009 <span class="comment">// </span>
<a name="l00010"></a>00010 <span class="comment">// PGR MAKES NO REPRESENTATIONS OR WARRANTIES ABOUT THE SUITABILITY OF THE</span>
<a name="l00011"></a>00011 <span class="comment">// SOFTWARE, EITHER EXPRESSED OR IMPLIED, INCLUDING, BUT NOT LIMITED TO, THE</span>
<a name="l00012"></a>00012 <span class="comment">// IMPLIED WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR</span>
<a name="l00013"></a>00013 <span class="comment">// PURPOSE, OR NON-INFRINGEMENT. PGR SHALL NOT BE LIABLE FOR ANY DAMAGES</span>
<a name="l00014"></a>00014 <span class="comment">// SUFFERED BY LICENSEE AS A RESULT OF USING, MODIFYING OR DISTRIBUTING</span>
<a name="l00015"></a>00015 <span class="comment">// THIS SOFTWARE OR ITS DERIVATIVES.</span>
<a name="l00016"></a>00016 <span class="comment">//=============================================================================</span>
<a name="l00017"></a>00017 <span class="comment">//=============================================================================</span>
<a name="l00018"></a>00018 <span class="comment">// $Id: LadybugStreamReader.cpp,v 1.9 2005/09/19 19:52:10 matt Exp $</span>
<a name="l00019"></a>00019 <span class="comment">//=============================================================================</span>
<a name="l00020"></a>00020 
<a name="l00021"></a>00021 <span class="comment">//=============================================================================</span>
<a name="l00022"></a>00022 <span class="comment">// System Includes</span>
<a name="l00023"></a>00023 <span class="comment">//=============================================================================</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include "<a class="code" href="_std_afx_8h.html">stdafx.h</a>"</span>
<a name="l00025"></a>00025 
<a name="l00026"></a>00026 <span class="preprocessor">#if USE_PGRLIBRARY</span>
<a name="l00027"></a>00027 <span class="preprocessor"></span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &lt;cassert&gt;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &lt;cstdlib&gt;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &lt;cstring&gt;</span>
<a name="l00031"></a>00031 
<a name="l00032"></a>00032 <span class="comment">//=============================================================================</span>
<a name="l00033"></a>00033 <span class="comment">// ProjectIncludes</span>
<a name="l00034"></a>00034 <span class="comment">//=============================================================================</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include "<a class="code" href="_ladybug_stream_reader_8h.html">LadybugStreamReader.h</a>"</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include "<a class="code" href="_ladybug_stream_writer_8h.html">LadybugStreamWriter.h</a>"</span>
<a name="l00037"></a>00037 
<a name="l00038"></a>00038 
<a name="l00039"></a><a class="code" href="_ladybug_stream_reader_8cpp.html#c597026bf0084ee98c9906541a4c202b">00039</a> <span class="preprocessor">#define TEMP_BUF_SIZE ( 6 * 1024 * 1024 )</span>
<a name="l00040"></a>00040 <span class="preprocessor"></span>
<a name="l00041"></a>00041 <span class="keyword">static</span> __inline <span class="keywordtype">unsigned</span>
<a name="l00042"></a><a class="code" href="_ladybug_stream_reader_8cpp.html#9c91aae361223a39c61b72e7082e723d">00042</a> <a class="code" href="compressorheaderinfo_8cpp.html#9c91aae361223a39c61b72e7082e723d">swab</a>( <span class="keywordtype">unsigned</span> num )
<a name="l00043"></a>00043 {
<a name="l00044"></a>00044    <span class="keywordflow">return</span> (
<a name="l00045"></a>00045       ( num&gt;&gt;24) |
<a name="l00046"></a>00046       ( ( num &amp; 0x00FF0000 ) &gt;&gt; 8 ) |
<a name="l00047"></a>00047       ( ( num &amp; 0x0000FF00 ) &lt;&lt; 8 ) |
<a name="l00048"></a>00048       (  num &lt;&lt; 24 ) );
<a name="l00049"></a>00049 }
<a name="l00050"></a>00050 
<a name="l00051"></a>00051 
<a name="l00052"></a><a class="code" href="class_ladybug_stream_reader.html#6ebd49bef03c837cadf0f86f748225f2">00052</a> <a class="code" href="class_ladybug_stream_reader.html#6ebd49bef03c837cadf0f86f748225f2">LadybugStreamReader::LadybugStreamReader</a>()
<a name="l00053"></a>00053 {
<a name="l00054"></a>00054    <a class="code" href="class_ladybug_stream_reader.html#38179f7ce475e6627ae0f14dad704c1f">m_pfile</a> = NULL;
<a name="l00055"></a>00055    <a class="code" href="class_ladybug_stream_reader.html#fcaf140835a9b026f41f88449005de67">m_bytesRead</a> = 0;
<a name="l00056"></a>00056    <a class="code" href="class_ladybug_stream_reader.html#fe0a835da8e344d5319bb7bc3724b637">m_iSplitFile</a> = 0;
<a name="l00057"></a>00057    
<a name="l00058"></a>00058    strcpy( <a class="code" href="class_ladybug_stream_reader.html#d30605ff88c8b9a3c4d25a640f348483">m_pszFilename</a>, <span class="stringliteral">""</span> );
<a name="l00059"></a>00059    strcpy( <a class="code" href="class_ladybug_stream_reader.html#0c26c84ac59fd079076ce9f24892a037">m_pszSrcPath</a>, <span class="stringliteral">""</span> );
<a name="l00060"></a>00060 
<a name="l00061"></a>00061    <a class="code" href="class_ladybug_stream_reader.html#e9d5a0b63f6a7a8c480248cbab1bb1a9">m_pTempBuf</a> = <span class="keyword">new</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>[ <a class="code" href="_ladybug_stream_reader_8cpp.html#c597026bf0084ee98c9906541a4c202b">TEMP_BUF_SIZE</a> ];
<a name="l00062"></a>00062 }
<a name="l00063"></a>00063 
<a name="l00064"></a>00064 
<a name="l00065"></a><a class="code" href="class_ladybug_stream_reader.html#8ec49547d623a485f2a7e466dd7468cd">00065</a> <a class="code" href="class_ladybug_stream_reader.html#8ec49547d623a485f2a7e466dd7468cd">LadybugStreamReader::~LadybugStreamReader</a>()
<a name="l00066"></a>00066 {
<a name="l00067"></a>00067    <a class="code" href="class_ladybug_stream_reader.html#599bceb1aa1ae0d9cbae519772548c43">close</a>();
<a name="l00068"></a>00068 
<a name="l00069"></a>00069    <span class="keywordflow">if</span>( <a class="code" href="class_ladybug_stream_reader.html#e9d5a0b63f6a7a8c480248cbab1bb1a9">m_pTempBuf</a> != NULL )
<a name="l00070"></a>00070    {
<a name="l00071"></a>00071       <span class="keyword">delete</span> [] <a class="code" href="class_ladybug_stream_reader.html#e9d5a0b63f6a7a8c480248cbab1bb1a9">m_pTempBuf</a>;
<a name="l00072"></a>00072       <a class="code" href="class_ladybug_stream_reader.html#e9d5a0b63f6a7a8c480248cbab1bb1a9">m_pTempBuf</a> = NULL;
<a name="l00073"></a>00073    }
<a name="l00074"></a>00074 }
<a name="l00075"></a>00075 
<a name="l00076"></a>00076 
<a name="l00077"></a>00077 LadybugError 
<a name="l00078"></a><a class="code" href="class_ladybug_stream_reader.html#55541ddeb2c2667902eeb3a093896430">00078</a> <a class="code" href="class_ladybug_stream_reader.html#55541ddeb2c2667902eeb3a093896430">LadybugStreamReader::readJPEGHeader</a>( <a class="code" href="class_compressor_header_info.html">CompressorHeaderInfo</a>* pinfo )
<a name="l00079"></a>00079 {
<a name="l00080"></a>00080    LadybugError error = LADYBUG_OK;
<a name="l00081"></a>00081    LadybugStreamHeadInfo streamHeaderInfo;
<a name="l00082"></a>00082 
<a name="l00083"></a>00083    <span class="keywordflow">if</span>( <a class="code" href="class_ladybug_stream_reader.html#38179f7ce475e6627ae0f14dad704c1f">m_pfile</a> == NULL )
<a name="l00084"></a>00084    {
<a name="l00085"></a>00085       assert( <span class="keyword">false</span> );
<a name="l00086"></a>00086       <span class="keywordflow">return</span> LADYBUG_FAILED;
<a name="l00087"></a>00087    }
<a name="l00088"></a>00088    
<a name="l00089"></a>00089    size_t count = fread( <a class="code" href="class_ladybug_stream_reader.html#e9d5a0b63f6a7a8c480248cbab1bb1a9">m_pTempBuf</a>, <a class="code" href="class_compressor_header_info.html#d422c1c1860307dd6138e7df706a17a718a7bba53ad6214f0d44e830f1da877c">CompressorHeaderInfo::SIZE</a>, 1, <a class="code" href="class_ladybug_stream_reader.html#38179f7ce475e6627ae0f14dad704c1f">m_pfile</a> );
<a name="l00090"></a>00090    <span class="keywordflow">if</span>( count != 1 )
<a name="l00091"></a>00091    {
<a name="l00092"></a>00092       <span class="comment">//</span>
<a name="l00093"></a>00093       <span class="comment">// In this case the stream file reading pointer points to the end </span>
<a name="l00094"></a>00094       <span class="comment">// Try to open the next stream file if it is possible</span>
<a name="l00095"></a>00095       <span class="comment">//</span>
<a name="l00096"></a>00096       
<a name="l00097"></a>00097       <span class="keywordflow">if</span>( ( error = <a class="code" href="class_ladybug_stream_reader.html#7bb826ea3b43312ba6ac865927e7cb07">openNextSplitFile</a>() ) == LADYBUG_OK )
<a name="l00098"></a>00098       {
<a name="l00099"></a>00099          <span class="comment">//</span>
<a name="l00100"></a>00100          <span class="comment">// Read the head of the stream file and seek </span>
<a name="l00101"></a>00101          <span class="comment">// the position of the first iamge</span>
<a name="l00102"></a>00102          <span class="comment">//</span>
<a name="l00103"></a>00103          <span class="keywordflow">if</span> ( <a class="code" href="class_ladybug_stream_reader.html#4241519f155743abd582e475797a0451">readStreamHeader</a>( &amp;streamHeaderInfo ) == LADYBUG_OK )
<a name="l00104"></a>00104          {
<a name="l00105"></a>00105             fseek( <a class="code" href="class_ladybug_stream_reader.html#38179f7ce475e6627ae0f14dad704c1f">m_pfile</a>, streamHeaderInfo.ulConfigrationDataSize, SEEK_CUR );
<a name="l00106"></a>00106          }
<a name="l00107"></a>00107 
<a name="l00108"></a>00108          <span class="comment">//</span>
<a name="l00109"></a>00109          <span class="comment">// Read the master header of the JPEG images</span>
<a name="l00110"></a>00110          <span class="comment">//</span>
<a name="l00111"></a>00111          size_t count = fread( 
<a name="l00112"></a>00112             <a class="code" href="class_ladybug_stream_reader.html#e9d5a0b63f6a7a8c480248cbab1bb1a9">m_pTempBuf</a>, <a class="code" href="class_compressor_header_info.html#d422c1c1860307dd6138e7df706a17a718a7bba53ad6214f0d44e830f1da877c">CompressorHeaderInfo::SIZE</a>, 1, <a class="code" href="class_ladybug_stream_reader.html#38179f7ce475e6627ae0f14dad704c1f">m_pfile</a> );
<a name="l00113"></a>00113          <span class="keywordflow">if</span>( count != 1 )
<a name="l00114"></a>00114          {
<a name="l00115"></a>00115             <span class="comment">//output( "Corrupt stream file: %s\n", pszFilename );</span>
<a name="l00116"></a>00116             <span class="keywordflow">return</span> LADYBUG_FAILED;
<a name="l00117"></a>00117          }
<a name="l00118"></a>00118       } 
<a name="l00119"></a>00119       <span class="keywordflow">else</span> <span class="keywordflow">if</span>( error == LADYBUG_COULD_NOT_OPEN_FILE ) 
<a name="l00120"></a>00120       {
<a name="l00121"></a>00121          <span class="comment">// There is no next split file.</span>
<a name="l00122"></a>00122          <span class="keywordflow">return</span> LADYBUG_FAILED;
<a name="l00123"></a>00123       }
<a name="l00124"></a>00124    } 
<a name="l00125"></a>00125    
<a name="l00126"></a>00126    <span class="comment">//</span>
<a name="l00127"></a>00127    <span class="comment">// Get the each header info of all JPEG images in this frame including </span>
<a name="l00128"></a>00128    <span class="comment">// the total size of this frame data</span>
<a name="l00129"></a>00129    <span class="comment">//</span>
<a name="l00130"></a>00130    <span class="keywordflow">if</span>( ( error = pinfo-&gt;<a class="code" href="class_compressor_header_info.html#66ee830d29512041fc6a26e1980a36c4">assembleJPEGHeaderInfo</a>( <a class="code" href="class_ladybug_stream_reader.html#e9d5a0b63f6a7a8c480248cbab1bb1a9">m_pTempBuf</a> ) )!= LADYBUG_OK )
<a name="l00131"></a>00131    {
<a name="l00132"></a>00132       assert( <span class="keyword">false</span> );
<a name="l00133"></a>00133       <span class="keywordflow">return</span> error;
<a name="l00134"></a>00134    }
<a name="l00135"></a>00135 
<a name="l00136"></a>00136    <span class="keywordflow">return</span> error;
<a name="l00137"></a>00137 }
<a name="l00138"></a>00138 
<a name="l00139"></a>00139 LadybugError 
<a name="l00140"></a><a class="code" href="class_ladybug_stream_reader.html#1d7a58acf5f2b8bb744458b65104c524">00140</a> <a class="code" href="class_ladybug_stream_reader.html#1d7a58acf5f2b8bb744458b65104c524">LadybugStreamReader::open</a>( <span class="keyword">const</span> <span class="keywordtype">char</span>* pszPath )
<a name="l00141"></a>00141 {
<a name="l00142"></a>00142    <a class="code" href="class_ladybug_stream_reader.html#599bceb1aa1ae0d9cbae519772548c43">close</a>();
<a name="l00143"></a>00143 
<a name="l00144"></a>00144    <a class="code" href="class_ladybug_stream_reader.html#fcaf140835a9b026f41f88449005de67">m_bytesRead</a> = 0;
<a name="l00145"></a>00145    <a class="code" href="class_ladybug_stream_reader.html#fe0a835da8e344d5319bb7bc3724b637">m_iSplitFile</a> = 0;
<a name="l00146"></a>00146 
<a name="l00147"></a>00147    strncpy( <a class="code" href="class_ladybug_stream_reader.html#0c26c84ac59fd079076ce9f24892a037">m_pszSrcPath</a>, pszPath, _MAX_PATH );
<a name="l00148"></a>00148    <span class="keywordflow">return</span> <a class="code" href="class_ladybug_stream_reader.html#7bb826ea3b43312ba6ac865927e7cb07">openNextSplitFile</a>();
<a name="l00149"></a>00149 }
<a name="l00150"></a>00150 
<a name="l00151"></a>00151 
<a name="l00152"></a>00152 LadybugError 
<a name="l00153"></a><a class="code" href="class_ladybug_stream_reader.html#599bceb1aa1ae0d9cbae519772548c43">00153</a> <a class="code" href="class_ladybug_stream_reader.html#599bceb1aa1ae0d9cbae519772548c43">LadybugStreamReader::close</a>()
<a name="l00154"></a>00154 {
<a name="l00155"></a>00155    <span class="keywordflow">if</span>( <a class="code" href="class_ladybug_stream_reader.html#38179f7ce475e6627ae0f14dad704c1f">m_pfile</a> != NULL )
<a name="l00156"></a>00156    {
<a name="l00157"></a>00157       fclose( <a class="code" href="class_ladybug_stream_reader.html#38179f7ce475e6627ae0f14dad704c1f">m_pfile</a> );
<a name="l00158"></a>00158       m_pfile = NULL;         
<a name="l00159"></a>00159    }
<a name="l00160"></a>00160 
<a name="l00161"></a>00161    <span class="keywordflow">return</span> LADYBUG_OK;
<a name="l00162"></a>00162 }
<a name="l00163"></a>00163 
<a name="l00164"></a>00164 
<a name="l00165"></a>00165 LadybugError 
<a name="l00166"></a><a class="code" href="class_ladybug_stream_reader.html#4241519f155743abd582e475797a0451">00166</a> <a class="code" href="class_ladybug_stream_reader.html#4241519f155743abd582e475797a0451">LadybugStreamReader::readStreamHeader</a>( LadybugStreamHeadInfo* pStreamHeaderInfo )
<a name="l00167"></a>00167 {
<a name="l00168"></a>00168    <span class="keywordflow">if</span>( <a class="code" href="class_ladybug_stream_reader.html#38179f7ce475e6627ae0f14dad704c1f">m_pfile</a> == NULL )
<a name="l00169"></a>00169    {
<a name="l00170"></a>00170       assert( <span class="keyword">false</span> );
<a name="l00171"></a>00171       <span class="keywordflow">return</span> LADYBUG_FAILED;
<a name="l00172"></a>00172    }
<a name="l00173"></a>00173 
<a name="l00174"></a>00174    fseek(<a class="code" href="class_ladybug_stream_reader.html#38179f7ce475e6627ae0f14dad704c1f">m_pfile</a>, <a class="code" href="_ladybug_stream_writer_8h.html#420caf27bb0258bf89a9fb214e69223a">SIZE_OF_PGR_STREAM_FILE_FLAG</a>, SEEK_SET);
<a name="l00175"></a>00175    size_t count = fread( pStreamHeaderInfo, 
<a name="l00176"></a>00176       <span class="keyword">sizeof</span>( LadybugStreamHeadInfo ), 1, <a class="code" href="class_ladybug_stream_reader.html#38179f7ce475e6627ae0f14dad704c1f">m_pfile</a> );
<a name="l00177"></a>00177    <span class="keywordflow">if</span>( count != 1 )
<a name="l00178"></a>00178    {
<a name="l00179"></a>00179       <span class="keywordflow">return</span> LADYBUG_FAILED;
<a name="l00180"></a>00180    }
<a name="l00181"></a>00181 
<a name="l00182"></a>00182    <span class="keywordflow">return</span> LADYBUG_OK;
<a name="l00183"></a>00183 }
<a name="l00184"></a>00184 
<a name="l00185"></a>00185 
<a name="l00186"></a>00186 LadybugError 
<a name="l00187"></a><a class="code" href="class_ladybug_stream_reader.html#7bb826ea3b43312ba6ac865927e7cb07">00187</a> <a class="code" href="class_ladybug_stream_reader.html#7bb826ea3b43312ba6ac865927e7cb07">LadybugStreamReader::openNextSplitFile</a>()
<a name="l00188"></a>00188 {
<a name="l00189"></a>00189    <a class="code" href="class_ladybug_stream_reader.html#599bceb1aa1ae0d9cbae519772548c43">close</a>();
<a name="l00190"></a>00190 
<a name="l00191"></a>00191    sprintf( <a class="code" href="class_ladybug_stream_reader.html#d30605ff88c8b9a3c4d25a640f348483">m_pszFilename</a>, <span class="stringliteral">"%s-%03d.pgr"</span>, <a class="code" href="class_ladybug_stream_reader.html#0c26c84ac59fd079076ce9f24892a037">m_pszSrcPath</a>, <a class="code" href="class_ladybug_stream_reader.html#fe0a835da8e344d5319bb7bc3724b637">m_iSplitFile</a>);
<a name="l00192"></a>00192    <a class="code" href="class_ladybug_stream_reader.html#38179f7ce475e6627ae0f14dad704c1f">m_pfile</a> = fopen( <a class="code" href="class_ladybug_stream_reader.html#d30605ff88c8b9a3c4d25a640f348483">m_pszFilename</a>, <span class="stringliteral">"rb"</span> );
<a name="l00193"></a>00193    <span class="keywordflow">if</span>( <a class="code" href="class_ladybug_stream_reader.html#38179f7ce475e6627ae0f14dad704c1f">m_pfile</a> == NULL )
<a name="l00194"></a>00194    {
<a name="l00195"></a>00195       <span class="keywordflow">return</span> LADYBUG_COULD_NOT_OPEN_FILE;
<a name="l00196"></a>00196    }
<a name="l00197"></a>00197    <span class="keywordflow">else</span>
<a name="l00198"></a>00198    {
<a name="l00199"></a>00199       <span class="comment">//</span>
<a name="l00200"></a>00200       <span class="comment">// Verity Ladybug stream file flag</span>
<a name="l00201"></a>00201       <span class="comment">//</span>
<a name="l00202"></a>00202       <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> flagString[<a class="code" href="_ladybug_stream_writer_8h.html#420caf27bb0258bf89a9fb214e69223a">SIZE_OF_PGR_STREAM_FILE_FLAG</a> + 1];
<a name="l00203"></a>00203 
<a name="l00204"></a>00204       fseek(<a class="code" href="class_ladybug_stream_reader.html#38179f7ce475e6627ae0f14dad704c1f">m_pfile</a>, 0, SEEK_SET);
<a name="l00205"></a>00205       size_t count = fread( 
<a name="l00206"></a>00206          flagString, <a class="code" href="_ladybug_stream_writer_8h.html#420caf27bb0258bf89a9fb214e69223a">SIZE_OF_PGR_STREAM_FILE_FLAG</a>, 1, <a class="code" href="class_ladybug_stream_reader.html#38179f7ce475e6627ae0f14dad704c1f">m_pfile</a> );
<a name="l00207"></a>00207       <span class="keywordflow">if</span>( count != 1 )
<a name="l00208"></a>00208          <span class="keywordflow">return</span> LADYBUG_FAILED;
<a name="l00209"></a>00209       <span class="keywordflow">else</span>
<a name="l00210"></a>00210       {
<a name="l00211"></a>00211          flagString[ <a class="code" href="_ladybug_stream_writer_8h.html#420caf27bb0258bf89a9fb214e69223a">SIZE_OF_PGR_STREAM_FILE_FLAG</a> ] = <span class="charliteral">'\0'</span>;
<a name="l00212"></a>00212          CString flagStringCompare = flagString;
<a name="l00213"></a>00213          <span class="comment">//</span>
<a name="l00214"></a>00214          <span class="comment">// Make sure it is a PGR stream file by comparing the flag</span>
<a name="l00215"></a>00215          <span class="comment">//</span>
<a name="l00216"></a>00216          <span class="keywordflow">if</span> ( flagStringCompare.Compare(<a class="code" href="_ladybug_stream_writer_8h.html#cbce0c1b5e162ed5df23550ae4d361a3">PGR_STREAM_FILE_FLAG</a>) != 0 )
<a name="l00217"></a>00217             <span class="keywordflow">return</span> LADYBUG_FAILED;
<a name="l00218"></a>00218       }
<a name="l00219"></a>00219       fseek(<a class="code" href="class_ladybug_stream_reader.html#38179f7ce475e6627ae0f14dad704c1f">m_pfile</a>, 0, SEEK_SET);
<a name="l00220"></a>00220    }
<a name="l00221"></a>00221 
<a name="l00222"></a>00222    <a class="code" href="class_ladybug_stream_reader.html#fe0a835da8e344d5319bb7bc3724b637">m_iSplitFile</a>++;
<a name="l00223"></a>00223 
<a name="l00224"></a>00224    <span class="keywordflow">return</span> LADYBUG_OK;
<a name="l00225"></a>00225 }
<a name="l00226"></a>00226 
<a name="l00227"></a>00227 
<a name="l00228"></a>00228 LadybugError 
<a name="l00229"></a><a class="code" href="class_ladybug_stream_reader.html#53d2a93ab462b63a0c115003e0560f85">00229</a> <a class="code" href="class_ladybug_stream_reader.html#53d2a93ab462b63a0c115003e0560f85">LadybugStreamReader::getStreamNumImages</a>( <span class="keywordtype">int</span>* pimages )
<a name="l00230"></a>00230 {
<a name="l00231"></a>00231    <span class="keywordtype">int</span> iImages = 0;
<a name="l00232"></a>00232    LadybugStreamHeadInfo streamHeaderInfo;
<a name="l00233"></a>00233 
<a name="l00234"></a>00234    <a class="code" href="class_ladybug_stream_reader.html#fe0a835da8e344d5319bb7bc3724b637">m_iSplitFile</a> =0;
<a name="l00235"></a>00235 
<a name="l00236"></a>00236    <span class="comment">// </span>
<a name="l00237"></a>00237    <span class="comment">// Read all the stream file and count the number of images in each stream file </span>
<a name="l00238"></a>00238    <span class="comment">//</span>
<a name="l00239"></a>00239    <span class="keywordflow">while</span>( <a class="code" href="class_ladybug_stream_reader.html#7bb826ea3b43312ba6ac865927e7cb07">openNextSplitFile</a>() == LADYBUG_OK )
<a name="l00240"></a>00240    {
<a name="l00241"></a>00241       <span class="comment">//</span>
<a name="l00242"></a>00242       <span class="comment">// Read the head from the stream file</span>
<a name="l00243"></a>00243       <span class="comment">//</span>
<a name="l00244"></a>00244       <span class="keywordflow">if</span> ( <a class="code" href="class_ladybug_stream_reader.html#4241519f155743abd582e475797a0451">readStreamHeader</a>( &amp;streamHeaderInfo ) == LADYBUG_OK )
<a name="l00245"></a>00245       {
<a name="l00246"></a>00246          iImages += streamHeaderInfo.ulNumberOfImages;
<a name="l00247"></a>00247       }
<a name="l00248"></a>00248    }
<a name="l00249"></a>00249 
<a name="l00250"></a>00250    <span class="comment">//</span>
<a name="l00251"></a>00251    <span class="comment">// Restore the default openning position to the beginning of the stream</span>
<a name="l00252"></a>00252    <span class="comment">//</span>
<a name="l00253"></a>00253    <a class="code" href="class_ladybug_stream_reader.html#599bceb1aa1ae0d9cbae519772548c43">close</a>();
<a name="l00254"></a>00254    <a class="code" href="class_ladybug_stream_reader.html#1d7a58acf5f2b8bb744458b65104c524">open</a>( <a class="code" href="class_ladybug_stream_reader.html#0c26c84ac59fd079076ce9f24892a037">m_pszSrcPath</a> );
<a name="l00255"></a>00255    <a class="code" href="class_ladybug_stream_reader.html#fe0a835da8e344d5319bb7bc3724b637">m_iSplitFile</a> =0;
<a name="l00256"></a>00256 
<a name="l00257"></a>00257    *pimages = iImages;
<a name="l00258"></a>00258 
<a name="l00259"></a>00259    <span class="keywordflow">return</span> LADYBUG_OK;
<a name="l00260"></a>00260 }
<a name="l00261"></a>00261 
<a name="l00262"></a>00262 LadybugError 
<a name="l00263"></a><a class="code" href="class_ladybug_stream_reader.html#74f290e15b46db99e336d9e856e9aa80">00263</a> <a class="code" href="class_ladybug_stream_reader.html#74f290e15b46db99e336d9e856e9aa80">LadybugStreamReader::getImageDataLength</a>( <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* pData,
<a name="l00264"></a>00264                                         <span class="keywordtype">long</span> *totalSize)
<a name="l00265"></a>00265 {
<a name="l00266"></a>00266    <span class="keywordtype">unsigned</span> offset = 0;;
<a name="l00267"></a>00267    <span class="keywordtype">unsigned</span> size = 0;
<a name="l00268"></a>00268    <span class="keywordtype">long</span> iTotalSize = 0;
<a name="l00269"></a>00269 
<a name="l00270"></a>00270    <span class="keywordflow">if</span> ( pData == NULL )
<a name="l00271"></a>00271       <span class="keywordflow">return</span> LADYBUG_FAILED;
<a name="l00272"></a>00272 
<a name="l00273"></a>00273    iTotalSize = 0;
<a name="l00274"></a>00274   
<a name="l00275"></a>00275    <span class="comment">//</span>
<a name="l00276"></a>00276    <span class="comment">// Parse the master header of this frame </span>
<a name="l00277"></a>00277    <span class="comment">// Get the maximum offset of the 24 JPEG images</span>
<a name="l00278"></a>00278    <span class="comment">// This maximum offset value is data length of this frame</span>
<a name="l00279"></a>00279    <span class="comment">// </span>
<a name="l00280"></a>00280    <span class="keywordflow">for</span>( <span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="compressorheaderinfo_8h.html#7d459b853b7247b1e32a1e1cdd059e31">COMPRESSOR_HEADER_MAX_IMAGES</a>; i++ )
<a name="l00281"></a>00281    {
<a name="l00282"></a>00282       offset = 
<a name="l00283"></a>00283          <a class="code" href="compressorheaderinfo_8cpp.html#9c91aae361223a39c61b72e7082e723d">swab</a>( *(<span class="keywordtype">unsigned</span>*)( pData + 1024 - ( 24 - i ) * 8 + 0 ) );
<a name="l00284"></a>00284       size = 
<a name="l00285"></a>00285          <a class="code" href="compressorheaderinfo_8cpp.html#9c91aae361223a39c61b72e7082e723d">swab</a>( *(<span class="keywordtype">unsigned</span>*)( pData + 1024 - ( 24 - i ) * 8 + 4 ) );
<a name="l00286"></a>00286 
<a name="l00287"></a>00287       <span class="keywordflow">if</span>( offset + size &gt; (<span class="keywordtype">unsigned</span>)iTotalSize )
<a name="l00288"></a>00288          iTotalSize = offset + size;
<a name="l00289"></a>00289    }
<a name="l00290"></a>00290    
<a name="l00291"></a>00291    *totalSize = iTotalSize;
<a name="l00292"></a>00292 
<a name="l00293"></a>00293    <span class="keywordflow">return</span> LADYBUG_OK;
<a name="l00294"></a>00294 }
<a name="l00295"></a>00295 
<a name="l00296"></a>00296 LadybugError 
<a name="l00297"></a><a class="code" href="class_ladybug_stream_reader.html#95869c93cf69a965ca9cba1c5d4eed7f">00297</a> <a class="code" href="class_ladybug_stream_reader.html#95869c93cf69a965ca9cba1c5d4eed7f">LadybugStreamReader::nextFrame</a>( )
<a name="l00298"></a>00298 {
<a name="l00299"></a>00299    LadybugError error;
<a name="l00300"></a>00300    <span class="keywordtype">long</span> totalFrameDataSize = 0;
<a name="l00301"></a>00301       
<a name="l00302"></a>00302    <span class="comment">//</span>
<a name="l00303"></a>00303    <span class="comment">// Read the master header of this frame</span>
<a name="l00304"></a>00304    <span class="comment">//</span>
<a name="l00305"></a>00305    size_t count = fread( 
<a name="l00306"></a>00306       <a class="code" href="class_ladybug_stream_reader.html#e9d5a0b63f6a7a8c480248cbab1bb1a9">m_pTempBuf</a>, <a class="code" href="class_compressor_header_info.html#d422c1c1860307dd6138e7df706a17a718a7bba53ad6214f0d44e830f1da877c">CompressorHeaderInfo::SIZE</a>, 1, <a class="code" href="class_ladybug_stream_reader.html#38179f7ce475e6627ae0f14dad704c1f">m_pfile</a> );
<a name="l00307"></a>00307    <span class="keywordflow">if</span>( count != 1 )
<a name="l00308"></a>00308    {
<a name="l00309"></a>00309       <span class="keywordflow">return</span> LADYBUG_FAILED;
<a name="l00310"></a>00310    }
<a name="l00311"></a>00311 
<a name="l00312"></a>00312    <span class="comment">//</span>
<a name="l00313"></a>00313    <span class="comment">// Get the data size of this frame</span>
<a name="l00314"></a>00314    <span class="comment">//</span>
<a name="l00315"></a>00315    <span class="keywordflow">if</span>( ( error = <a class="code" href="class_ladybug_stream_reader.html#74f290e15b46db99e336d9e856e9aa80">getImageDataLength</a>( <a class="code" href="class_ladybug_stream_reader.html#e9d5a0b63f6a7a8c480248cbab1bb1a9">m_pTempBuf</a>, &amp;totalFrameDataSize ) ) != 
<a name="l00316"></a>00316       LADYBUG_OK )
<a name="l00317"></a>00317    {
<a name="l00318"></a>00318       <span class="keywordflow">return</span> error;
<a name="l00319"></a>00319    }
<a name="l00320"></a>00320 
<a name="l00321"></a>00321    <span class="comment">//</span>
<a name="l00322"></a>00322    <span class="comment">// Skip this frame by 'totalFrameDataSize' bytes</span>
<a name="l00323"></a>00323    <span class="comment">//</span>
<a name="l00324"></a>00324    <span class="keywordtype">int</span> iRet = fseek( 
<a name="l00325"></a>00325       <a class="code" href="class_ladybug_stream_reader.html#38179f7ce475e6627ae0f14dad704c1f">m_pfile</a>,
<a name="l00326"></a>00326       totalFrameDataSize - <a class="code" href="class_compressor_header_info.html#d422c1c1860307dd6138e7df706a17a718a7bba53ad6214f0d44e830f1da877c">CompressorHeaderInfo::SIZE</a>, 
<a name="l00327"></a>00327       SEEK_CUR );
<a name="l00328"></a>00328    <span class="keywordflow">if</span>( iRet != 0 )
<a name="l00329"></a>00329    {
<a name="l00330"></a>00330       assert( <span class="keyword">false</span> );
<a name="l00331"></a>00331       <span class="keywordflow">return</span> LADYBUG_FAILED;
<a name="l00332"></a>00332    }
<a name="l00333"></a>00333 
<a name="l00334"></a>00334    <span class="keywordflow">return</span> LADYBUG_OK;
<a name="l00335"></a>00335 }
<a name="l00336"></a>00336 
<a name="l00337"></a>00337  
<a name="l00338"></a>00338 LadybugError 
<a name="l00339"></a><a class="code" href="class_ladybug_stream_reader.html#0587d372ae000f410fae1de54f40d8c5">00339</a> <a class="code" href="class_ladybug_stream_reader.html#0587d372ae000f410fae1de54f40d8c5">LadybugStreamReader::fastForward</a>( <span class="keywordtype">int</span> iImageNum )
<a name="l00340"></a>00340 {
<a name="l00341"></a>00341 
<a name="l00342"></a>00342    LadybugStreamHeadInfo *streamHeaderInfo = <span class="keyword">new</span> LadybugStreamHeadInfo;
<a name="l00343"></a>00343    <span class="keywordtype">int</span> iImageCounter = 0;
<a name="l00344"></a>00344    <span class="keywordtype">bool</span> bWantedStreamFound = <span class="keyword">false</span>;
<a name="l00345"></a>00345    LadybugError error = LADYBUG_FAILED;
<a name="l00346"></a>00346    <span class="keywordtype">int</span> iImagePositionNumber = 0;
<a name="l00347"></a>00347    <span class="keywordtype">int</span> iSkipImages = 0;
<a name="l00348"></a>00348 
<a name="l00349"></a>00349    <a class="code" href="class_ladybug_stream_reader.html#fe0a835da8e344d5319bb7bc3724b637">m_iSplitFile</a> =0;
<a name="l00350"></a>00350 
<a name="l00351"></a>00351    <span class="comment">// </span>
<a name="l00352"></a>00352    <span class="comment">// Read each stream file and count the number of images</span>
<a name="l00353"></a>00353    <span class="comment">// Check if this stream file contains the wanted image</span>
<a name="l00354"></a>00354    <span class="comment">//</span>
<a name="l00355"></a>00355    <span class="keywordflow">while</span>( <a class="code" href="class_ladybug_stream_reader.html#7bb826ea3b43312ba6ac865927e7cb07">openNextSplitFile</a>() == LADYBUG_OK )
<a name="l00356"></a>00356    {
<a name="l00357"></a>00357       <span class="comment">//</span>
<a name="l00358"></a>00358       <span class="comment">// Read the head from the stream file</span>
<a name="l00359"></a>00359       <span class="comment">//</span>
<a name="l00360"></a>00360       <span class="keywordflow">if</span> ( (error = <a class="code" href="class_ladybug_stream_reader.html#4241519f155743abd582e475797a0451">readStreamHeader</a>( streamHeaderInfo )) == LADYBUG_OK )
<a name="l00361"></a>00361       {
<a name="l00362"></a>00362          iImageCounter += streamHeaderInfo-&gt;ulNumberOfImages;
<a name="l00363"></a>00363 
<a name="l00364"></a>00364          <span class="comment">//</span>
<a name="l00365"></a>00365          <span class="comment">// Check if it is the wanted stream file</span>
<a name="l00366"></a>00366          <span class="comment">//</span>
<a name="l00367"></a>00367          <span class="keywordflow">if</span> ( iImageCounter &lt;= iImageNum )
<a name="l00368"></a>00368             <span class="keywordflow">continue</span>;
<a name="l00369"></a>00369          <span class="keywordflow">else</span>
<a name="l00370"></a>00370          {
<a name="l00371"></a>00371             <span class="comment">//</span>
<a name="l00372"></a>00372             <span class="comment">// Set iImageCounter to the total number of images</span>
<a name="l00373"></a>00373             <span class="comment">// of the files skipped</span>
<a name="l00374"></a>00374             <span class="comment">//</span>
<a name="l00375"></a>00375             iImageCounter -= streamHeaderInfo-&gt;ulNumberOfImages;
<a name="l00376"></a>00376             bWantedStreamFound = <span class="keyword">true</span>;
<a name="l00377"></a>00377             <span class="keywordflow">break</span>;
<a name="l00378"></a>00378          }
<a name="l00379"></a>00379       }
<a name="l00380"></a>00380       <span class="keywordflow">else</span>
<a name="l00381"></a>00381          <span class="keywordflow">break</span>;
<a name="l00382"></a>00382    }
<a name="l00383"></a>00383 
<a name="l00384"></a>00384    <span class="keywordflow">if</span> ( bWantedStreamFound ) 
<a name="l00385"></a>00385    {
<a name="l00386"></a>00386       <span class="keywordtype">long</span> lSearchPositionOffset = 0;
<a name="l00387"></a>00387       <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> offsetIndex = 0;
<a name="l00388"></a>00388       <span class="keywordtype">int</span> iRet;
<a name="l00389"></a>00389       
<a name="l00390"></a>00390       <span class="comment">//</span>
<a name="l00391"></a>00391       <span class="comment">// Calculate the position of the image</span>
<a name="l00392"></a>00392       <span class="comment">//</span>
<a name="l00393"></a>00393       iImagePositionNumber =  iImageNum - iImageCounter;
<a name="l00394"></a>00394       assert( iImagePositionNumber &gt;= 0 );
<a name="l00395"></a>00395 
<a name="l00396"></a>00396       <span class="comment">//</span>
<a name="l00397"></a>00397       <span class="comment">// Calculate the the key index number of this image</span>
<a name="l00398"></a>00398       <span class="comment">//</span>
<a name="l00399"></a>00399       offsetIndex = iImagePositionNumber / streamHeaderInfo-&gt;ulIncrement;
<a name="l00400"></a>00400 
<a name="l00401"></a>00401       <span class="comment">//</span>
<a name="l00402"></a>00402       <span class="comment">// Skip images from the first image of this offset</span>
<a name="l00403"></a>00403       <span class="comment">//</span>
<a name="l00404"></a>00404       iSkipImages = iImagePositionNumber - 
<a name="l00405"></a>00405          offsetIndex * streamHeaderInfo-&gt;ulIncrement;
<a name="l00406"></a>00406       assert( iSkipImages &gt;= 0 );
<a name="l00407"></a>00407 
<a name="l00408"></a>00408       <span class="keywordflow">if</span> ( offsetIndex &gt; streamHeaderInfo-&gt;ulNumberOfKeyIndex ) 
<a name="l00409"></a>00409          error = LADYBUG_FAILED;
<a name="l00410"></a>00410       <span class="keywordflow">else</span>
<a name="l00411"></a>00411       {
<a name="l00412"></a>00412          <span class="comment">//</span>
<a name="l00413"></a>00413          <span class="comment">// Get the beginning search position from the offsetset</span>
<a name="l00414"></a>00414          <span class="comment">// Set the file reading position</span>
<a name="l00415"></a>00415          <span class="comment">//</span>
<a name="l00416"></a>00416          lSearchPositionOffset = streamHeaderInfo-&gt;ulOffsetTable[ 
<a name="l00417"></a>00417             <a class="code" href="_ladybug_stream_writer_8h.html#ab9f511854710396032e62467b471d1f">MAX_NUMBER_OF_IMAGE_INDEXES</a> - 1 - offsetIndex ];
<a name="l00418"></a>00418          iRet = fseek( <a class="code" href="class_ladybug_stream_reader.html#38179f7ce475e6627ae0f14dad704c1f">m_pfile</a>, lSearchPositionOffset, SEEK_SET );
<a name="l00419"></a>00419          <span class="keywordflow">if</span>( iRet != 0 )
<a name="l00420"></a>00420          {
<a name="l00421"></a>00421             assert( <span class="keyword">false</span> );
<a name="l00422"></a>00422             error = LADYBUG_FAILED;
<a name="l00423"></a>00423          }
<a name="l00424"></a>00424          <span class="keywordflow">else</span>
<a name="l00425"></a>00425          {
<a name="l00426"></a>00426             <span class="comment">//</span>
<a name="l00427"></a>00427             <span class="comment">// Move forward to the destination</span>
<a name="l00428"></a>00428             <span class="comment">//</span>
<a name="l00429"></a>00429             <span class="keywordflow">for</span>( <span class="keywordtype">int</span> i = 0; i &lt; iSkipImages; i++ )
<a name="l00430"></a>00430             {
<a name="l00431"></a>00431                <span class="keywordflow">if</span>( ( error = <a class="code" href="class_ladybug_stream_reader.html#95869c93cf69a965ca9cba1c5d4eed7f">nextFrame</a>( ) ) != LADYBUG_OK )
<a name="l00432"></a>00432                   <span class="keywordflow">break</span>;
<a name="l00433"></a>00433             }
<a name="l00434"></a>00434          }
<a name="l00435"></a>00435       }
<a name="l00436"></a>00436    }
<a name="l00437"></a>00437 
<a name="l00438"></a>00438    <span class="keyword">delete</span> streamHeaderInfo;
<a name="l00439"></a>00439    <span class="keywordflow">return</span> error;
<a name="l00440"></a>00440 }
<a name="l00441"></a>00441 
<a name="l00442"></a>00442 
<a name="l00443"></a>00443 
<a name="l00444"></a>00444 LadybugError 
<a name="l00445"></a><a class="code" href="class_ladybug_stream_reader.html#61da47f2992beb6f10c2a708c289115a">00445</a> <a class="code" href="class_ladybug_stream_reader.html#1b0c8a3f47d40f82fb17780e73698db7">LadybugStreamReader::readFrame</a>( <a class="code" href="class_compressor_header_info.html">CompressorHeaderInfo</a>* pinfo, <span class="keywordtype">int</span> iIndex, LadybugImage* pLadybugImage)
<a name="l00446"></a>00446 {
<a name="l00447"></a>00447    <a class="code" href="class_ladybug_stream_reader.html#599bceb1aa1ae0d9cbae519772548c43">close</a>();
<a name="l00448"></a>00448    <a class="code" href="class_ladybug_stream_reader.html#1d7a58acf5f2b8bb744458b65104c524">open</a>( <a class="code" href="class_ladybug_stream_reader.html#0c26c84ac59fd079076ce9f24892a037">m_pszSrcPath</a> );
<a name="l00449"></a>00449 
<a name="l00450"></a>00450    <a class="code" href="class_ladybug_stream_reader.html#0587d372ae000f410fae1de54f40d8c5">fastForward</a>( iIndex );
<a name="l00451"></a>00451 
<a name="l00452"></a>00452    <span class="keywordflow">return</span> <a class="code" href="class_ladybug_stream_reader.html#1b0c8a3f47d40f82fb17780e73698db7">readFrame</a>( pinfo, pLadybugImage );
<a name="l00453"></a>00453 }
<a name="l00454"></a>00454 
<a name="l00455"></a>00455 
<a name="l00456"></a>00456 <span class="keywordtype">double</span> 
<a name="l00457"></a><a class="code" href="class_ladybug_stream_reader.html#549810f474b25f9359f41132ab4548c9">00457</a> <a class="code" href="class_ladybug_stream_reader.html#549810f474b25f9359f41132ab4548c9">LadybugStreamReader::getMBRead</a>()<span class="keyword"> const</span>
<a name="l00458"></a>00458 <span class="keyword"></span>{
<a name="l00459"></a>00459    <span class="keywordflow">return</span> (<span class="keywordtype">double</span>)<a class="code" href="class_ladybug_stream_reader.html#fcaf140835a9b026f41f88449005de67">m_bytesRead</a> / (double)( 1024 * 1024 );
<a name="l00460"></a>00460 }
<a name="l00461"></a>00461 
<a name="l00462"></a>00462 
<a name="l00463"></a>00463 
<a name="l00464"></a>00464 LadybugError 
<a name="l00465"></a><a class="code" href="class_ladybug_stream_reader.html#1b0c8a3f47d40f82fb17780e73698db7">00465</a> <a class="code" href="class_ladybug_stream_reader.html#1b0c8a3f47d40f82fb17780e73698db7">LadybugStreamReader::readFrame</a>( <a class="code" href="class_compressor_header_info.html">CompressorHeaderInfo</a>* pinfo, 
<a name="l00466"></a>00466                                LadybugImage* pLadybugImage )
<a name="l00467"></a>00467 {
<a name="l00468"></a>00468    LadybugError error;
<a name="l00469"></a>00469 
<a name="l00470"></a>00470    <span class="keywordflow">if</span>( pinfo == NULL )
<a name="l00471"></a>00471    {
<a name="l00472"></a>00472       <span class="keywordflow">return</span> LADYBUG_INVALID_ARGUMENT;
<a name="l00473"></a>00473    }
<a name="l00474"></a>00474 
<a name="l00475"></a>00475    <span class="comment">//</span>
<a name="l00476"></a>00476    <span class="comment">// Get the master HEADER of the JPEG frame</span>
<a name="l00477"></a>00477    <span class="comment">//</span>
<a name="l00478"></a>00478    <span class="keywordflow">if</span>( ( error = <a class="code" href="class_ladybug_stream_reader.html#55541ddeb2c2667902eeb3a093896430">readJPEGHeader</a>( pinfo ) ) != LADYBUG_OK )
<a name="l00479"></a>00479       <span class="keywordflow">return</span> error;
<a name="l00480"></a>00480    <span class="comment">//</span>
<a name="l00481"></a>00481    <span class="comment">// Read the JPEG images following the master header</span>
<a name="l00482"></a>00482    <span class="comment">//</span>
<a name="l00483"></a>00483    size_t count = fread( 
<a name="l00484"></a>00484       <a class="code" href="class_ladybug_stream_reader.html#e9d5a0b63f6a7a8c480248cbab1bb1a9">m_pTempBuf</a> + <a class="code" href="class_compressor_header_info.html#d422c1c1860307dd6138e7df706a17a718a7bba53ad6214f0d44e830f1da877c">CompressorHeaderInfo::SIZE</a>, 
<a name="l00485"></a>00485       pinfo-&gt;<a class="code" href="class_compressor_header_info.html#ed4e627e49426b1d2cb794753428cac6">totalSize</a>() - <a class="code" href="class_compressor_header_info.html#d422c1c1860307dd6138e7df706a17a718a7bba53ad6214f0d44e830f1da877c">CompressorHeaderInfo::SIZE</a>, 
<a name="l00486"></a>00486       1, 
<a name="l00487"></a>00487       <a class="code" href="class_ladybug_stream_reader.html#38179f7ce475e6627ae0f14dad704c1f">m_pfile</a> );
<a name="l00488"></a>00488    <span class="keywordflow">if</span>( count != 1 )
<a name="l00489"></a>00489       <span class="keywordflow">return</span> LADYBUG_FAILED;
<a name="l00490"></a>00490 
<a name="l00491"></a>00491    <span class="keywordflow">if</span> ( pLadybugImage != NULL )
<a name="l00492"></a>00492    {
<a name="l00493"></a>00493       pLadybugImage-&gt;pData = <a class="code" href="class_ladybug_stream_reader.html#e9d5a0b63f6a7a8c480248cbab1bb1a9">m_pTempBuf</a>;
<a name="l00494"></a>00494       pLadybugImage-&gt;uiDataSizeBytes = pinfo-&gt;<a class="code" href="class_compressor_header_info.html#ed4e627e49426b1d2cb794753428cac6">totalSize</a>();
<a name="l00495"></a>00495 
<a name="l00496"></a>00496       <span class="comment">//</span>
<a name="l00497"></a>00497       <span class="comment">// Parse the LadybugImageInfo from the stream data</span>
<a name="l00498"></a>00498       <span class="comment">//</span>
<a name="l00499"></a>00499       <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* pInfoStruct = pLadybugImage-&gt;pData + 0x10;
<a name="l00500"></a>00500       <span class="comment">// initialize the image info </span>
<a name="l00501"></a>00501       memset( &amp;pLadybugImage-&gt;imageInfo, 0, <span class="keyword">sizeof</span>( LadybugImageInfo ) );
<a name="l00502"></a>00502 
<a name="l00503"></a>00503       <span class="comment">//</span>
<a name="l00504"></a>00504       <span class="comment">// Copy the info quadlets from the stream data to the imageInfo header</span>
<a name="l00505"></a>00505       <span class="comment">// converting endiannes (reversing the byte ordering within the quadlet)</span>
<a name="l00506"></a>00506       <span class="comment">//</span>
<a name="l00507"></a>00507       <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>* pDest = (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>*)&amp;pLadybugImage-&gt;imageInfo;
<a name="l00508"></a>00508       <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>* pSrc  = (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>*)pInfoStruct;
<a name="l00509"></a>00509 
<a name="l00510"></a>00510       assert( <span class="keyword">sizeof</span>( LadybugImageInfo ) % 4 == 0 );
<a name="l00511"></a>00511       <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> uiQuadlets = <span class="keyword">sizeof</span>( LadybugImageInfo ) / 4;
<a name="l00512"></a>00512 
<a name="l00513"></a>00513       <span class="keywordflow">for</span>( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; uiQuadlets; i++ )
<a name="l00514"></a>00514       {
<a name="l00515"></a>00515          <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* pBytes = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)&amp;pSrc[ i ];
<a name="l00516"></a>00516 
<a name="l00517"></a>00517          pDest[ i ] = (<span class="keywordtype">unsigned</span> long)(  
<a name="l00518"></a>00518             pBytes[ 3 ] | 
<a name="l00519"></a>00519             pBytes[ 2 ] &lt;&lt; 8 | 
<a name="l00520"></a>00520             pBytes[ 1 ] &lt;&lt; 16 | 
<a name="l00521"></a>00521             pBytes[ 0 ] &lt;&lt; 24 );
<a name="l00522"></a>00522       }
<a name="l00523"></a>00523       <span class="comment">//</span>
<a name="l00524"></a>00524       <span class="comment">// Fill in LadybugImge</span>
<a name="l00525"></a>00525       <span class="comment">//</span>
<a name="l00526"></a>00526       pLadybugImage-&gt;timeStamp.ulSeconds = 
<a name="l00527"></a>00527          pLadybugImage-&gt;imageInfo.ulTimeSeconds;
<a name="l00528"></a>00528       pLadybugImage-&gt;timeStamp.ulMicroSeconds = 
<a name="l00529"></a>00529          pLadybugImage-&gt;imageInfo.ulTimeMicroSeconds;
<a name="l00530"></a>00530       pLadybugImage-&gt;uiSeqNum = pLadybugImage-&gt;imageInfo.ulSequenceId;
<a name="l00531"></a>00531 
<a name="l00532"></a>00532    }
<a name="l00533"></a>00533    <span class="comment">//</span>
<a name="l00534"></a>00534    <span class="comment">// Count the bytes read</span>
<a name="l00535"></a>00535    <span class="comment">//</span>
<a name="l00536"></a>00536    <a class="code" href="class_ladybug_stream_reader.html#fcaf140835a9b026f41f88449005de67">m_bytesRead</a> += pinfo-&gt;<a class="code" href="class_compressor_header_info.html#ed4e627e49426b1d2cb794753428cac6">totalSize</a>();
<a name="l00537"></a>00537 
<a name="l00538"></a>00538    <span class="keywordflow">return</span> LADYBUG_OK;
<a name="l00539"></a>00539 }
<a name="l00540"></a>00540 
<a name="l00541"></a>00541 
<a name="l00542"></a>00542 LadybugError 
<a name="l00543"></a><a class="code" href="class_ladybug_stream_reader.html#eaf376e9ca97370a5c8feffe95830f39">00543</a> <a class="code" href="class_ladybug_stream_reader.html#eaf376e9ca97370a5c8feffe95830f39">LadybugStreamReader::getConfigFile</a>( <span class="keyword">const</span> <span class="keywordtype">char</span>* pszConfigFileName )
<a name="l00544"></a>00544 {
<a name="l00545"></a>00545    LadybugError error = LADYBUG_FAILED;
<a name="l00546"></a>00546    LadybugStreamHeadInfo streamHeaderInfo;
<a name="l00547"></a>00547 
<a name="l00548"></a>00548    <a class="code" href="class_ladybug_stream_reader.html#fe0a835da8e344d5319bb7bc3724b637">m_iSplitFile</a> =0;
<a name="l00549"></a>00549 
<a name="l00550"></a>00550    <span class="comment">// </span>
<a name="l00551"></a>00551    <span class="comment">// Read all the stream file and count the number of images in each stream file </span>
<a name="l00552"></a>00552    <span class="comment">//</span>
<a name="l00553"></a>00553    <span class="keywordflow">while</span>( <a class="code" href="class_ladybug_stream_reader.html#7bb826ea3b43312ba6ac865927e7cb07">openNextSplitFile</a>() == LADYBUG_OK )
<a name="l00554"></a>00554    {
<a name="l00555"></a>00555       <span class="comment">//</span>
<a name="l00556"></a>00556       <span class="comment">// Read the head from the stream file</span>
<a name="l00557"></a>00557       <span class="comment">//</span>
<a name="l00558"></a>00558       <span class="keywordflow">if</span> ( <a class="code" href="class_ladybug_stream_reader.html#4241519f155743abd582e475797a0451">readStreamHeader</a>( &amp;streamHeaderInfo ) == LADYBUG_OK )
<a name="l00559"></a>00559       {
<a name="l00560"></a>00560          size_t count = fread( <a class="code" href="class_ladybug_stream_reader.html#e9d5a0b63f6a7a8c480248cbab1bb1a9">m_pTempBuf</a>, 
<a name="l00561"></a>00561             streamHeaderInfo.ulConfigrationDataSize, 1, <a class="code" href="class_ladybug_stream_reader.html#38179f7ce475e6627ae0f14dad704c1f">m_pfile</a> );
<a name="l00562"></a>00562          <span class="keywordflow">if</span>( count != 1 )
<a name="l00563"></a>00563          {
<a name="l00564"></a>00564             <span class="comment">//</span>
<a name="l00565"></a>00565             <span class="comment">// Try to read next one</span>
<a name="l00566"></a>00566             <span class="comment">//</span>
<a name="l00567"></a>00567             error = LADYBUG_FAILED;
<a name="l00568"></a>00568             <span class="keywordflow">continue</span>;
<a name="l00569"></a>00569          }
<a name="l00570"></a>00570          <span class="keywordflow">else</span>
<a name="l00571"></a>00571          {
<a name="l00572"></a>00572             <span class="comment">//</span>
<a name="l00573"></a>00573             <span class="comment">// Write it to the file</span>
<a name="l00574"></a>00574             <span class="comment">//</span>
<a name="l00575"></a>00575             FILE *writingfile = fopen( pszConfigFileName, <span class="stringliteral">"wb"</span> );
<a name="l00576"></a>00576             <span class="keywordflow">if</span>( writingfile != NULL )
<a name="l00577"></a>00577             {
<a name="l00578"></a>00578                <span class="keywordtype">long</span> result = fwrite( <a class="code" href="class_ladybug_stream_reader.html#e9d5a0b63f6a7a8c480248cbab1bb1a9">m_pTempBuf</a>, 
<a name="l00579"></a>00579                   streamHeaderInfo.ulConfigrationDataSize, 1, writingfile );
<a name="l00580"></a>00580                <span class="keywordflow">if</span> ( result != 1 ) {
<a name="l00581"></a>00581                   <span class="keywordflow">return</span> error = LADYBUG_COULD_NOT_OPEN_FILE;
<a name="l00582"></a>00582                   <span class="keywordflow">break</span>;
<a name="l00583"></a>00583                }
<a name="l00584"></a>00584                <span class="keywordflow">else</span>
<a name="l00585"></a>00585                   error = LADYBUG_OK;
<a name="l00586"></a>00586                fclose(writingfile);
<a name="l00587"></a>00587             }
<a name="l00588"></a>00588             <span class="keywordflow">else</span>
<a name="l00589"></a>00589                error = LADYBUG_COULD_NOT_OPEN_FILE;
<a name="l00590"></a>00590             <span class="keywordflow">break</span>;
<a name="l00591"></a>00591          }
<a name="l00592"></a>00592       }
<a name="l00593"></a>00593    }
<a name="l00594"></a>00594 
<a name="l00595"></a>00595    <span class="comment">//</span>
<a name="l00596"></a>00596    <span class="comment">// Restore the default openning position to the beginning of the stream</span>
<a name="l00597"></a>00597    <span class="comment">//</span>
<a name="l00598"></a>00598    <a class="code" href="class_ladybug_stream_reader.html#599bceb1aa1ae0d9cbae519772548c43">close</a>();
<a name="l00599"></a>00599    <a class="code" href="class_ladybug_stream_reader.html#1d7a58acf5f2b8bb744458b65104c524">open</a>( <a class="code" href="class_ladybug_stream_reader.html#0c26c84ac59fd079076ce9f24892a037">m_pszSrcPath</a> );
<a name="l00600"></a>00600    <a class="code" href="class_ladybug_stream_reader.html#fe0a835da8e344d5319bb7bc3724b637">m_iSplitFile</a> =0;
<a name="l00601"></a>00601 
<a name="l00602"></a>00602    <span class="keywordflow">return</span> error;
<a name="l00603"></a>00603 }
<a name="l00604"></a>00604 
<a name="l00605"></a>00605 LadybugError 
<a name="l00606"></a><a class="code" href="class_ladybug_stream_reader.html#1eb3d890cd8347d49917641ce52caf4c">00606</a> <a class="code" href="class_ladybug_stream_reader.html#1eb3d890cd8347d49917641ce52caf4c">LadybugStreamReader::getConfigData</a>( <span class="keywordtype">char</span>* pszConfigData )
<a name="l00607"></a>00607 {
<a name="l00608"></a>00608    LadybugError error = LADYBUG_FAILED;
<a name="l00609"></a>00609    LadybugStreamHeadInfo streamHeaderInfo;
<a name="l00610"></a>00610 
<a name="l00611"></a>00611    <a class="code" href="class_ladybug_stream_reader.html#fe0a835da8e344d5319bb7bc3724b637">m_iSplitFile</a> =0;
<a name="l00612"></a>00612 
<a name="l00613"></a>00613    <span class="comment">// </span>
<a name="l00614"></a>00614    <span class="comment">// Read all the stream file and count the number of images in each stream file </span>
<a name="l00615"></a>00615    <span class="comment">//</span>
<a name="l00616"></a>00616    <span class="keywordflow">while</span>( <a class="code" href="class_ladybug_stream_reader.html#7bb826ea3b43312ba6ac865927e7cb07">openNextSplitFile</a>() == LADYBUG_OK )
<a name="l00617"></a>00617    {
<a name="l00618"></a>00618       <span class="comment">//</span>
<a name="l00619"></a>00619       <span class="comment">// Read the head from the stream file</span>
<a name="l00620"></a>00620       <span class="comment">//</span>
<a name="l00621"></a>00621       <span class="keywordflow">if</span> ( <a class="code" href="class_ladybug_stream_reader.html#4241519f155743abd582e475797a0451">readStreamHeader</a>( &amp;streamHeaderInfo ) == LADYBUG_OK )
<a name="l00622"></a>00622       {
<a name="l00623"></a>00623          size_t count = fread( pszConfigData, 
<a name="l00624"></a>00624             streamHeaderInfo.ulConfigrationDataSize, 1, <a class="code" href="class_ladybug_stream_reader.html#38179f7ce475e6627ae0f14dad704c1f">m_pfile</a> );
<a name="l00625"></a>00625          <span class="keywordflow">if</span>( count != 1 )
<a name="l00626"></a>00626          {
<a name="l00627"></a>00627             <span class="comment">//</span>
<a name="l00628"></a>00628             <span class="comment">// Try to read next one</span>
<a name="l00629"></a>00629             <span class="comment">//</span>
<a name="l00630"></a>00630             error = LADYBUG_FAILED;
<a name="l00631"></a>00631             <span class="keywordflow">continue</span>;
<a name="l00632"></a>00632          }
<a name="l00633"></a>00633          <span class="keywordflow">else</span>
<a name="l00634"></a>00634             error = LADYBUG_OK;
<a name="l00635"></a>00635             <span class="keywordflow">break</span>;
<a name="l00636"></a>00636       }
<a name="l00637"></a>00637    }
<a name="l00638"></a>00638 
<a name="l00639"></a>00639    <span class="comment">//</span>
<a name="l00640"></a>00640    <span class="comment">// Restore the default openning position to the beginning of the stream</span>
<a name="l00641"></a>00641    <span class="comment">//</span>
<a name="l00642"></a>00642    <a class="code" href="class_ladybug_stream_reader.html#599bceb1aa1ae0d9cbae519772548c43">close</a>();
<a name="l00643"></a>00643    <a class="code" href="class_ladybug_stream_reader.html#1d7a58acf5f2b8bb744458b65104c524">open</a>( <a class="code" href="class_ladybug_stream_reader.html#0c26c84ac59fd079076ce9f24892a037">m_pszSrcPath</a> );
<a name="l00644"></a>00644    <a class="code" href="class_ladybug_stream_reader.html#fe0a835da8e344d5319bb7bc3724b637">m_iSplitFile</a> =0;
<a name="l00645"></a>00645 
<a name="l00646"></a>00646    <span class="keywordflow">return</span> error;
<a name="l00647"></a>00647 }
<a name="l00648"></a>00648 
<a name="l00649"></a>00649 <span class="preprocessor">#endif</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Tue Apr 24 22:32:50 2007 for New Vision by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.1-p1 </small></address>
</body>
</html>

<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>NewVision: BodyModel.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.1 -->
<h1>BodyModel.h</h1><div class="fragment"><pre>00001 <span class="preprocessor">#if !defined( BODYMODEL_H )</span>
00002 <span class="preprocessor"></span><span class="preprocessor">#define BODYMODEL_H</span>
00003 <span class="preprocessor"></span>
00004 <span class="preprocessor">#pragma once</span>
00005 <span class="preprocessor"></span><span class="preprocessor">#include &lt;afx.h&gt;</span>
00006 <span class="preprocessor">#include "cv.h"</span>
00007 <span class="preprocessor">#include "Model.h"</span>
00008 <span class="preprocessor">#include "SmartPtrArray.h"</span>
00009 <span class="preprocessor">#include "LABHistogram2D.h"</span>
00010 
00011 <span class="keyword">class </span>Body;
00012 <span class="keyword">class </span>BodyPath;
00013 <span class="keyword">class </span>SwarmHistory;
00014 <span class="keyword">class </span>Object3D;
00015 
00016 <span class="preprocessor">#define N_SATURATION_TIME 15 // time (in frames) to start trusting sizes and locations</span>
00017 <span class="preprocessor"></span><span class="preprocessor">#define MIN_HIST_CHANGE 0.07 // minimum percetage change in color histogram to be deemed as dormant</span>
00018 <span class="preprocessor"></span><span class="preprocessor">#define MEAN_HIST_CHANGE 0.2 // average percetage change in color histogram </span>
00019 <span class="preprocessor"></span><span class="preprocessor">#define MIN_POS_CHANGE 10  // minimum change in position (cm) to be deemed as dormant</span>
00020 <span class="preprocessor"></span><span class="preprocessor">#define MAX_DELETED_AGE 20 // maximum age of deleted bodies to recover</span>
00021 <span class="preprocessor"></span><span class="preprocessor">#define MAX_DELETED_DIST 200 // maximum distance of deleted bodies from new candidates to recover</span>
00022 <span class="preprocessor"></span>
00023 <span class="keyword">enum</span> Z_MODE {BODIES_ONLY=0, OBSTACLES_ONLY=1, BODIES_MINUS_OBSTACLES=2, ALL=3};
00024 <span class="keyword">enum</span> F_MODE {F_BODIES_ONLY=0, F_OBSTACLES_ONLY=1, F_ALL=3};
00025 <span class="keyword">enum</span> MUTATION {M_DIFFUSE=1, M_MOVE=2, M_EXCHANGE=3, M_DELETE=4, M_NEW=5};
00026 
00027 <span class="keyword">class </span>BodyModel : <span class="keyword">public</span> Model
00028 {
00029     DECLARE_SERIAL(BodyModel)
00030 <span class="keyword">public</span>:
00031     <span class="comment">// --------------- Persistant variables -----------------------</span>
00032     <span class="keywordtype">bool</span> m_initialized;
00033     <span class="keywordtype">int</span> m_heightM;
00034     <span class="keywordtype">int</span> m_heightS;
00035     <span class="keywordtype">int</span> m_minHeight;
00036     <span class="keywordtype">int</span> m_maxHeight;
00037     <span class="keywordtype">int</span> m_widthM;
00038     <span class="keywordtype">int</span> m_widthS;
00039     <span class="keywordtype">int</span> m_minWidth;
00040     <span class="keywordtype">int</span> m_maxWidth;
00041     <span class="keywordtype">int</span> m_iterations;
00042     <span class="keywordtype">int</span> m_iterationsPerBody;
00043     <span class="keywordtype">int</span> m_invisibleFor;<span class="comment">// number of frames not to have any underlying blobs to be considered for deletion</span>
00044     <span class="keywordtype">int</span> m_dormantFor;  <span class="comment">// number of frames not to have any motion or color change to be considered for deletion</span>
00045     <span class="keywordtype">int</span> m_outsiderFor; <span class="comment">// number of frames not to have any underlying blobs to be considered for deletion</span>
00046     <span class="keywordtype">double</span> m_distanceConfidence; <span class="comment">// accuracy (cm) while performing distance related operations</span>
00047 
00048     <span class="comment">// tracking parameters</span>
00049     <span class="keywordtype">double</span> m_randomness;
00050     <span class="keywordtype">double</span> m_maxDoorDistance; <span class="comment">// maximum distance from the door to perform add/delete mutations</span>
00051     <span class="keywordtype">int</span> last_id;
00052     <span class="keywordtype">int</span> last_group_id;
00053     
00054     SmartPtrArray&lt;Body&gt; body;
00055     SmartPtrArray&lt;Body&gt; body_deleted;
00056 
00057     <span class="comment">// prior probability penlties</span>
00058     <span class="keywordtype">double</span> p_number; <span class="comment">// probability of no objects present in the scene</span>
00059     <span class="keywordtype">double</span> p_distance; <span class="comment">// penalty for the distance from the Kalman predicted position </span>
00060     <span class="keywordtype">double</span> p_height;
00061     <span class="keywordtype">double</span> p_width;
00062     <span class="keywordtype">double</span> p_new; <span class="comment">// probability of creating a new body (should descrese further from doors)</span>
00063     <span class="keywordtype">double</span> p_delete; <span class="comment">// probability of deleting an old body (should descrese further from doors)</span>
00064     <span class="keywordtype">double</span> p_color, p_background, p_foreground; <span class="comment">// object attraction and BG exclustion relative weights</span>
00065     <span class="keywordtype">double</span> p_abnormalW; <span class="comment">// penalty for deviation from the mean width</span>
00066     <span class="keywordtype">double</span> p_abnormalH; <span class="comment">// penalty for deviation from the mean height</span>
00067 
00068     <span class="comment">// jump-diffusion probabilities</span>
00069     <span class="keywordtype">double</span> p_add;
00070     <span class="keywordtype">double</span> p_remove;
00071     <span class="keywordtype">double</span> p_exchange;
00072     <span class="keywordtype">double</span> p_update;
00073     <span class="keywordtype">double</span> p_diffuse;
00074     
00075     <span class="comment">// Kalman parameters</span>
00076     <span class="keywordtype">double</span> m_posModelNoise;
00077     <span class="keywordtype">double</span> m_posMeasurementNoise;
00078     <span class="keywordtype">double</span> m_orientModelNoise;
00079     <span class="keywordtype">double</span> m_orientMeasurementNoise;
00080 
00081     BodyModel(<span class="keywordtype">void</span>);
00082     <span class="keywordtype">bool</span> Initialize();
00083     <span class="keywordtype">void</span> DeInitialize();
00084     <span class="keywordtype">bool</span> IsInitialized() { <span class="keywordflow">return</span> m_initialized; };
00085     <span class="keyword">virtual</span> ~BodyModel(<span class="keywordtype">void</span>);
00086     
00087     <span class="keywordtype">void</span> UpdateHistograms(SmartPtrArray&lt;Body&gt;&amp; arr);
00088     <span class="keywordtype">void</span> UpdateZBuffer(IplImage* z, SmartPtrArray&lt;Body&gt;&amp; body, SmartPtrArray&lt;Object3D&gt;&amp; obstacle, Z_MODE mode=ALL);
00089     <span class="keywordtype">void</span> UpdateFBuffer(IplImage* f, SmartPtrArray&lt;Body&gt;&amp; body, SmartPtrArray&lt;Object3D&gt;&amp; obstacle, F_MODE mode=F_ALL);
00090     <span class="keywordtype">void</span> Predict();
00091     <span class="keywordtype">void</span> Iterate();
00092     <span class="keywordtype">void</span> RasterizeFrame(IplImage* frame, CvScalar color=cvScalar(1));
00093     <span class="keywordtype">void</span> RasterizeFloor(IplImage* frame, CvScalar color=cvScalar(1));
00094     <span class="keywordtype">void</span> RasterizeNonDormant(IplImage* frame, CvScalar color=cvScalar(1));
00095     
00096     <span class="keywordtype">void</span>            Draw(IplImage* frame, CvScalar color);
00097     <span class="keywordtype">void</span>            DrawHeight(IplImage* frame, CvScalar color);
00098     <span class="keywordtype">void</span>            DrawGroups(IplImage* frame, CvScalar color);
00099     <span class="keywordtype">void</span>            DrawWeightMasks(IplImage* frame);
00100     <span class="keywordtype">void</span>            DrawZBuffer(IplImage* frame);
00101     <span class="keywordtype">void</span>            DrawHistograms(IplImage* frame);
00102 
00103     <span class="keywordtype">double</span>          Prior(SmartPtrArray&lt;Body&gt;&amp; arrCurr, SmartPtrArray&lt;Body&gt;&amp; arrPrev);
00104     <span class="keywordtype">double</span>          Likelyhood(SmartPtrArray&lt;Body&gt;&amp; arr);
00105 
00106     <span class="keywordtype">int</span> FindBodyPos(SmartPtrArray&lt;Body&gt;&amp; arr, Body* b);
00107     Body* FindBodyMatch(SmartPtrArray&lt;Body&gt;&amp; arr, Body* b);
00108     Body* FindBodyMatch(SmartPtrArray&lt;Body&gt;&amp; arr, <span class="keywordtype">int</span> id);
00109     Body* FindBodyMatch(SmartPtrArray&lt;Body&gt;&amp; arr, CvPoint3D32f bot, <span class="keywordtype">int</span> R=5);
00110     Body* FindBodyMatch(SmartPtrArray&lt;Body&gt;&amp; arr, CvPoint2D32f bot, <span class="keywordtype">int</span> R=5);
00111     Body* FindBodyMatchByAgeAndDistance(SmartPtrArray&lt;Body&gt;&amp; arr, Body* b, <span class="keywordtype">int</span> d_age=10, <span class="keywordtype">double</span> R=5);
00112     Body* FindBodyMatchTop(SmartPtrArray&lt;Body&gt;&amp; arr, CvPoint2D32f top, <span class="keywordtype">int</span> R=5);
00113     <span class="keywordtype">void</span> UpdateRecentlyDeleted(SmartPtrArray&lt;Body&gt;&amp; arr_after, SmartPtrArray&lt;Body&gt;&amp; arr_before, SmartPtrArray&lt;Body&gt;&amp; arr_deleted, <span class="keywordtype">int</span> frame);
00114     <span class="keywordtype">void</span> ReplaceNewWithRecentlyDeleted(SmartPtrArray&lt;Body&gt;&amp; arr_after, SmartPtrArray&lt;Body&gt;&amp; arr_before, SmartPtrArray&lt;Body&gt;&amp; arr_deleted, <span class="keywordtype">int</span> delta_age, <span class="keywordtype">double</span> delta_distance);
00115     <span class="keywordtype">void</span> ReorderIDs(<span class="keywordtype">int</span> last_id_before, SmartPtrArray&lt;Body&gt;&amp; arr);
00116     <span class="keywordtype">int</span> FindBodyIDTop(SmartPtrArray&lt;Body&gt;&amp; arr, CvPoint2D32f top, <span class="keywordtype">int</span> R=5);
00117     <span class="keywordtype">int</span> FindBodyPos(SmartPtrArray&lt;Body&gt;&amp; arr, <span class="keywordtype">int</span> id);
00118 
00119     <span class="comment">// Body model mutations</span>
00120     <span class="keywordtype">int</span> GetRandomMutationNumber();
00121     <span class="keywordtype">bool</span> MutateNew(SmartPtrArray&lt;Body&gt;&amp; proposed);
00122     <span class="keywordtype">bool</span> MutateDiffuse(SmartPtrArray&lt;Body&gt;&amp; proposed);
00123     <span class="keywordtype">bool</span> MutateMove(SmartPtrArray&lt;Body&gt;&amp; proposed);
00124     <span class="keywordtype">bool</span> MutateExchange(SmartPtrArray&lt;Body&gt;&amp; proposed);
00125     <span class="keywordtype">bool</span> MutateDelete(SmartPtrArray&lt;Body&gt;&amp; proposed);
00126 
00127     <span class="keywordtype">void</span> RemoveEmpty(SmartPtrArray&lt;Body&gt;&amp; accepted);
00128     <span class="keywordtype">void</span> RemoveOutsiders(SmartPtrArray&lt;Body&gt;&amp; accepted);
00129     <span class="keywordtype">void</span> NewForEachBlob(SmartPtrArray&lt;Body&gt;&amp; accepted);
00130 };
00131 
00132 <span class="preprocessor">#endif // !defined( BODYMODEL_H )</span>
</pre></div><hr><address style="align: right;"><small>
Generated on Mon May 15 16:43:42 2006 for NewVision by <a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 width=110 height=53>
</a> 1.3.1 using KingsTools</small></address>
</body>
</html>
